"use strict";(self.webpackChunkgrafana_metricsdrilldown_app=self.webpackChunkgrafana_metricsdrilldown_app||[]).push([[384,601],{28:(e,t,r)=>{r.d(t,{Y:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="filters-changed",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},384:(e,t,r)=>{function n(e){return null!==e&&"adhoc"===(null==e?void 0:e.state.type)}function a(e){return null!==e&&"custom"===(null==e?void 0:e.state.type)}function i(e){return null!==e&&"query"===(null==e?void 0:e.state.type)}r.d(t,{BE:()=>n,UG:()=>a,bA:()=>i})},697:(e,t,r)=>{r.d(t,{x:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="metrics-variable-activated",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},1053:(e,t,r)=>{r.d(t,{_:()=>s});var n=r(6089),a=r(2007),i=r(5959),o=r.n(i);function s({title:e,description:t}){const r=(0,a.useStyles2)(l);return o().createElement("h6",{className:r.title},o().createElement("span",null,e),o().createElement(a.Tooltip,{content:t,placement:"top"},o().createElement(a.Icon,{name:"info-circle",size:"sm",className:r.infoIcon})))}function l(e){return{title:(0,n.css)({fontSize:"15px",fontWeight:e.typography.fontWeightLight,borderBottom:`1px solid ${e.colors.border.weak}`,paddingBottom:e.spacing(.5)}),infoIcon:(0,n.css)({marginLeft:e.spacing(1),cursor:"pointer",color:e.colors.text.secondary,position:"relative",top:"-4px"})}}},1199:(e,t,r)=>{r.d(t,{B:()=>a});var n=r(3241);const a=(e,t)=>e.length===t.length&&(0,n.isEqual)(e,t)},1252:(e,t,r)=>{r.d(t,{fD:()=>T,NJ:()=>A,VN:()=>L,yH:()=>$,Rm:()=>M});var n=r(878),a=r(5959),i=r.n(a),o=r(4964),s=r(8361),l=r(8531),c=r(2445),u=r(9851);function d(e){const t=u.K3.parse(e),r=new Set,n=t.cursor();do{if(n.type.is("VectorSelector")&&n.firstChild()){do{if(n.type.is("Identifier")){const t=e.slice(n.from,n.to);t&&r.add(t)}}while(n.nextSibling());n.parent()}}while(n.next());return Array.from(r)}function p(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}const h={showSuccessAlert:!1,showErrorAlert:!1};function m(){return(e=function*(){try{return function(e){const t={},r=e.filter(e=>(null==e?void 0:e.data.length)>0);for(const e of r){const r=e.data.filter(e=>{var t;return"string"==typeof(null===(t=e.model)||void 0===t?void 0:t.expr)&&"__expr__"!==e.datasourceUid});for(const n of r)try{const e=d(n.model.expr);for(const r of e)t[r]=(t[r]||0)+1}catch(t){c.v.warn(t,{message:`Failed to parse PromQL expression in alert rule ${e.title}`})}}return t}(yield(0,l.getBackendSrv)().get("/api/v1/provisioning/alert-rules",void 0,"grafana-metricsdrilldown-app-alert-rule-metric-usage",h))}catch(e){const t="string"==typeof e?new Error(e):e;return c.v.error(t,{message:"Failed to fetch alerting rules"}),{}}},function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){p(i,n,a,o,s,"next",e)}function s(e){p(i,n,a,o,s,"throw",e)}o(void 0)})})();var e}var f=r(7348),g=r(7476);function b(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function y(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){b(i,n,a,o,s,"next",e)}function s(e){b(i,n,a,o,s,"throw",e)}o(void 0)})}}const v={showSuccessAlert:!1,showErrorAlert:!1},w=new Map,S=(0,f.g)((e,t)=>y(function*(){let r=w.get(e);return r||(r=(0,l.getBackendSrv)().get(`/api/dashboards/uid/${e}`,void 0,`grafana-metricsdrilldown-app-dashboard-metric-usage-${e}`,v).then(({dashboard:e})=>e).catch(r=>(t<=5&&c.v.error(r,{dashboardUid:e}),t++,Promise.resolve(null))).finally(()=>{w.delete(e)}),w.set(e,r)),r})(),{concurrency:50});function O(){return y(function*(){try{const e=yield(0,l.getBackendSrv)().get("/api/search",{type:"dash-db",limit:500},"grafana-metricsdrilldown-app-dashboard-search",v);let t=0;return yield Promise.all(e.map(({uid:e})=>S(e,t))).then(k)}catch(e){const t="string"==typeof e?new Error(e):e;return c.v.error(t,{message:"Failed to fetch dashboard metrics"}),{}}})()}function k(e){const t={},r=e.filter(e=>{var t;return e&&(null==e||null===(t=e.panels)||void 0===t?void 0:t.length)});for(const e of r){const r=e.panels.filter(e=>{var t;return(0,g.aQ)(e.datasource)&&"targets"in e&&(null===(t=e.targets)||void 0===t?void 0:t.length)});for(const e of r)for(const r of e.targets){const e=d("string"==typeof r.expr?r.expr:"");for(const r of e)t[r]=(t[r]||0)+1}}return t}class E{getUsageMetrics(e){return this._usageState[e].metrics&&Object.keys(this._usageState[e].metrics).length>0?Promise.resolve(this._usageState[e].metrics):(this._usageState[e].metricsPromise||(this._usageState[e].metricsPromise=this._usageState[e].fetcher().then(t=>(this._usageState[e].metrics=t,this._usageState[e].metricsPromise=void 0,t))),this._usageState[e].metricsPromise)}getUsageForMetric(e,t){return this.getUsageMetrics(t).then(t=>{var r;return null!==(r=t[e])&&void 0!==r?r:0})}constructor(){var e,t,r;r={"dashboard-usage":{metrics:{},metricsPromise:void 0,fetcher:O},"alerting-usage":{metrics:{},metricsPromise:void 0,fetcher:m}},(t="_usageState")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}}function x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function j(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){x(e,t,r[t])})}return e}function P(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const C="metrics-drilldown-recent-metrics/v1",_=6,N=30;function L(e){try{const t=B(),r=Date.now(),n=t.filter(t=>t.name!==e);n.unshift({name:e,timestamp:r});const a=n.slice(0,_);localStorage.setItem(C,JSON.stringify(a))}catch(t){const r=t instanceof Error?t:new Error(String(t));c.v.error(r,P(j({},r.cause||{}),{metricName:e}))}}function B(){try{const e=localStorage.getItem(C);if(!e)return[];const t=JSON.parse(e),r=Date.now()-24*N*60*60*1e3,n=t.filter(e=>e.timestamp>r);return n.length!==t.length&&localStorage.setItem(C,JSON.stringify(n)),n}catch(e){return c.v.error(e,{message:"Failed to get recent metrics:"}),[]}}const D=[{label:"Default",value:"default"},{label:"Dashboard Usage",value:"dashboard-usage"},{label:"Alerting Usage",value:"alerting-usage"}],A="metrics-reducer-sort-by";class T extends n.Bs{activationHandler(){const e=n.jh.getVariables(this).getByName(A);this.supportedSortByOptions.has(e.getValue())||e.changeValueTo("default"),this._subs.add(e.subscribeToState((e,t)=>{e.value!==t.value&&this.publishEvent(new s.S({sortBy:e.value}),!0)}))}getUsageForMetric(e,t){return this.usageFetcher.getUsageForMetric(e,t)}getUsageMetrics(e){return this.usageFetcher.getUsageMetrics(e)}constructor(e){super(P(j({},e),{key:"metrics-sorter",$variables:new n.Pj({variables:[new n.yP({name:A,label:"Sort by",value:"default",query:D.map(e=>`${e.label} : ${e.value}`).join(","),description:"Sort metrics by default (alphabetically, with recently-selected metrics first), by prevalence in dashboard panel queries, or by prevalence in alerting rules"})]}),inputControls:new n.K8({layout:"horizontal"})})),x(this,"initialized",!1),x(this,"supportedSortByOptions",new Set(["default","dashboard-usage","alerting-usage"])),x(this,"usageFetcher",new E),this.addActivationHandler(()=>this.activationHandler())}}function $(e,t){return[...e].sort((e,r)=>{const n=t[e]||0,a=t[r]||0;return a!==n?a-n:(0,o._)(e,r)})}function M(e){const t=B().map(e=>e.name),r=new Set(t),[n,a]=e.reduce(([e,t],n)=>(r.has(n)?e.push(n):t.push(n),[e,t]),[[],[]]),i=function(e){return[...e].sort((e,t)=>(0,o._)(e,t))}(a);return[...t.filter(e=>n.includes(e)),...i]}x(T,"Component",({model:e})=>{const{inputControls:t}=e.useState();return i().createElement("div",{"data-testid":"sort-by-select"},i().createElement(t.Component,{model:t}))})},1464:(e,t,r)=>{r.d(t,{I:()=>o});var n=r(697),a=r(6920),i=r(7397);function o(e){const t=e.state.key;if(!t)throw new TypeError(`Variable "${e.state.name}" has no key. Please provide a key in order to publish its lifecycle events.`);return e.addActivationHandler(()=>(e.publishEvent(new n.x({key:t}),!0),e.subscribeToState((r,n)=>{!r.loading&&n.loading&&e.publishEvent(new i.x({key:t,options:r.options}),!0)}),()=>{e.publishEvent(new a.e({key:t}),!0)})),e}},1816:(e,t,r)=>{r.d(t,{W:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="quick-search-changed",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},1955:(e,t,r)=>{r.d(t,{b:()=>U});var n,a,i,o=r(6089),s=r(7781),l=r(1932),c=r(8531),u=r(878),d=r(2007),p=r(5959),h=r.n(p),m=r(2127),f=r(2445),g=r(7476);class b extends u.mI{onActivate(){this.setState({skipUrlSync:!1}),this.subscribeToState((e,t)=>{e.value&&e.value!==t.value&&localStorage.setItem(b.LOCAL_STORAGE_KEY,e.value)})}static getCurrentDataSource(){const e=Object.values(c.config.datasources).filter(e=>(0,g.aQ)(e)),t=new URL(window.location.href).searchParams.get(`var-${m.EY}`),r=localStorage.getItem(b.LOCAL_STORAGE_KEY),n=e.find(e=>e.uid===t)||e.find(e=>e.uid===r)||e.find(e=>e.isDefault)||e[0];return n?n.uid:(f.v.warn("Cannot find any Prometheus data source!"),"no-data-source-configured")}constructor({initialDS:e}){super({key:m.EY,name:m.EY,pluginId:"prometheus",label:"Data source",description:"Only prometheus data sources are supported",skipUrlSync:!e,value:e||b.getCurrentDataSource()}),this.addActivationHandler(this.onActivate.bind(this))}}i="metricsDrilldownDataSource",(a="LOCAL_STORAGE_KEY")in(n=b)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i;const y=(0,p.memo)(function({size:e}){const t=(0,d.useStyles2)(v);return h().createElement("img",{className:(0,o.cx)(t.logo,e),src:"public/plugins/grafana-metricsdrilldown-app/img/logo.svg"})}),v=()=>({logo:o.css`
    &.small {
      width: 24px;
      height: 24px;
      margin-right: 4px;
      position: relative;
      top: -2px;
    }

    &.large {
      width: 40px;
      height: 40px;
    }
  `});const w=r(5176).t,S=`https://github.com/grafana/metrics-drilldown/commit/${w}`,{buildInfo:O}=c.config;function k(){const e=(0,d.useStyles2)(j),{meta:{info:{version:t,updated:r}}}=(0,s.usePluginContext)()||{meta:{info:{version:"?.?.?",updated:"?"}}};return h().createElement("div",{className:e.menuHeader},h().createElement("h5",null,h().createElement(y,{size:"small"}),"Grafana Metrics Drilldown v",t),h().createElement("div",{className:e.subTitle},"Last update: ",r))}function E(){const e="dev"===w,t=e?w:w.slice(0,8);return h().createElement(d.Menu,{header:h().createElement(k,null)},h().createElement(d.Menu.Item,{label:`Commit SHA: ${t}`,icon:"github",onClick:()=>window.open(S),disabled:e}),h().createElement(d.Menu.Item,{label:"Changelog",icon:"list-ul",onClick:()=>window.open("https://github.com/grafana/metrics-drilldown/blob/main/CHANGELOG.md","_blank","noopener,noreferrer")}),h().createElement(d.Menu.Item,{label:"Contribute",icon:"external-link-alt",onClick:()=>window.open("https://github.com/grafana/metrics-drilldown/blob/main/docs/contributing.md","_blank","noopener,noreferrer")}),h().createElement(d.Menu.Item,{label:"Documentation",icon:"document-info",onClick:()=>window.open("https://grafana.com/docs/grafana/latest/explore/simplified-exploration/metrics","_blank","noopener,noreferrer")}),h().createElement(d.Menu.Item,{label:"Report an issue",icon:"bug",onClick:()=>window.open("https://github.com/grafana/metrics-drilldown/issues/new?template=bug_report.md","_blank","noopener,noreferrer")}),h().createElement(d.Menu.Divider,null),h().createElement(d.Menu.Item,{label:`Grafana ${O.edition} v${O.version} (${O.env})`,icon:"grafana",onClick:()=>window.open(`https://github.com/grafana/grafana/commit/${O.commit}`,"_blank","noopener,noreferrer")}))}function x(){return h().createElement(d.Dropdown,{overlay:()=>h().createElement(E,null),placement:"bottom-end"},h().createElement(d.Button,{icon:"info-circle",variant:"secondary",tooltip:"Plugin info",tooltipPlacement:"top",title:"Plugin info","data-testid":"plugin-info-button"}))}const j=e=>({button:o.css`
    position: relative;
    display: flex;
    align-items: center;
    width: 32px;
    height: 32px;
    line-height: 30px;
    border: 1px solid ${e.colors.border.weak};
    border-radius: 2px;
    border-left: 0;
    color: ${e.colors.text.primary};
    background: ${e.colors.background.secondary};

    &:hover {
      border-color: ${e.colors.border.medium};
      background-color: ${e.colors.background.canvas};
    }
  `,menuHeader:o.css`
    padding: ${e.spacing(.5,1)};
    white-space: nowrap;
  `,subTitle:o.css`
    color: ${e.colors.text.secondary};
    font-size: ${e.typography.bodySmall.fontSize};
  `});var P=r(3616),C=r(8499),_=r(3347),N=r(8643),L=r(4796);function B(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class D extends u.Bs{constructor(e){var t,r;super({stickyMainGraph:null===(t=e.stickyMainGraph)||void 0===t||t,isOpen:null!==(r=e.isOpen)&&void 0!==r&&r}),B(this,"onToggleStickyMainGraph",()=>{const e=!this.state.stickyMainGraph;(0,_.z)("settings_changed",{stickyMainGraph:e}),this.setState({stickyMainGraph:e})}),B(this,"onToggleOpen",e=>{this.setState({isOpen:e})})}}function A(e){return{popover:(0,o.css)({display:"flex",padding:e.spacing(2),flexDirection:"column",background:e.colors.background.primary,boxShadow:e.shadows.z3,borderRadius:e.shape.radius.default,border:`1px solid ${e.colors.border.weak}`,zIndex:1,marginRight:e.spacing(2)}),heading:(0,o.css)({fontWeight:e.typography.fontWeightMedium,paddingBottom:e.spacing(2)}),options:(0,o.css)({display:"grid",gridTemplateColumns:"1fr 50px",rowGap:e.spacing(1),columnGap:e.spacing(2)})}}B(D,"Component",({model:e})=>{const{stickyMainGraph:t,isOpen:r}=e.useState(),n=(0,d.useStyles2)(A),a=(0,L.kj)(e),{topScene:i}=a.useState();if(!(i instanceof N.R))return null;return h().createElement(d.Dropdown,{overlay:()=>h().createElement("div",{className:n.popover,onClick:e=>e.stopPropagation()},h().createElement("div",{className:n.heading},"Settings"),i instanceof N.R&&h().createElement("div",{className:n.options},h().createElement("div",null,"Always keep selected metric graph in-view"),h().createElement(d.Switch,{value:t,onChange:e.onToggleStickyMainGraph}))),placement:"bottom",onVisibleChange:e.onToggleOpen},h().createElement(d.ToolbarButton,{icon:"cog",variant:"canvas",isOpen:r,"data-testid":"settings-button"}))});var T=r(5749),$=r(2425),M=r(7265),V=r(384);function F(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function I(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){F(i,n,a,o,s,"next",e)}function s(e){F(i,n,a,o,s,"throw",e)}o(void 0)})}}function R(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function H(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){R(e,t,r[t])})}return e}function z(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class U extends u.Bs{_onActivate(){this.setState({trailActivated:!0}),this.state.topScene||this.setState({topScene:q(this.state.metric)}),this.subscribeToEvent(m.OO,this._handleMetricSelectedEvent.bind(this));const e=u.jh.lookupVariable(m.Ao,this);(0,V.BE)(e)&&this._subs.add(null==e?void 0:e.subscribeToState((e,t)=>{this._addingFilterWithoutReportingInteraction||(0,_.h)(e.filters,t.filters)}));const t=()=>{const e=u.jh.lookupVariable(m.Ao,this),t=(0,V.BE)(e)&&e.state.filters.length>0;(this.state.metric||t)&&(0,$._r)().setRecentTrail(this)};return window.addEventListener("unload",t),()=>{this.state.embedded||t(),window.removeEventListener("unload",t)}}addFilterWithoutReportingInteraction(e){const t=u.jh.lookupVariable("filters",this);(0,V.BE)(t)&&(this._addingFilterWithoutReportingInteraction=!0,t.setState({filters:[...t.state.filters,e]}),this._addingFilterWithoutReportingInteraction=!1)}getMetricMetadata(e){return this.datasourceHelper.getMetadataForMetric(e)}isNativeHistogram(e){return this.datasourceHelper.isNativeHistogram(e)}initializeHistograms(){return I(function*(){if(!this.state.histogramsLoaded){try{yield this.datasourceHelper.initializeHistograms()}catch(e){(0,P.HA)(["Error while initializing histograms!"])}this.setState({nativeHistograms:this.listNativeHistograms(),histogramsLoaded:!0})}}).call(this)}listNativeHistograms(){var e;return null!==(e=this.datasourceHelper.listNativeHistograms())&&void 0!==e?e:[]}resetNativeHistograms(){this.setState({histogramsLoaded:!1,nativeHistograms:[]})}getCurrentMetricMetadata(){return this.getMetricMetadata(this.state.metric)}_handleMetricSelectedEvent(e){return I(function*(){var t;const r=null!==(t=e.payload)&&void 0!==t?t:"";let n=!1;this.isNativeHistogram(r)&&(n=!0),this._urlSync.performBrowserHistoryAction(()=>{this.setState(this.getSceneUpdatesForNewMetricValue(r,n))});const a=u.jh.lookupVariable(m.Ao,this);(0,V.BE)(a)&&a.setState({baseFilters:Q(e.payload)})}).call(this)}getSceneUpdatesForNewMetricValue(e,t){const r={};return r.metric=e,r.nativeHistogramMetric=t?"1":"",r.topScene=q(e,t),r}getUrlState(){const{metric:e,metricSearch:t,nativeHistogramMetric:r}=this.state;return{metric:e,metricSearch:t,nativeHistogramMetric:r}}updateFromUrl(e){const t={};if("string"==typeof e.metric){if(this.state.metric!==e.metric){let r=!1;"1"===e.nativeHistogramMetric&&(r=!0),Object.assign(t,this.getSceneUpdatesForNewMetricValue(e.metric,r))}}else null==e.metric&&(t.metric=void 0,t.topScene=new C.m);"string"==typeof e.metricSearch?t.metricSearch=e.metricSearch:null==e.metric&&(t.metricSearch=void 0),this.setState(t)}getQueries(){return u.jh.findAllObjects(this,e=>(0,M.xT)(e)).reduce((e,t)=>(e.push(...t.state.queries.map(e=>z(H({},e),{expr:u.jh.interpolate(t,e.expr)}))),e),[])}constructor(e){var t,r,n,a,i,o,c,d,p,h,f,g,y;super(H({$timeRange:null!==(r=e.$timeRange)&&void 0!==r?r:new u.JZ({}),$variables:null!==(n=e.$variables)&&void 0!==n?n:(f=e.initialDS,g=e.metric,y=e.initialFilters,new u.Pj({variables:[new b({initialDS:f}),new u.H9({key:m.Ao,name:m.Ao,label:"Filters",addFilterButtonText:"Add label",datasource:m.GH,hide:s.VariableHide.dontHide,layout:"combobox",filters:null!=y?y:[],baseFilters:Q(g),applyMode:"manual",allowCustomValue:!0,expressionBuilder:e=>{const t=e.filter(e=>"__name__"!==e.key);return[...Q(g),...t].map(e=>`${(0,l.Nc)(e.key)}${e.operator}"${e.value}"`).join(",")}})]})),controls:null!==(a=e.controls)&&void 0!==a?a:[new u.K8({layout:"vertical"}),new u.N0,new u.KE({}),new u.WM({})],settings:null!==(i=e.settings)&&void 0!==i?i:new D({}),pluginInfo:new u.dM({component:x}),createdAt:null!==(o=e.createdAt)&&void 0!==o?o:(new Date).getTime(),dashboardMetrics:{},alertingMetrics:{},nativeHistograms:null!==(c=e.nativeHistograms)&&void 0!==c?c:[],histogramsLoaded:null!==(d=e.histogramsLoaded)&&void 0!==d&&d,nativeHistogramMetric:null!==(p=e.nativeHistogramMetric)&&void 0!==p?p:"",trailActivated:null!==(h=e.trailActivated)&&void 0!==h&&h},e)),R(t=this,"_urlSync",new u.So(t,{keys:["metric","metricSearch","nativeHistogramMetric"]})),R(t,"_variableDependency",new u.Sh(t,{variableNames:[m.EY],onReferencedVariableValueChanged:e=>I(function*(){const{name:r}=e.state;r===m.EY&&(t.datasourceHelper.reset(),t.resetNativeHistograms())})()})),R(t,"_addingFilterWithoutReportingInteraction",!1),R(t,"datasourceHelper",new T.q(t)),t.addActivationHandler(t._onActivate.bind(t))}}function q(e,t){return e?new N.R({metric:e,nativeHistogram:null!=t&&t}):new C.m}function G(e,t){return{container:(0,o.css)({flexGrow:1,display:"flex",gap:e.spacing(1),flexDirection:"column",background:e.isLight?e.colors.background.primary:e.colors.background.canvas,padding:e.spacing(1,2)}),body:(0,o.css)({flexGrow:1,display:"flex",flexDirection:"column"}),controls:(0,o.css)({display:"flex",gap:e.spacing(1),padding:e.spacing(1,0),alignItems:"flex-end",flexWrap:"wrap",position:"sticky",background:e.isDark?e.colors.background.canvas:e.colors.background.primary,zIndex:e.zIndex.navbarFixed,top:t}),settingsInfo:(0,o.css)({display:"flex",gap:e.spacing(.5)})}}function Q(e){return e?[{key:"__name__",operator:"=",value:e}]:[]}R(U,"Component",({model:e})=>{const{controls:t,topScene:r,settings:n,pluginInfo:a,embedded:i}=e.useState(),o=(0,c.useChromeHeaderHeight)(),s=(0,d.useStyles2)(G,i?0:null!=o?o:0);return e.initializeHistograms(),(0,p.useEffect)(()=>{const t=u.jh.lookupVariable(m.Ao,e),r=e.datasourceHelper;(0,L.FG)(e,t,r)},[e]),h().createElement("div",{className:s.container},t&&h().createElement("div",{className:s.controls,"data-testid":"app-controls"},t.map(e=>h().createElement(e.Component,{key:e.state.key,model:e})),h().createElement("div",{className:s.settingsInfo},h().createElement(n.Component,{model:n}),h().createElement(a.Component,{model:a}))),r&&h().createElement(u.$L,{scene:r,createBrowserHistorySteps:!0,updateUrlOnInit:!0},h().createElement("div",{className:s.body},r&&h().createElement(r.Component,{model:r}))))})},2024:(e,t,r)=>{r.d(t,{d:()=>o});var n=r(2007),a=r(5959),i=r.n(a);function o({label:e,batchSizes:t,onClick:r,tooltip:a}){return i().createElement(n.Button,{variant:"secondary",fill:"outline",onClick:r,tooltip:a,tooltipPlacement:"top"},"Show ",t.increment," more ",1===t.increment?e:`${e}s`," (",t.current,"/",t.total,")")}},2127:(e,t,r)=>{r.d(t,{Ao:()=>l,Az:()=>g,EY:()=>m,GH:()=>w,H0:()=>_,I1:()=>E,Kf:()=>b,OO:()=>C,Pp:()=>k,QX:()=>s,Rp:()=>d,aZ:()=>h,dc:()=>j,gR:()=>f,hc:()=>y,jT:()=>O,sQ:()=>S,td:()=>v,ui:()=>c,up:()=>x,ym:()=>P,yr:()=>p});var n=r(7781),a=r(878),i=r(2245);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const s="/explore/metrics",l="filters",c="${filters}",u="metric",d="${metric}",p="groupby",h="${groupby}",m="ds",f="${ds}",g="logsDs",b="${logsDs}",y="other_metric_filters",v="$__logs__",w={uid:f},S="grafana.trails.recent",O="grafana.trails.bookmarks",k="grafana.trails.breakdown.view",E="grafana.trails.breakdown.sort",x=250,j=500;function P(e){return[new a.x0({name:u,value:e,hide:i.zL.hideVariable})]}class C extends n.BusEventWithPayload{}o(C,"type","metric-selected-event");class _ extends n.BusEventBase{}o(_,"type","refresh-metrics-event")},2425:(e,t,r)=>{r.d(t,{yn:()=>y,_r:()=>w});var n=r(7781),a=r(878),i=r(3241),o=r(8531),s=r(2007),l=r(5959),c=r.n(l),u=r(4137),d=r(2127),p=r(4796);var h=r(1955);function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class f{_loadRecentTrailsFromStorage(){const e=[],t=localStorage.getItem(d.sQ);if(t){const r=JSON.parse(t);for(const t of r){const r=this._deserializeTrail(t);e.push(r.getRef())}}return e}_loadBookmarksFromStorage(){const e=localStorage.getItem(d.jT);return(e?JSON.parse(e):[]).map(e=>{if(null!=(t=e)&&"object"==typeof t&&"history"in t){const t=null!=e.currentStep?e.currentStep:e.history.length-1;return{urlValues:e.history[t].urlValues,createdAt:e.createdAt||Date.now()}}var t;return e})}_deserializeTrail(e){const t=new h.b({}),r="urlValues"in e;return"history"in e?e.history.forEach(e=>{this._loadFromUrl(t,e.urlValues)}):r&&this._loadFromUrl(t,e.urlValues),t.setState(a.Go.cloneSceneObjectState(t.state,{})),t}_serializeTrail(e){return{urlValues:a.Go.getUrlState(e)}}getTrailForBookmarkIndex(e){const t=this._bookmarks[e];return t?this.getTrailForBookmark(t):(0,p.ef)()}getTrailForBookmark(e){const t=y(e);for(const e of this._recent){const r=e.resolve();if(y(r)===t)return r}const r=new h.b({});return this._loadFromUrl(r,e.urlValues),r}_loadFromUrl(e,t){const r=n.urlUtil.renderUrl("",t);a.Go.syncStateFromSearchParams(e,new URLSearchParams(r))}get recent(){return this._recent}get lastModified(){return this._lastModified}load(){this._recent=this._loadRecentTrailsFromStorage(),this._bookmarks=this._loadBookmarksFromStorage(),this._refreshBookmarkIndexMap(),this._lastModified=Date.now()}setRecentTrail(e){if(!e.state.trailActivated)return;this._recent=this._recent.filter(t=>t!==e.getRef());const t=g(e);this._recent=this._recent.filter(e=>{const r=g(e.resolve());return!(0,i.isEqual)(t,r)}),this._recent.unshift(e.getRef()),this._save()}get bookmarks(){return this._bookmarks}addBookmark(e){const t={urlValues:a.Go.getUrlState(e),createdAt:Date.now()};this._bookmarks.unshift(t),this._refreshBookmarkIndexMap(),this._save(),function(){const e=(0,o.getAppEvents)(),t=(0,p.y)(u.bw.Drilldown),r=t?c().createElement("i",null,"the Metrics Reducer sidebar"):c().createElement("i",null,"Drilldown > Metrics");e.publish({type:n.AppEvents.alertSuccess.name,payload:["Bookmark created",c().createElement(s.Stack,{gap:2,direction:"row",key:"bookmark-notification"},c().createElement("div",null,"You can view bookmarks under ",r),!t&&c().createElement(s.LinkButton,{fill:"solid",variant:"secondary",href:d.QX},"View bookmarks"))]})}()}removeBookmark(e){e<this._bookmarks.length&&(this._bookmarks.splice(e,1),this._refreshBookmarkIndexMap(),this._save())}getBookmarkIndex(e){const t=y(e);return this._bookmarkIndexMap.get(t)}_refreshBookmarkIndexMap(){this._bookmarkIndexMap.clear(),this._bookmarks.forEach((e,t)=>{const r=y(e);this._bookmarkIndexMap.set(r,t)})}constructor(){m(this,"_recent",[]),m(this,"_bookmarks",[]),m(this,"_save",void 0),m(this,"_lastModified",void 0),m(this,"_bookmarkIndexMap",new Map),this.load(),this._lastModified=Date.now();const e=()=>{const e=this._recent.slice(0,20).map(e=>this._serializeTrail(e.resolve()));localStorage.setItem(d.sQ,JSON.stringify(e)),localStorage.setItem(d.jT,JSON.stringify(this._bookmarks)),this._lastModified=Date.now()};this._save=(0,i.debounce)(e,1e3),window.addEventListener("beforeunload",()=>{this._save=e})}}function g(e){const t=a.Go.getUrlState(e);return b(t),t}function b(e){var t;(delete e.actionView,delete e.layout,delete e.metricSearch,delete e.refresh,""!==e["var-groupby"]&&void 0!==e["var-groupby"]||(e["var-groupby"]="$__all"),"string"!=typeof e["var-filters"])&&(e["var-filters"]=null===(t=e["var-filters"])||void 0===t?void 0:t.filter(e=>""!==e));return e}function y(e){return e instanceof h.b?JSON.stringify(g(e)):JSON.stringify(b(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){m(e,t,r[t])})}return e}({},e.urlValues)))}let v;function w(){return v||(v=new f),v}},2601:(e,t,r)=>{r.r(t),r.d(t,{calculateOutlierValue:()=>h,sortSeries:()=>c,sortSeriesByName:()=>m,wasmSupported:()=>f});var n=r(6944),a=r(7781),i=r(3241),o=r(2445),s=r(3347),l=r(5570);const c=(0,i.memoize)((e,t,r="asc")=>{if("alphabetical"===t)return m(e,"asc");if("alphabetical-reversed"===t)return m(e,"desc");"outliers"===t&&d(e);const n=r=>{var n;try{if("outliers"===t)return h(e,r)}catch(e){o.v.error(e,{message:"ML sorting panicked, fallback to stdDev"}),t=a.ReducerID.stdDev}const i=a.fieldReducers.get(t);var s;var l;return null!==(l=(null!==(s=null===(n=i.reduce)||void 0===n?void 0:n.call(i,r.fields[1],!0,!0))&&void 0!==s?s:(0,a.doStandardCalcs)(r.fields[1],!0,!0))[t])&&void 0!==l?l:0},i=e.map(e=>({value:n(e),dataFrame:e}));return i.sort((e,t)=>void 0!==e.value&&void 0!==t.value?t.value-e.value:0),"asc"===r&&i.reverse(),i.map(({dataFrame:e})=>e)},(e,t,r="asc")=>{const n=u(e)?e[0].fields[0].values[0]:0,a=u(e)?e[e.length-1].fields[0].values[e[e.length-1].fields[0].values.length-1]:0;return`${e.length>0?(0,l.H)(e[0]):""}_${e.length>0?(0,l.H)(e[e.length-1]):""}_${n}_${a}_${e.length}_${t}_${r}`});function u(e){return e.length>0&&e[0].fields.length>0&&e[0].fields[0].values.length>0}const d=e=>{if(!f())return;const t=(0,a.outerJoinDataFrames)({frames:e});if(!t)return;const r=t.fields.filter(e=>e.type===a.FieldType.number).map(e=>new Float64Array(e.values));try{const e=n.OutlierDetector.dbscan({sensitivity:.4}).preprocess(r);p=e.detect()}catch(e){o.v.error(e,{message:"Error initializing outlier detector"}),p=void 0}};let p;const h=(e,t)=>{if(!f())throw new Error("WASM not supported, fall back to stdDev");if(!p)throw new Error("Initialize outlier detector first");const r=e.indexOf(t);return p.seriesResults[r].isOutlier?-p.seriesResults[r].outlierIntervals.length:0},m=(e,t)=>{const r=[...e];return r.sort((e,t)=>{const r=(0,l.H)(e),n=(0,l.H)(t);return r&&n&&null!==(a=null==r?void 0:r.localeCompare(n))&&void 0!==a?a:0;var a}),"desc"===t&&r.reverse(),r},f=()=>{const e="object"==typeof WebAssembly;return e||(0,s.z)("wasm_not_supported",{}),e}},3347:(e,t,r)=>{r.d(t,{h:()=>d,z:()=>c});var n=r(8531),a=r(4137),i=r(5176);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const l="grafana_explore_metrics_";function c(e,t){(0,n.reportInteraction)(`${l}${e}`,s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){o(e,t,r[t])})}return e}({},t),{meta:{appRelease:n.config.apps[a.s_].version,appVersion:i.t}}))}function u(e,t){c("label_filter_changed",{label:e,action:t,cause:"adhoc_filter"})}function d(e,t){e.length===t.length?function(e,t){for(const r of t)for(const t of e)r.key===t.key&&r.value!==t.value&&u(r.key,"changed")}(e,t):e.length<t.length?function(e,t){for(const r of t)e.some(e=>e.key===r.key)||u(r.key,"removed")}(e,t):function(e,t){for(const r of e)!t.some(e=>e.key===r.key)&&u(r.key,"added")}(e,t)}},3616:(e,t,r)=>{r.d(t,{HA:()=>c,jx:()=>l});var n=r(7781),a=r(8531),i=r(2445);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function l(e,t){const r=t.reduce((e,t,r)=>s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){o(e,t,r[t])})}return e}({},e),{[`info${r+1}`]:t}),{handheldBy:"displayError"});i.v.error(e,r),(0,a.getAppEvents)().publish({type:n.AppEvents.alertError.name,payload:t})}function c(e){i.v.warn(e),(0,a.getAppEvents)().publish({type:n.AppEvents.alertWarning.name,payload:e})}},3831:(e,t,r)=>{r.d(t,{a:()=>c,k:()=>l});var n=r(878),a=r(5959),i=r.n(a),o=r(2445);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class l extends n.Bs{performRepeat(){var e,t;if(this._variableDependency.hasDependencyInLoadingState())return void this.setState({loadingLayout:null===(e=(t=this.state).getLayoutLoading)||void 0===e?void 0:e.call(t),errorLayout:void 0,emptyLayout:void 0,currentBatchSize:0});const r=n.jh.lookupVariable(this.state.variableName,this);if(!(r instanceof n.n8)){const e=new Error("SceneByVariableRepeater: variable is not a MultiValueVariable!");return void o.v.error(e)}var a,i;if(r.state.error)return void this.setState({errorLayout:null===(a=(i=this.state).getLayoutError)||void 0===a?void 0:a.call(i,r.state.error),loadingLayout:void 0,emptyLayout:void 0,currentBatchSize:0});const s=c(r);var l,u;if(!s.length)return void this.setState({emptyLayout:null===(l=(u=this.state).getLayoutEmpty)||void 0===l?void 0:l.call(u),errorLayout:void 0,loadingLayout:void 0,currentBatchSize:0});this.setState({loadingLayout:void 0,errorLayout:void 0,emptyLayout:void 0,currentBatchSize:this.state.initialPageSize});const d=s.slice(0,this.state.initialPageSize).map((e,t)=>this.state.getLayoutChild(e,t,s)).filter(Boolean);this.state.body.setState({children:d})}increaseBatchSize(){const e=c(n.jh.lookupVariable(this.state.variableName,this)),t=this.state.currentBatchSize+this.state.pageSizeIncrement,r=e.slice(this.state.currentBatchSize,t).map((t,r)=>this.state.getLayoutChild(t,this.state.currentBatchSize+r,e)).filter(Boolean);this.state.body.setState({children:[...this.state.body.state.children,...r]}),this.setState({currentBatchSize:t})}useSizes(){const{currentBatchSize:e,pageSizeIncrement:t}=this.useState(),r=n.jh.lookupVariable(this.state.variableName,this).state.options.length,a=r-e;return{increment:a<t?a:t,current:e,total:r}}constructor({variableName:e,body:t,getLayoutChild:r,getLayoutLoading:a,getLayoutError:i,getLayoutEmpty:o,initialPageSize:l,pageSizeIncrement:c}){super({variableName:e,body:t,getLayoutChild:r,getLayoutLoading:a,getLayoutError:i,getLayoutEmpty:o,currentBatchSize:0,initialPageSize:l||6,pageSizeIncrement:c||9,loadingLayout:void 0,errorLayout:void 0,emptyLayout:void 0}),s(this,"_variableDependency",new n.Sh(this,{variableNames:[this.state.variableName],onVariableUpdateCompleted:()=>this.performRepeat()})),this.addActivationHandler(()=>this.performRepeat())}}function c(e){const{value:t,text:r,options:n}=e.state;return e.hasAllValue()?n:Array.isArray(t)&&Array.isArray(r)?t.map((e,t)=>({value:e,label:r[t]})):[{value:t,label:r}]}s(l,"Component",({model:e})=>{const{body:t,loadingLayout:r,errorLayout:n,emptyLayout:a}=e.useState();return r?i().createElement(r.Component,{model:r}):n?i().createElement(n.Component,{model:n}):a?i().createElement(a.Component,{model:a}):i().createElement(t.Component,{model:t})})},4796:(e,t,r)=>{r.d(t,{y:()=>S,UX:()=>P,Vy:()=>E,aO:()=>k,aM:()=>O,kj:()=>b,KE:()=>y,xi:()=>w,FG:()=>j,ef:()=>v});var n=r(7781),a=r(8531),i=r(878),o=(r(1269),r(2445)),s=r(4137),l=r(1955),c=r(8643),u=r(2127);r(2425);function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(){return new h}class h extends i.Bs{getSelectedScopes(){return this.selectedScopes}getSelectedScopesNames(){return this.selectedScopes.map(({scope:e})=>e.metadata.name)}setSelectedScopes(e){this.selectedScopes=e,this.notifySubscribers()}onScopesChange(e){return this.onScopesChangeCallbacks.push(e),()=>{this.onScopesChangeCallbacks=this.onScopesChangeCallbacks.filter(t=>t!==e)}}notifySubscribers(){for(const e of this.onScopesChangeCallbacks)e(this.selectedScopes)}get value(){return[]}constructor(){super({}),d(this,"selectedScopes",[]),d(this,"onScopesChangeCallbacks",[])}}var m=r(384);function f(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function g(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){f(i,n,a,o,s,"next",e)}function s(e){f(i,n,a,o,s,"throw",e)}o(void 0)})}}function b(e){return i.jh.getAncestor(e,l.b)}function y(e){return i.jh.getAncestor(e,l.b).state.settings}function v(e){return new l.b({initialDS:e,$timeRange:new i.JZ({from:"now-1h",to:"now"}),embedded:!1})}function w(e){const t=i.Go.getUrlState(e);return n.urlUtil.renderUrl(s.bw.Drilldown,t)}function S(e){return window.location.pathname.includes(e)}function O(e){if(e instanceof c.R)return e;if(e.parent)return O(e.parent);const t=new Error("Unable to find graph view for model");throw o.v.error(t,{model:e.toString(),message:"Unable to find graph view for model"}),t}function k(e){return e?e===u.td?"Logs":e:"All metrics"}function E(e){const t=a.config.theme2.visualization;return t.getColorByName(t.palette[e%8])}const x=1e4;function j(e,t,r){(0,m.BE)(t)&&t.setState({getTagKeysProvider:()=>g(function*(){var n;const a={filters:t.state.filters,scopes:null===(n=p())||void 0===n?void 0:n.value,queries:e.getQueries()};return a.queries.length>20&&(a.queries=[]),{replace:!0,values:(yield r.getTagKeys(a)).slice(0,x)}})(),getTagValuesProvider:(n,a)=>g(function*(){var n;const i=t.state.filters.filter(e=>e.key!==a.key),o={key:a.key,filters:i,scopes:null===(n=p())||void 0===n?void 0:n.value,queries:e.getQueries()};o.queries.length>20&&(o.queries=[]);return{replace:!0,values:(yield r.getTagValues(o)).slice(0,x)}})()})}function P(e,t,r){const n=i.jh.findObject(e,t);return n instanceof r?n:(null!==n&&o.v.warn(`invalid return type: ${r.toString()}`),null)}},4964:(e,t,r)=>{r.d(t,{_:()=>n});const n=new Intl.Collator("en",{sensitivity:"base"}).compare},5036:(e,t,r)=>{r.d(t,{k:()=>o});var n=r(878),a=r(3241);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class o{setInitOptions(e){this.initOptions=(0,a.cloneDeep)(e)}getFilters(){return this.filters}static getFilteredOptions(e,t){let r=e;return t.categories.length>0&&(r=o.applyCategoryFilters(r,t.categories)),t.prefixes.length>0&&(r=o.applyPrefixFilters(r,t.prefixes)),t.suffixes.length>0&&(r=o.applySuffixFilters(r,t.suffixes)),t.names.length>0&&(r=o.applyNameFilters(r,t.names)),r}applyFilters(e=this.filters,t={forceUpdate:!1,notify:!0}){const r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){i(e,t,r[t])})}return e}({},this.filters,e);if(!t.forceUpdate&&(0,a.isEqual)(this.filters,r))return;if(!(r.categories.length||r.prefixes.length||r.suffixes.length||r.names.length))return this.filters=r,this.variable.setState({options:this.initOptions}),void(t.notify&&this.notifyUpdate());this.filters=r;const n=o.getFilteredOptions(this.initOptions,this.filters);this.variable.setState({options:n}),t.notify&&this.notifyUpdate()}static applyCategoryFilters(e,t){let r=[];for(const n of t){const t=o.buildRegex(n,"i");r=r.concat(e.filter(e=>t.test(e.value)))}return r}static applyPrefixFilters(e,t){const r=t.map(e=>e.includes("|")?`${e.split("|").map(e=>`^${e}([^a-z0-9]|$)`).join("|")}`:`^${e}([^a-z0-9]|$)`).join("|"),n=o.buildRegex(`(${r})`);return e.filter(e=>n.test(e.value))}static applySuffixFilters(e,t){const r=t.map(e=>e.includes("|")?`${e.split("|").map(e=>`(^|[^a-z0-9])${e}$`).join("|")}`:`(^|[^a-z0-9])${e}$`).join("|"),n=o.buildRegex(`(${r})`);return e.filter(e=>n.test(e.value))}static applyNameFilters(e,t){const[r]=t,n=r.split(",").map(e=>e.trim()).filter(Boolean).map(e=>{try{return new RegExp(e)}catch(e){return null}}).filter(Boolean);return e.filter(e=>n.some(t=>t.test(e.value)))}static buildRegex(e,t){try{return new RegExp(e,t)}catch(e){return new RegExp(".*")}}notifyUpdate(){this.variable.publishEvent(new n.oh(this.variable),!0)}constructor(e){i(this,"variable",void 0),i(this,"initOptions",[]),i(this,"filters",{categories:[],prefixes:[],suffixes:[],names:[]}),this.variable=e}}},5317:(e,t,r)=>{r.d(t,{c:()=>g});var n=r(6089),a=r(878),i=r(2007),o=r(5959),s=r.n(o),l=r(2445),c=r(384),u=r(1252),d=r(8499),p=r(9585),h=r(7630);function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function f(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class g extends a.Bs{_onActivate(){let e;try{e=a.jh.getAncestor(this,d.m)}catch(e){return}if(!e.state.enginesMap.get(p.h))return;const t=a.jh.findByKeyAndType(this,"metrics-sorter",u.fD),r=a.jh.getVariables(t).getByName(u.NJ);(0,c.UG)(r)&&(this.updateSortBy(t,r.getValue()),this._subs.add(r.subscribeToState(({value:e})=>{this.updateSortBy(t,e)})))}updateSortBy(e,t){this.setState({sortBy:t});const r=a.jh.getAncestor(this,a.gF),n=null==r?void 0:r.state.autoRows;switch(t){case"dashboard-usage":case"alerting-usage":e.getUsageForMetric(this.state.metric,t).then(e=>{this.setState({[t]:e})}),n!==h.iK&&r.setState({autoRows:h.iK});break;default:n!==h.tw&&r.setState({autoRows:h.tw})}}constructor(e){super(f(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){m(e,t,r[t])})}return e}({},e),{sortBy:"default","alerting-usage":0,"dashboard-usage":0})),this.addActivationHandler(this._onActivate.bind(this))}}function b({usageType:e,usageCount:t,singularUsageType:r,pluralUsageType:n,icon:a}){const o=(0,i.useStyles2)(y);return s().createElement("div",{className:o.usageContainer,"data-testid":"usage-data-panel"},s().createElement(i.Tooltip,{content:`Metric is used in ${t} ${1===t?r:n}`,placement:"top"},s().createElement("span",{className:o.usageItem,"data-testid":e},s().createElement(i.Icon,{name:a})," ",t)))}function y(e){return{usageContainer:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start",gap:"17px",padding:"8px 12px",border:`1px solid ${e.colors.border.weak}`,borderTopWidth:0,backgroundColor:e.colors.background.primary,alignItems:"center"}),usageItem:(0,n.css)({display:"flex",alignItems:"center",gap:"4px",color:e.colors.text.secondary,opacity:"65%"})}}m(g,"Component",({model:e})=>{const{vizPanelInGridItem:t,sortBy:r,"alerting-usage":n,"dashboard-usage":a}=e.useState();if(!t)return void l.v.log("no viz panel");if("default"===r)return s().createElement("div",{"data-testid":"with-usage-data-preview-panel"},s().createElement(t.Component,{model:t}));const i={"dashboard-usage":{usageCount:a,singularUsageType:"dashboard panel query",pluralUsageType:"dashboard panel queries",icon:"apps"},"alerting-usage":{usageCount:n,singularUsageType:"alert rule",pluralUsageType:"alert rules",icon:"bell"}};return s().createElement("div",{"data-testid":"with-usage-data-preview-panel"},s().createElement(t.Component,{model:t}),s().createElement(b,{usageType:r,usageCount:i[r].usageCount,singularUsageType:i[r].singularUsageType,pluralUsageType:i[r].pluralUsageType,icon:i[r].icon}))})},5521:(e,t,r)=>{r.d(t,{O:()=>v,C:()=>y});var n=r(6089),a=r(878),i=r(2007),o=r(5959),s=r.n(o),l=r(1053),c=r(7781),u=r(2127),d=r(2425),p=r(4796),h=r(384);const m=(e,t,r)=>e.length+2+t.length>r?t.substring(0,r-e.length-5)+"...":t;function f(e){const{onSelect:t,onDelete:r,bookmark:n}=e,l=(0,i.useStyles2)(g),f=(0,o.useMemo)(()=>{let t=e.trail||n&&(0,d._r)().getTrailForBookmark(n);if(!t)return null;const r=a.jh.lookupVariable(u.Ao,t);if(!(0,h.BE)(r))return null;const i=(null==n?void 0:n.createdAt)||t.state.createdAt;return{filters:r.state.filters,metric:t.state.metric,createdAt:i}},[e.trail,n]);if(!f)return null;const{filters:b,metric:y,createdAt:v}=f,w=m("",(0,p.aO)(y),27),S=`${e.compactHeight&&b.length>0?l.cardTall:""}`,O=`${l.card} ${e.wide?l.cardWide:""} ${S}`;return s().createElement("article",{"data-testid":`data-trail-card ${w}`},s().createElement(i.Card,{onClick:t,className:O},s().createElement(i.Card.Heading,null,s().createElement("div",{className:l.metricValue},w)),s().createElement(i.Card.Meta,{className:l.meta},b.map(e=>s().createElement("span",{key:e.key},s().createElement("div",{className:l.secondaryFont},e.key,": "),s().createElement("div",{className:l.primaryFont},m(e.key,e.value,44))))),s().createElement("div",{className:l.deleteButton},r&&s().createElement(i.Card.SecondaryActions,null,s().createElement(i.IconButton,{key:"delete",name:"trash-alt",className:l.secondary,tooltip:"Remove bookmark",onClick:r,"data-testid":"deleteButton"})))),s().createElement("div",{className:l.date},s().createElement("div",{className:l.secondaryFont},"Date created: "),s().createElement("div",{className:l.primaryFont},v>0&&(0,c.dateTimeFormat)(v,{format:"YYYY-MM-DD"}))))}function g(e){return{metricValue:(0,n.css)({display:"inline",color:e.colors.text.primary,fontWeight:500,wordBreak:"break-all"}),card:(0,n.css)({position:"relative",width:"318px",padding:`12px ${e.spacing(2)} ${e.spacing(1)} ${e.spacing(2)}`,alignItems:"start",marginBottom:0,borderTop:`1px solid ${e.colors.border.weak}`,borderRight:`1px solid ${e.colors.border.weak}`,borderLeft:`1px solid ${e.colors.border.weak}`,borderBottom:"none",borderRadius:"2px 2px 0 0"}),cardWide:(0,n.css)({width:"100%"}),cardTall:(0,n.css)({height:"110px"}),secondary:(0,n.css)({color:e.colors.text.secondary,fontSize:"12px"}),date:(0,n.css)({border:`1px solid ${e.colors.border.weak}`,borderRadius:"0 0 2px 2px",padding:`${e.spacing(1)} ${e.spacing(2)}`,backgroundColor:e.colors.background.primary}),meta:(0,n.css)({flexWrap:"wrap",overflow:"hidden",textOverflow:"ellipsis",maxHeight:"36px",margin:0,gridArea:"Meta",color:e.colors.text.secondary,whiteSpace:"nowrap"}),primaryFont:(0,n.css)({display:"inline",color:e.colors.text.primary,fontSize:"12px",fontWeight:"500",letterSpacing:"0.018px"}),secondaryFont:(0,n.css)({display:"inline",color:e.colors.text.secondary,fontSize:"12px",fontWeight:"400",lineHeight:"18px",letterSpacing:"0.018px"}),deleteButton:(0,n.css)({position:"absolute",bottom:e.spacing(1),right:e.spacing(1)})}}var b=r(3347);const y={listeners:new Set,emit:function(e){this.listeners.forEach(t=>t(e))},subscribe:function(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}};class v extends a.Bs{onActivate(){}constructor({key:e,title:t,description:r,icon:n,disabled:a}){super({key:e,title:t,description:r,icon:n,disabled:null!=a&&a,active:!1}),this.addActivationHandler(this.onActivate.bind(this))}}var w,S,O;function k(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%"}),bookmarksList:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1.5),overflowY:"auto",paddingRight:e.spacing(1)}),emptyState:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",height:"100px",color:e.colors.text.secondary,fontStyle:"italic"})}}O=({model:e})=>{const t=(0,i.useStyles2)(k),{title:r,description:n}=e.useState(),{bookmarks:a}=(0,d._r)(),[,c]=(0,o.useState)(Date.now()),u=e=>{(0,b.z)("exploration_started",{cause:"bookmark_clicked"});const t=(0,d._r)().getTrailForBookmarkIndex(e);(0,d._r)().setRecentTrail(t),function(e){y.emit(e)}(t)};return s().createElement("div",{className:t.container},s().createElement(l._,{title:r,description:n,"data-testid":"bookmarks-list-sidebar"}),a.length>0?s().createElement("div",{className:t.bookmarksList},a.map((e,t)=>s().createElement(f,{key:(0,d.yn)(e),bookmark:e,onSelect:()=>u(t),onDelete:()=>(e=>{(0,b.z)("bookmark_changed",{action:"deleted"}),(0,d._r)().removeBookmark(e),c(Date.now())})(t),wide:!0,compactHeight:!0}))):s().createElement("div",{className:t.emptyState},"No bookmarks yet"))},(S="Component")in(w=v)?Object.defineProperty(w,S,{value:O,enumerable:!0,configurable:!0,writable:!0}):w[S]=O},5568:(e,t,r)=>{r.d(t,{$:()=>l,s:()=>c});var n=r(7781),a=r(878),i=r(2127);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const l="metrics-wingman";class c extends a.fS{constructor(e){super(s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){o(e,t,r[t])})}return e}({key:l,name:l,label:"Metrics"},e),{datasource:i.GH,query:`label_values({$${i.Ao}}, __name__)`,includeAll:!0,value:"$__all",skipUrlSync:!0,refresh:n.VariableRefresh.onTimeRangeChanged,sort:n.VariableSort.alphabeticalAsc,hide:n.VariableHide.hideVariable}))}}},5570:(e,t,r)=>{function n(e){var t;const r=null===(t=e.fields[1])||void 0===t?void 0:t.labels;if(!r)return null;const n=Object.keys(r);return 0===n.length?null:r[n[0]]}r.d(t,{H:()=>n})},5635:(e,t,r)=>{r.d(t,{MV:()=>y,Qs:()=>w,_O:()=>v});var n=r(6089),a=r(878),i=r(6145),o=r(2007),s=r(5959),l=r.n(s),c=r(6503),u=r(2127),d=r(4796),p=r(384),h=r(8156),m=r(7630),f=r(5317),g=r(3831),b=r(2024);const y="repeat(auto-fit, minmax(400px, 1fr))",v="1fr";class w extends a.Bs{onActivate(){this.subscribeToLayoutChange()}subscribeToLayoutChange(){const e=a.jh.findByKeyAndType(this,"layout-switcher",h.U),t=this.state.body.state.body,r=(e,r)=>{e.layout!==(null==r?void 0:r.layout)&&t.setState({templateColumns:e.layout===h.p.ROWS?v:y})};r(e.state),this._subs.add(e.subscribeToState(r))}constructor({variableName:e}){super({key:"metrics-list",variableName:e,body:new g.k({variableName:e,initialPageSize:120,pageSizeIncrement:9,body:new a.gF({children:[],isLazy:!0,templateColumns:y,autoRows:m.tw,$behaviors:[new a.Gg.K2({key:"metricCrosshairSync",sync:i.yV.Crosshair})]}),getLayoutLoading:()=>new a.dM({reactNode:l().createElement(o.Spinner,{inline:!0})}),getLayoutEmpty:()=>new a.dM({reactNode:l().createElement(c._,{title:"",severity:"info"},"No metrics found for the current filters and time range.")}),getLayoutError:e=>new a.dM({reactNode:l().createElement(c._,{severity:"error",title:"Error while loading metrics!",error:e})}),getLayoutChild:(e,t)=>{const r=(0,d.kj)(this).isNativeHistogram(e.value),n=a.jh.lookupVariable(u.Ao,this),i=(0,p.BE)(n)?n.state.filters.map(e=>`${e.key}${e.operator}${e.value}`):[];return new a.xK({body:new f.c({vizPanelInGridItem:new m.yG({metricName:e.value,color:(0,d.Vy)(t),isNativeHistogram:r,matchers:i}),metric:e.value})})}})}),this.addActivationHandler(this.onActivate.bind(this))}}var S,O,k;function E(e){return{container:(0,n.css)({}),footer:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",marginTop:e.spacing(4),"& button":{height:"40px",borderRadius:"8px"}})}}k=({model:e})=>{const{variableName:t,body:r}=e.useState(),n=(0,o.useStyles2)(E),i=a.jh.lookupVariable(t,e),{loading:s,error:c}=i.useState(),u=r.useSizes(),d=!s&&!c&&u.total>0&&u.current<u.total;return l().createElement("div",{"data-testid":"metrics-list"},l().createElement("div",{className:n.container},l().createElement(r.Component,{model:r})),d&&l().createElement("div",{className:n.footer},l().createElement(b.d,{label:"metric",batchSizes:u,onClick:()=>{r.increaseBatchSize()}})))},(O="Component")in(S=w)?Object.defineProperty(S,O,{value:k,enumerable:!0,configurable:!0,writable:!0}):S[O]=k},5749:(e,t,r)=>{r.d(t,{R:()=>p,q:()=>d});var n=r(8531),a=r(878),i=r(3616),o=r(2127),s=r(7476);function l(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function c(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){l(i,n,a,o,s,"next",e)}function s(e){l(i,n,a,o,s,"throw",e)}o(void 0)})}}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class d{reset(){this._datasource=void 0,this._metricsMetadata=void 0,this._classicHistograms={},this._nativeHistograms=[]}getDatasource(){return c(function*(){if(this._datasource)return this._datasource;const e=yield(0,n.getDataSourceSrv)().get(o.gR,{__sceneObject:{value:this._trail}});return(0,s.aQ)(e)&&(this._datasource=e),this._datasource}).call(this)}_ensureMetricsMetadata(){return c(function*(){this._metricsMetadata||(yield this._getMetricsMetadata())}).call(this)}_getMetricsMetadata(){return c(function*(){const e=yield this.getDatasource();if(!e)return;const t="function"==typeof e.languageProvider.queryMetricsMetadata?e.languageProvider.queryMetricsMetadata:()=>Promise.resolve(e.languageProvider.metricsMetadata),r="function"==typeof e.languageProvider.retrieveMetricsMetadata?()=>Promise.resolve(e.languageProvider.retrieveMetricsMetadata()):()=>e.languageProvider.loadMetricsMetadata().then(()=>t());let n=yield t();n||(n=yield r()),this._metricsMetadata=n}).call(this)}getMetadataForMetric(e){return c(function*(){var t;if(e)return yield this._ensureMetricsMetadata(),null===(t=this._metricsMetadata)||void 0===t?void 0:t[e]}).call(this)}listNativeHistograms(){return this._nativeHistograms}initializeHistograms(){return c(function*(){const e=yield this.getDatasource();if(e&&0===Object.keys(this._classicHistograms).length){const t=e.metricFindQuery("metrics(.*_bucket)"),r=e.metricFindQuery("metrics(.+)"),[n,a]=yield Promise.all([t,r]);n.forEach(e=>{this._classicHistograms[e.text]=1}),yield this._ensureMetricsMetadata(),a.forEach(e=>{this.isNativeHistogram(e.text)&&this.addNativeHistogram(e.text)})}}).call(this)}isNativeHistogram(e){var t;if(!e)return!1;const r=this._metricsMetadata;var n;const a="bucket"!==(null!==(n=e.split("_").pop())&&void 0!==n?n:"");return!("histogram"!==(null==r||null===(t=r[e])||void 0===t?void 0:t.type)||!a)||this._classicHistograms[`${e}_bucket`]>0}addNativeHistogram(e){this._nativeHistograms.includes(e)||this._nativeHistograms.push(e)}getTagKeys(e){return c(function*(){const t=yield this.getDatasource();if(!t)return[];return yield t.getTagKeys(e)}).call(this)}getTagValues(e){return c(function*(){const t=yield this.getDatasource();if(!t)return[];e.key=function(e){if(""===e||!function(e){return/^".*"$/.test(e)}(e))return e;return e.slice(1,-1)}(e.key);return yield t.getTagValues(e)}).call(this)}static dsUsesTimeRangeInLegacyLanguageProviderMethods(e){return"function"==typeof e.languageProvider.fetchLabelValues&&e.languageProvider.fetchLabelValues.length>1}static fetchLabels(e){const{ds:t,timeRange:r,matcher:n}=e;return"function"==typeof t.languageProvider.queryLabelKeys?t.languageProvider.queryLabelKeys(r,n):d.dsUsesTimeRangeInLegacyLanguageProviderMethods(t)?t.languageProvider.fetchLabelsWithMatch(r,n).then(e=>Object.keys(e)):t.languageProvider.fetchLabelsWithMatch(n).then(e=>Object.keys(e))}static fetchLabelValues(e){const{ds:t,labelName:r,timeRange:n,matcher:a}=e;if("function"==typeof t.languageProvider.queryLabelValues)return t.languageProvider.queryLabelValues(n,r,a);const i=a?t.languageProvider.fetchSeriesValuesWithMatch:t.languageProvider.fetchLabelValues;return d.dsUsesTimeRangeInLegacyLanguageProviderMethods(t)?i(n,r,a):i(r,a)}static getPrometheusDataSourceForScene(e){return c(function*(){try{const r=a.jh.findByKey(e,o.EY);var t;const i=null!==(t=null==r?void 0:r.state.value)&&void 0!==t?t:"";return yield(0,n.getDataSourceSrv)().get({uid:i})}catch(e){return void(0,i.jx)(e,["Error while getting the Prometheus data source!"])}})()}constructor(e){u(this,"_trail",void 0),u(this,"_datasource",void 0),u(this,"_metricsMetadata",void 0),u(this,"_classicHistograms",{}),u(this,"_nativeHistograms",[]),this._trail=e}}function p(e){if(!e)return;const{type:t,help:r,unit:n}=e;return[r,t&&`**Type:** *${t}*`,n&&`**Unit:** ${n}`].join("\n\n")}},6096:(e,t,r)=>{r.d(t,{c:()=>m});var n=r(878),a=r(3823),i=r.n(a);const o=new Map;function s(e,t){let r=o.get(e);r||(r=new Map,o.set(e,r));let n=r.get(t);if(!n){const a=e.split("_"),o=a.slice(0,a.length/2).join("_");n={halfLeven:i()(o,t)||0,wholeLeven:i()(e,t)||0},r.set(t,n)}return n}var l=r(2445),c=r(1252),u=r(1199);function d(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function p(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){d(i,n,a,o,s,"next",e)}function s(e){d(i,n,a,o,s,"throw",e)}o(void 0)})}}function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class m{sort(){return p(function*(e=this.sortBy,t={}){const r=this.variable.state.options.map(e=>e.value);if(e===this.sortBy&&(0,u.B)(r,this.lastMetrics))return;let n;switch(e){case"dashboard-usage":case"alerting-usage":n=yield this.sortByUsage(r,e);break;case"related":a=r,i=t.metric,n=a.sort((e,t)=>{const r=s(e,i),n=s(t,i);return r.halfLeven+r.wholeLeven-(n.halfLeven+n.wholeLeven)});break;default:n=(0,c.Rm)(r)}var a,i;this.sortBy=e,this.lastMetrics=n,this.variable.setState({options:n.map(e=>({label:e,value:e}))}),this.notifyUpdate()}).apply(this,arguments)}sortByUsage(e,t){return p(function*(){try{const r=n.jh.findByKeyAndType(this.variable,"metrics-sorter",c.fD);if(!r)return l.v.warn("Metrics sorter not found. Returning unsorted metrics.",{usageType:t}),e;const a=yield r.getUsageMetrics(t);return(0,c.yH)(e,a)}catch(r){const n="string"==typeof r?new Error(r):r;return l.v.error(n,{usageType:t}),e}}).call(this)}notifyUpdate(){this.variable.publishEvent(new n.oh(this.variable),!0)}constructor(e){h(this,"variable",void 0),h(this,"lastMetrics",void 0),h(this,"sortBy",void 0),this.variable=e,this.sortBy=void 0,this.lastMetrics=[]}}},6503:(e,t,r)=>{r.d(t,{_:()=>c});var n=r(2007),a=r(5959),i=r.n(a),o=r(2445);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function c({severity:e,title:t,message:r,error:a,errorContext:c,children:u}){let d;return a&&(d="string"==typeof a?new Error(a):a,o.v.error(d,l(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){s(e,t,r[t])})}return e}({},d.cause||{},c),{bannerTitle:t}))),i().createElement(n.Alert,{title:t,severity:e},d&&i().createElement(i().Fragment,null,d.message||d.toString(),i().createElement("br",null)),r,u)}},6920:(e,t,r)=>{r.d(t,{e:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="metrics-variable-deactivated",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},7238:(e,t,r)=>{r.d(t,{I:()=>m});var n=r(6089),a=r(878),i=r(2007),o=r(3241),s=r(5959),l=r.n(s),c=r(3347),u=r(2127),d=r(1199),p=r(1816);function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class m extends a.Bs{getUrlState(){return{[this.state.urlSearchParamName]:this.state.value}}updateFromUrl(e){const t=e[this.state.urlSearchParamName]||"";t!==this.state.value&&this.setState({value:t})}onActivate(){const{variableNames:e}=this.state,t=a.jh.lookupVariable(e.filtered,this),r=a.jh.lookupVariable(e.nonFiltered,this);this._subs.add(t.subscribeToState((e,t)=>{e.loading||t.loading||(0,d.B)(e.options,t.options)||this.setState({counts:{current:e.options.length,total:r.state.options.length}})})),this._subs.add(r.subscribeToState((e,r)=>{(0,d.B)(e.options,r.options)||this.setState({counts:{current:t.state.options.length,total:e.options.length}})}))}toggleCountsDisplay(e){this.setState({displayCounts:e})}updateValue(e){""===this.state.value&&""!==e&&(0,c.z)("quick_search_used",{}),this.setState({value:e}),this.notifyValueChange(e)}getHumanFriendlyCountsMessage(){const{targetName:e,counts:t,displayCounts:r}=this.state;return r?t.current===t.total?{tagName:`${t.current}`,tooltipContent:1!==t.current?`${t.current} ${e}s in total`:`1 ${e} in total`}:{tagName:`${t.current}/${t.total}`,tooltipContent:1!==t.current?`${t.current} out of ${t.total} ${e}s in total`:`1 out of ${t.total} ${e}s in total`}:{tagName:"",tooltipContent:""}}constructor({urlSearchParamName:e,targetName:t,variableNames:r,displayCounts:n}){super({key:"quick-search",urlSearchParamName:e,targetName:t,variableNames:r,value:"",counts:{current:0,total:0},displayCounts:Boolean(n)}),h(this,"_variableDependency",new a.Sh(this,{variableNames:[u.EY],onReferencedVariableValueChanged:()=>{this.setState({value:""})}})),h(this,"_urlSync",new a.So(this,{keys:[this.state.urlSearchParamName]})),h(this,"notifyValueChange",(0,o.debounce)(e=>{this.publishEvent(new p.W({searchText:e}),!0)},250)),h(this,"onChange",e=>{this.updateValue(e.currentTarget.value)}),h(this,"clear",()=>{this.updateValue("")}),h(this,"onKeyDown",e=>{"Escape"===e.key&&(e.preventDefault(),this.clear())}),this.addActivationHandler(this.onActivate.bind(this))}}h(m,"Component",({model:e})=>{const t=(0,i.useStyles2)(f),{targetName:r,value:n}=e.useState(),{tagName:a,tooltipContent:o}=e.getHumanFriendlyCountsMessage();return l().createElement(i.Input,{value:n,onChange:e.onChange,onKeyDown:e.onKeyDown,placeholder:`Quick search ${r}s`,prefix:l().createElement("i",{className:"fa fa-search"}),suffix:l().createElement(l().Fragment,null,a&&l().createElement(i.Tooltip,{content:o,placement:"top"},l().createElement(i.Tag,{className:t.counts,name:a,colorIndex:9})),l().createElement(i.IconButton,{name:"times",variant:"secondary",tooltip:"Clear search",onClick:e.clear,disabled:!n}))})});const f=e=>({counts:n.css`
    margin-right: ${e.spacing(1)};
    border-radius: 11px;
    padding: 2px ${e.spacing(1)};
    color: ${e.colors.text.primary};
    background-color: ${e.colors.background.secondary};
  `})},7265:(e,t,r)=>{function n(e){var t,r;if(!e)return;const i=null!==(r=e.state.$data)&&void 0!==r?r:null===(t=e.parent)||void 0===t?void 0:t.state.$data;return a(i)?i:null!=(o=i)&&"state"in o&&"transformations"in o.state?n(i):void 0;var o}function a(e){return null!=e&&"state"in e&&"runQueries"in e}r.d(t,{un:()=>n,xT:()=>a})},7397:(e,t,r)=>{r.d(t,{x:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="metrics-variable-loaded",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},7437:(e,t,r)=>{r.d(t,{MM:()=>m,l_:()=>h});const n="none",a="cps",i="bytes",o="seconds",s="percent",l="count",c={[i]:i,[o]:"s",[s]:s,[l]:n},u=Object.keys(c),d={[i]:"Bps",[o]:n,[l]:a,[s]:s};function p(e){if(!e)return null;const t=e.toLowerCase().split("_").slice(-2);for(let e=t.length-1;e>=Math.max(0,t.length-2);e--){const r=t[e];if(u.includes(r))return r}return null}function h(e){if(!e)return n;const t=p(e);return t&&c[t.toLowerCase()]||n}function m(e){if(!e)return a;const t=p(e);return t&&d[t]||a}},7476:(e,t,r)=>{r.d(t,{aQ:()=>c,tS:()=>p});var n=r(8531),a=r(2445);function i(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function o(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){i(o,n,a,s,l,"next",e)}function l(e){i(o,n,a,s,l,"throw",e)}s(void 0)})}}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const l=/^grafana-[0-9a-z]+prometheus-datasource$/;function c(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&("prometheus"===e.type||l.test(e.type))&&"uid"in e&&"string"==typeof e.uid}class u{getHealthyDataSources(e){return o(function*(){const t=this.cache.get(e);if(null==t?void 0:t.length)return t;let r=this.pendingRequests.get(e);r||(r=this.fetchHealthyDataSources(e).finally(()=>{this.pendingRequests.delete(e)}),this.pendingRequests.set(e,r));const n=yield r;return this.cache.set(e,n),n}).call(this)}fetchHealthyDataSources(e){return o(function*(){const t=(0,n.getDataSourceSrv)().getList({logs:!0,type:e,filter:e=>"grafana"!==e.uid}),r=[],i=[];return yield Promise.all(t.map(e=>o(function*(){try{const t=yield(0,n.getBackendSrv)().get(`/api/datasources/uid/${e.uid}/health`,void 0,void 0,{showSuccessAlert:!1,showErrorAlert:!1});"OK"===(null==t?void 0:t.status)?r.push(e):i.push(e)}catch(t){i.push(e)}})())),i.length>0&&a.v.warn(`Found ${i.length} unhealthy ${e} data sources: ${i.map(e=>e.name).join(", ")}`),r})()}constructor(){s(this,"pendingRequests",new Map),s(this,"cache",new Map)}}let d;function p(){return d||(d=new u),d}},7630:(e,t,r)=>{r.d(t,{tw:()=>j,Rg:()=>P,iK:()=>x,yG:()=>_});var n=r(6089),a=r(7781),i=r(878),o=r(2007),s=r(5959),l=r.n(s),c=r(1932),u=r(8162);function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(e,t="avg"){return e?"sum":t}function h({metric:e,filters:t,isRateQuery:r,groupings:n,ignoreUsage:a=!1,nonRateQueryFunction:i="avg"}){const o=!(0,c.Rq)(e);let s=new u.r4({metric:o?"":e,values:{},defaultOperator:u.md.equal,defaultSelectors:[...o?[{label:(0,c.Nc)(e),operator:u.md.equal,value:"__REMOVE__"}]:[],...a?[{label:"__ignore_usage__",operator:u.md.equal,value:""}]:[],...t.filter(e=>"__name__"!==e.key).map(({key:e,value:t,operator:r})=>({label:(0,c.Nc)(e),operator:r,value:t}))]}).toString();return o&&(s=s.replace('="__REMOVE__"',"")),r&&(s=u.GH.rate({expr:s,interval:"$__rate_interval"})),u.GH[p(r,i)](function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){d(e,t,r[t])})}return e}({expr:s},(null==n?void 0:n.length)?{by:n}:{}))}var m=r(7437),f=r(2127),g=r(8534),b=r(5938);var y=r(6145),v=r(1625);const w=new RegExp("([a-zA-Z_]\\w*)(>|<|!~|=~|!=|=)(.+)");function S(e){const[,t,r,n]=e.match(w)||[,"","",""];return{key:t.trim(),value:n.replace(/['" ]/g,""),operator:r.trim()}}function O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function k(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){O(e,t,r[t])})}return e}function E(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const x="260px",j="220px",P="160px",C=new Set(["count","total","sum","bucket"]);class _ extends i.Bs{onActivate(){const{body:e,prometheusFunction:t}=this.state;this._subs.add(e.state.$data.subscribeToState(r=>{var n;if((null===(n=r.data)||void 0===n?void 0:n.state)!==a.LoadingState.Done)return;const{series:i}=r.data;(null==i?void 0:i.length)&&e.setState({fieldConfig:{defaults:e.state.fieldConfig.defaults,overrides:[{matcher:{id:a.FieldMatcherID.byFrameRefID,options:i[0].refId},properties:[{id:"displayName",value:t}]}]}})}))}static buildVizPanel({metricName:e,title:t,highlight:r,color:n,hideLegend:a,prometheusFunction:o,matchers:s,headerActions:l,isNativeHistogram:c=!1}){const u=r?`${t} (current)`:t,d=(0,m.l_)(e),p=e.endsWith("_bucket")||c;return"up"===e||e.endsWith("_up")?function({panelTitle:e,headerActions:t,queryRunner:r}){return r.setState({maxDataPoints:100}),i.d0.statushistory().setTitle(e).setHeaderActions(t.map(e=>e.clone())).setData(r).setColor({mode:"thresholds"}).setMappings([{type:y.dM.ValueToText,options:{0:{color:"red",text:"down"},1:{color:"green",text:"up"}}}]).setThresholds({mode:y.Ol.Absolute,steps:[{value:0,color:"red"},{value:1,color:"green"}]}).setOption("legend",{showLegend:!1}).setOption("showValue",v.yL.Never)}({panelTitle:u,headerActions:l,queryRunner:_.buildQueryRunner({metricName:e,matchers:s,prometheusFunction:"min",isHistogram:p})}).setUnit(d).build():p?function({panelTitle:e,queryRunner:t,headerActions:r,hideLegend:n}){return i.d0.heatmap().setTitle(e).setData(t).setOption("calculate",!1).setOption("color",{mode:b.P7.Scheme,exponent:.5,scheme:"Spectral",steps:32,reverse:!1}).setHeaderActions(r.map(e=>e.clone())).setOption("legend",{show:!n})}({panelTitle:u,headerActions:l,hideLegend:a,queryRunner:_.buildQueryRunner({metricName:e,matchers:s,prometheusFunction:"rate",isHistogram:p,queryOptions:{format:"heatmap"}})}).setUnit(d).build():function({panelTitle:e,queryRunner:t,color:r,headerActions:n,hideLegend:a}){return i.d0.timeseries().setTitle(e).setData(t).setColor({mode:"fixed",fixedColor:r}).setCustomFieldConfig("fillOpacity",9).setCustomFieldConfig("pointSize",1).setHeaderActions(n.map(e=>e.clone())).setOption("legend",{showLegend:!a})}({panelTitle:u,headerActions:l,color:n,hideLegend:a,queryRunner:_.buildQueryRunner({metricName:e,matchers:s,prometheusFunction:o,isHistogram:p})}).setUnit(d).build()}static buildQueryRunner({metricName:e,matchers:t,isHistogram:r,prometheusFunction:n,queryOptions:a={}}){const o=t.map(S),{isRateQuery:s,groupings:l}=_.determineQueryProperties(e,r),c=h(k({metric:e,filters:o,isRateQuery:s,ignoreUsage:!0,groupings:l},n?{nonRateQueryFunction:n}:{}));return new i.dt({datasource:f.GH,maxDataPoints:_.MAX_DATA_POINTS,queries:[E(k({},a),{refId:e,expr:c,fromExploreMetrics:!0})]})}static determineQueryProperties(e,t){const r=e.split("_").at(-1);let n;return t&&(n=["le"]),{isRateQuery:C.has(r||""),groupings:n}}constructor(e){const{isRateQuery:t}=_.determineQueryProperties(e.metricName,e.isNativeHistogram);var r;const n=E(k({},e),{prometheusFunction:null!==(r=e.prometheusFunction)&&void 0!==r?r:p(t),isNativeHistogram:e.isNativeHistogram,matchers:e.matchers||[],title:e.title||e.metricName,height:e.height||j,hideLegend:Boolean(e.hideLegend),highlight:Boolean(e.highlight),headerActions:[...e.headerActions||[new g.B({metricName:e.metricName})]]});super(E(k({key:`metric-viz-panel-${n.metricName}`},n),{body:_.buildVizPanel(k({},n))})),this.addActivationHandler(this.onActivate.bind(this))}}O(_,"MAX_DATA_POINTS",250),O(_,"Component",({model:e})=>{const{body:t,height:r,highlight:a,isNativeHistogram:i}=e.useState(),s=(0,o.useStyles2)(L,r);return l().createElement("div",{className:(0,n.cx)(s.container,a&&s.highlight,i&&s.nativeHistogram)},t&&l().createElement(t.Component,{model:t}))});const N=e=>(0,n.css)({'[class$="-panel-header"]':{position:"relative",paddingLeft:"120px"},'[class$="-panel-title"]::before':{content:'"Native Histogram"',fontSize:"12px",color:"rgb(158, 193, 247)",position:"absolute",left:"8px",top:"7px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"116px",height:"22px",padding:0,border:`1px solid ${e.colors.info.text}`,borderRadius:e.shape.radius.pill,background:e.colors.info.transparent,cursor:"auto"}});function L(e,t){return{container:(0,n.css)({height:t}),highlight:(0,n.css)({border:`2px solid ${e.colors.primary.main}`}),nativeHistogram:N(e)}}},7833:(e,t,r)=>{r.r(t),r.d(t,{default:()=>L});var n=r(6089),a=r(8531),i=r(2007),o=r(5959),s=r.n(o),l=r(1160),c=r(1159),u=r(6503);function d({error:e}){const t=(0,i.useStyles2)(p),r=(0,c.useNavigate)(),{pathname:n,search:a}=(0,c.useLocation)(),l=(0,o.useCallback)(()=>{const e=new URLSearchParams(a),t=new URLSearchParams;["from","to","timezone"].filter(t=>e.has(t)).forEach(r=>t.set(r,e.get(r))),r({pathname:n,search:t.toString()}),window.location.reload()},[r,n,a]);return s().createElement("div",{className:t.container},s().createElement(u._,{severity:"error",title:"Fatal error!",message:s().createElement(s().Fragment,null,"Please"," ",s().createElement(i.TextLink,{href:"#",onClick:l},"try reloading the page")," ","or, if the problem persists, contact your organization admin. Sorry for the inconvenience."),error:e,errorContext:{handheldBy:"React error boundary"}}))}function p(e){return{container:(0,n.css)({margin:e.spacing(2)})}}var h=r(7781),m=r(1792);function f(){const e=(0,i.useStyles2)(g),t=(0,i.useTheme2)();return s().createElement("div",{className:e.wrap},s().createElement("div",{className:e.graphicContainer},s().createElement(m.A,{src:(t.isDark,"/public/plugins/grafana-metricsdrilldown-app/img/logo.svg")})),s().createElement("div",{className:e.text},s().createElement("h3",{className:e.title},"Welcome to Grafana Metrics Drilldown"),s().createElement("p",null,"We noticed there is no Prometheus datasource configured.",s().createElement("br",null),"Add a"," ",s().createElement("a",{className:"external-link",href:h.locationUtil.assureBaseUrl("/connections/datasources/new")},"Prometheus datasource")," ","to view metrics."),s().createElement("br",null),s().createElement("p",null,"Check"," ",s().createElement("a",{href:"https://grafana.com/docs/grafana/latest/explore/simplified-exploration/metrics/",target:"_blank",className:"external-link",rel:"noreferrer"},"our docs")," ","to learn more or",s().createElement("br",null),s().createElement("a",{href:"https://play.grafana.org/a/grafana-metricsdrilldown-app/drilldown",target:"_blank",className:"external-link",rel:"noreferrer"},"try it online")," ","in Grafana Play!")))}const g=e=>({graphicContainer:(0,n.css)({[e.breakpoints.up("md")]:{alignSelf:"flex-end",height:"auto",padding:e.spacing(1),width:"300px"},[e.breakpoints.up("lg")]:{alignSelf:"flex-end",height:"auto",padding:e.spacing(1),width:"400px"},display:"flex",height:"250px",justifyContent:"center",margin:"0 auto",padding:e.spacing(1),width:"200px"}),text:(0,n.css)({alignItems:"center",display:"flex",flexDirection:"column",justifyContent:"center"}),title:(0,n.css)({marginBottom:"1.5rem"}),wrap:(0,n.css)({[e.breakpoints.up("md")]:{flexDirection:"row",margin:"4rem auto auto auto"},alignItems:"center",display:"flex",flexDirection:"column",margin:"0 auto auto auto",padding:"2rem",textAlign:"center"})});var b=r(4137),y=r(4796),v=r(5521);const w=(0,o.createContext)({trail:(0,y.ef)(),goToUrlForTrail:()=>{}});const S=(0,o.lazy)(()=>r.e(78).then(r.bind(r,9078))),O=()=>{const e=(0,c.useLocation)();return s().createElement(c.Navigate,{to:`${b.bw.Drilldown}${e.search}`,replace:!0})},k=()=>{const{trail:e}=(0,o.useContext)(w);return s().createElement(c.Routes,null,s().createElement(c.Route,{path:b.bw.Drilldown,element:s().createElement(S,{trail:e})}),s().createElement(c.Route,{path:b.bw.Trail,element:s().createElement(O,null)}),s().createElement(c.Route,{path:"*",element:s().createElement(c.Navigate,{to:b.bw.Drilldown,replace:!0})}))};var E=r(2445);function x(e,t){return e instanceof Error?e:"string"==typeof e?new Error(e):"string"==typeof e.message?new Error(e.message):new Error(t)}function j(){const[e,t]=(0,o.useState)();return(0,o.useEffect)(()=>{const e=e=>{(function(e){var t,r,n,a;if(e.filename&&new URL(e.filename).protocol.endsWith("extension:"))return E.v.error(new Error(`Browser extension error: ${e.message}`),{filename:e.filename,lineno:null===(t=e.lineno)||void 0===t?void 0:t.toString(),colno:null===(r=e.colno)||void 0===r?void 0:r.toString()}),!1;return null!==e.error||!e.message||(E.v.error(new Error(`Non-critical error: ${e.message}`),{filename:e.filename,lineno:null===(n=e.lineno)||void 0===n?void 0:n.toString(),colno:null===(a=e.colno)||void 0===a?void 0:a.toString()}),!1)})(e)&&t(x(e.error,"Uncaught exception!"))},r=e=>{"cancelled"!==e.reason.type?t(x(e.reason,"Unhandled rejection!")):t(void 0)};return window.addEventListener("error",e),window.addEventListener("unhandledrejection",r),()=>{window.removeEventListener("unhandledrejection",r),window.removeEventListener("error",e)}},[]),[e,t]}var P=r(3347);var C=r(7476);const _=(0,o.createContext)(null);(0,l.Js)();const N=Object.values(a.config.datasources).filter(C.aQ);function L(e){const t=(0,i.useStyles2)(B),[r]=j(),{trail:n,goToUrlForTrail:l}=function(){const[e,t]=(0,o.useState)((0,y.ef)()),r=e=>{a.locationService.push((0,y.xi)(e)),t(e)};return(0,o.useEffect)(()=>{const e=v.C.subscribe(e=>{r(e)});return()=>e()},[]),{trail:e,goToUrlForTrail:r}}();return function(){const e=(0,o.useRef)(!1);(0,o.useEffect)(()=>{if(!e.current){e.current=!0;const t=new URL(window.location.href).searchParams.get("metric")?"metric-details":"metrics-reducer";(0,P.z)("app_initialized",{view:t})}},[])}(),r?s().createElement("div",{className:t.appContainer,"data-testid":"metrics-drilldown-app"},s().createElement(d,{error:r})):N.length?s().createElement("div",{className:t.appContainer,"data-testid":"metrics-drilldown-app"},s().createElement(_.Provider,{value:e},s().createElement(w.Provider,{value:{trail:n,goToUrlForTrail:l}},s().createElement(k,null)))):s().createElement(f,null)}function B(e){return{appContainer:(0,n.css)({display:"flex",flexDirection:"column",height:"100%",backgroundColor:e.colors.background.primary})}}},8156:(e,t,r)=>{r.d(t,{U:()=>c,p:()=>l});var n=r(878),a=r(2007),i=r(5959),o=r.n(i);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var l=function(e){return e.GRID="grid",e.ROWS="rows",e}({});class c extends n.Bs{getUrlState(){return{layout:this.state.layout}}updateFromUrl(e){const t={};"string"==typeof e.layout&&e.layout!==this.state.layout&&(t.layout=Object.values(l).includes(e.layout)?e.layout:c.DEFAULT_LAYOUT),this.setState(t)}constructor(){super({key:"layout-switcher",layout:c.DEFAULT_LAYOUT}),s(this,"_urlSync",new n.So(this,{keys:["layout"]})),s(this,"onChange",e=>{this.setState({layout:e})})}}s(c,"OPTIONS",[{label:"Grid",value:"grid"},{label:"Rows",value:"rows"}]),s(c,"DEFAULT_LAYOUT","grid"),s(c,"Component",({model:e})=>{const{layout:t}=e.useState();return o().createElement(a.RadioButtonGroup,{"aria-label":"Layout switcher",options:c.OPTIONS,value:t,onChange:e.onChange,fullWidth:!1})})},8361:(e,t,r)=>{r.d(t,{S:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="sort-by-changed",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},8499:(e,t,r)=>{r.d(t,{m:()=>tt});var n=r(6089),a=r(7781),i=r(8531),o=r(878),s=r(2007),l=r(5959),c=r.n(l),u=r(3347),d=r(4796),p=r(2127),h=r(6503),m=r(5749),f=r(384),g=r(3616),b=r(4964);function y(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function v(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){y(i,n,a,o,s,"next",e)}function s(e){y(i,n,a,o,s,"throw",e)}o(void 0)})}}const w="(none)";class S extends o.UU{query(){return v(function*(){return{state:a.LoadingState.Done,data:[{name:"Labels",fields:[{name:null,type:a.FieldType.other,values:[],config:{}}],length:0}]}})()}metricFindQuery(e,t){return v(function*(){var r,n;const a=null===(n=t.scopedVars)||void 0===n||null===(r=n.__sceneObject)||void 0===r?void 0:r.valueOf(),i=yield m.q.getPrometheusDataSourceForScene(a);if(!i)return[];var o;const[,s]=null!==(o=e.match(/valuesOf\((.+)\)/))&&void 0!==o?o:[];if(s){return(yield S.fetchLabelValues(s,a)).map(e=>({value:e,text:e}))}let l=[];try{l=yield this.fetchLabels(i,a,e)}catch(e){(0,g.HA)(["Error while fetching labels! Defaulting to an empty array.",e.toString()])}return[{value:w,text:"(none)"},...l]}).call(this)}fetchLabels(e,t,r){return v(function*(){if(!S.getLabelsMatchAPISupport(e)){const r=S.getFiltersFromVariable(t),n=yield e.getTagKeys(r);return this.processLabelOptions(n.map(({text:e})=>({value:e,text:e})))}const n=yield m.q.fetchLabels({ds:e,timeRange:o.jh.getTimeRange(t).state.value,matcher:r});return this.processLabelOptions(n.map(e=>({value:e,text:e})))}).call(this)}static getLabelsMatchAPISupport(e){try{return e.hasLabelsMatchAPISupport()}catch(e){return(0,g.HA)(["Error while checking if the current data source supports the labels match API! Defaulting to false.",e.toString()]),!1}}static getFiltersFromVariable(e){const t=o.jh.lookupVariable(p.Ao,e);return(0,f.BE)(t)?{filters:t.state.filters}:{filters:[]}}processLabelOptions(e){return e.filter(({value:e})=>!e.startsWith("__")).sort((e,t)=>(0,b._)(e.value,t.value))}static fetchLabelValues(e,t){return v(function*(){const r=yield m.q.getPrometheusDataSourceForScene(t);if(!r)return[];try{return yield m.q.fetchLabelValues({ds:r,labelName:e,timeRange:o.jh.getTimeRange(t).state.value})}catch(t){return(0,g.HA)([`Error while retrieving label "${e}" values! Defaulting to an empty array.`,t.toString()]),[]}})()}testDatasource(){return v(function*(){return{status:"success",message:"OK"}})()}constructor(){super(S.uid,S.uid)}}var O,k,E;E="grafana-prometheus-labels-datasource",(k="uid")in(O=S)?Object.defineProperty(O,k,{value:E,enumerable:!0,configurable:!0,writable:!0}):O[k]=E;const x="wingmanLabelValues";class j extends o.fS{constructor({labelName:e}){super({name:x,datasource:{uid:S.uid},query:`valuesOf(${e})`,isMulti:!1,allowCustomValue:!1,refresh:a.VariableRefresh.onTimeRangeChanged,hide:a.VariableHide.hideVariable,value:"$__all",includeAll:!0})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(j,"Component",()=>c().createElement(c().Fragment,null));var P=r(3831),C=r(2024);const _="labelsWingman";class N extends o.fS{onActivate(){this._subs.add(this.subscribeToState((e,t)=>{e.query!==t.query&&(t.query&&this.setState({value:w}),this.refreshOptions())})),this._subs.add(o.jh.findByKeyAndType(this,p.EY,o.mI).subscribeToState((e,t)=>{e.value!==t.value&&(this.setState({value:w}),this.refreshOptions())})),this._subs.add(o.jh.findByKeyAndType(this,p.Ao,o.H9).subscribeToState((e,t)=>{e.filterExpression!==t.filterExpression&&this.updateQuery()})),this.updateQuery()}updateQuery(){const e=o.jh.interpolate(this,p.ui,{});this.setState({query:`{__name__=~".+",${e}}`})}constructor(){super({name:_,label:"Group by label",placeholder:"Group by label...",datasource:{uid:S.uid},query:"",includeAll:!1,isMulti:!1,allowCustomValue:!1,refresh:a.VariableRefresh.onTimeRangeChanged,hide:a.VariableHide.hideVariable}),this.addActivationHandler(this.onActivate.bind(this))}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(N,"Component",({model:e})=>{const t=(0,s.useStyles2)(L),{label:r}=e.useState();return c().createElement("div",{className:t.container},c().createElement(s.Label,{className:t.label},r),c().createElement(o.fS.Component,{model:e}))});const L=e=>({container:n.css`
    display: flex;
    align-items: center;
    gap: 0;

    [class*='input-wrapper'] {
      width: 240px;
    }
  `,label:n.css`
    height: 32px;
    white-space: nowrap;
    margin: 0;
    background-color: ${e.colors.background.primary};
    padding: ${e.spacing(1)};
    border-radius: ${e.shape.radius.default};
    border: 1px solid ${e.colors.border.weak};
    border-right: none;
  `});var B=r(8156),D=r(5635),A=r(8534),T=r(7630),$=r(5317);function M(){return c().createElement("svg",{stroke:"currentColor",width:"17",height:"16",viewBox:"0 0 17 16",fill:"none"},c().createElement("circle",{cx:"8.92688",cy:"3.63132",r:"2.375",strokeWidth:"1.5"}),c().createElement("path",{d:"M13.6469 4.37965C14.6813 4.76699 15.3235 7.03139 14.9362 8.06582",strokeWidth:"1.5"}),c().createElement("path",{d:"M4.35309 4.37965C3.31866 4.76699 2.67651 7.03139 3.06384 8.06582",strokeWidth:"1.5"}),c().createElement("path",{d:"M10.3408 14.2531C9.75237 14.8415 8.11813 14.7799 7.50903 14.1708",strokeWidth:"1.5"}),c().createElement("circle",{cx:"4.00195",cy:"12.251",r:"2.375",strokeWidth:"1.5"}),c().createElement("circle",{cx:"13.8478",cy:"12.251",r:"2.375",strokeWidth:"1.5"}))}var V=r(1464);function F(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function I(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){F(i,n,a,o,s,"next",e)}function s(e){F(i,n,a,o,s,"throw",e)}o(void 0)})}}class R extends o.UU{query(){return I(function*(){return{state:a.LoadingState.Done,data:[{name:"Labels",fields:[{name:null,type:a.FieldType.other,values:[],config:{}}],length:0}]}})()}metricFindQuery(e,t){return I(function*(){var r,n;const a=null===(n=t.scopedVars)||void 0===n||null===(r=n.__sceneObject)||void 0===r?void 0:r.valueOf(),i=yield m.q.getPrometheusDataSourceForScene(a);if(!i)return[];const s=o.jh.getTimeRange(a).state.value;let l=[];const c=e.startsWith("removeRules"),u=c?e.replace("removeRules",""):e;return l=yield m.q.fetchLabelValues({ds:i,labelName:"__name__",matcher:u,timeRange:s}),c&&(l=l.filter(e=>!(e=>"ALERTS"===e||"ALERTS_FOR_STATE"===e||e.includes(":"))(e))),l.map(e=>({value:e,text:e}))})()}testDatasource(){return I(function*(){return{status:"success",message:"OK"}})()}constructor(){super(R.uid,R.uid)}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(R,"uid","grafana-prometheus-metrics-with-label-values-datasource");const H="metrics-with-label-value";class z extends o.fS{onActivate(e,t,r){const n=o.jh.lookupVariable(p.Ao,this);(null==n?void 0:n.state.hide)!==a.VariableHide.hideVariable&&this.setState({query:z.buildQuery(e,t,r)})}static buildQuery(e,t,r){return r?`removeRules{${e}="${t}",${p.ui}}`:`{${e}="${t}",${p.ui}}`}constructor({labelName:e,labelValue:t,removeRules:r}){return super({key:`${H}-${e}-${t}`,name:H,datasource:{uid:R.uid},query:z.buildQuery(e,t,r),isMulti:!1,allowCustomValue:!1,refresh:a.VariableRefresh.onTimeRangeChanged,hide:a.VariableHide.hideVariable,skipUrlSync:!0,value:"$__all",includeAll:!0}),this.addActivationHandler(this.onActivate.bind(this,e,t,r)),(0,V.I)(this)}}class U extends o.Bs{onActivate(){this.subscribeToLayoutChange()}subscribeToLayoutChange(){const e=o.jh.findByKeyAndType(this,"layout-switcher",B.U),t=this.state.body.state.body,r=(e,r)=>{e.layout!==(null==r?void 0:r.layout)&&t.setState({templateColumns:e.layout===B.p.ROWS?D._O:D.MV})};r(e.state),this._subs.add(e.subscribeToState(r))}constructor({index:e,labelName:t,labelValue:r,labelCardinality:n}){super({index:e,labelName:t,labelValue:r,labelCardinality:n,key:`${t||""}-${r||""}`,$variables:new o.Pj({variables:[new z({labelName:t,labelValue:r})]}),body:new P.k({variableName:H,initialPageSize:3,body:new o.gF({children:[],isLazy:!0,templateColumns:D.MV,autoRows:T.iK,$behaviors:[new o.Gg.K2({key:"metricCrosshairSync",sync:a.DashboardCursorSync.Crosshair})]}),getLayoutLoading:()=>new o.dM({reactNode:c().createElement(s.Spinner,{inline:!0})}),getLayoutEmpty:()=>new o.dM({reactNode:c().createElement(h._,{title:"",severity:"info"},"No metrics found for the current filters and time range.")}),getLayoutError:e=>new o.dM({reactNode:c().createElement(h._,{severity:"error",title:"Error while loading metrics!",error:e})}),getLayoutChild:(e,n)=>{const a=(0,d.kj)(this).isNativeHistogram(e.value);return new o.xK({body:new $.c({vizPanelInGridItem:new T.yG({metricName:e.value,color:(0,d.Vy)(n),matchers:[`${t}="${r}"`],headerActions:[new A.B({metricName:e.value})],isNativeHistogram:a}),metric:e.value})})}})}),this.addActivationHandler(this.onActivate.bind(this))}}function q(e){return{container:(0,n.css)({background:e.colors.background.canvas,margin:e.spacing(1,0,0,0),"& div:focus-within":{boxShadow:"none !important"}}),containerHeader:(0,n.css)({display:"flex",alignItems:"center",gap:"8px",marginBottom:"-36px",paddingBottom:e.spacing(1.5),borderBottom:`1px solid ${e.colors.border.medium}`}),headerButtons:(0,n.css)({position:"relative",top:"3px",marginLeft:"auto",marginRight:"30px",zIndex:100}),selectButton:(0,n.css)({height:"28px"}),collapsableSectionBody:(0,n.css)({display:"flex",flexDirection:"column",gap:"24px",padding:e.spacing(1)}),groupName:(0,n.css)({display:"flex",alignItems:"center",fontSize:"1.3rem",lineHeight:"1.3rem"}),labelValue:(0,n.css)({fontSize:"16px",marginLeft:"8px"}),index:(0,n.css)({fontSize:"12px",color:e.colors.text.secondary,marginLeft:"8px"}),footer:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",marginTop:e.spacing(1),"& button":{height:"40px"}}),variable:(0,n.css)({display:"none"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(U,"Component",({model:e})=>{const[t,r]=(0,l.useState)(!1),n=(0,s.useStyles2)(q),{index:a,labelName:i,labelValue:u,labelCardinality:d,$variables:h,body:m}=e.useState(),f=h.state.variables[0],{loading:g,error:b}=f.useState(),y=m.useSizes(),v=!g&&!b&&y.total>0&&y.current<y.total;return c().createElement("div",{className:n.container,"data-testid":`${i}-${u}-metrics-group`},c().createElement("div",{className:n.containerHeader},c().createElement("div",{className:n.headerButtons},c().createElement(s.Button,{className:n.selectButton,variant:"secondary",onClick:()=>{var t;const r=o.jh.lookupVariable(p.Ao,e);r.setState({filters:[...r.state.filters,{key:i,operator:"=",value:u}]}),null===(t=o.jh.lookupVariable(_,e))||void 0===t||t.changeValueTo(w)},tooltip:`See metrics with ${i}=${u}`,tooltipPlacement:"top"},"Select"))),c().createElement(s.CollapsableSection,{isOpen:!t,onToggle:()=>r(!t),label:c().createElement("div",{className:n.groupName},c().createElement(M,null),c().createElement("div",{className:n.labelValue},u),d>1&&c().createElement("div",{className:n.index},"(",a+1,"/",d,")"))},c().createElement("div",{className:n.collapsableSectionBody},c().createElement(m.Component,{model:m})),v&&c().createElement("div",{className:n.footer},c().createElement(C.d,{label:"metric",batchSizes:y,onClick:()=>{m.increaseBatchSize()},tooltip:`Show more metrics for ${i}="${u}"`}))),c().createElement("div",{className:n.variable},c().createElement(f.Component,{key:f.state.name,model:f})))});class G extends o.Bs{constructor({labelName:e}){super({key:"metrics-group-list",labelName:e,$variables:new o.Pj({variables:[new j({labelName:e})]}),body:new P.k({variableName:x,initialPageSize:20,pageSizeIncrement:10,body:new o.gF({children:[],isLazy:!0,templateColumns:"1fr",autoRows:"auto",rowGap:1}),getLayoutLoading:()=>new o.dM({reactNode:c().createElement(s.Spinner,{inline:!0})}),getLayoutEmpty:()=>new o.dM({reactNode:c().createElement(h._,{title:"",severity:"info"},'No label values found for label "',e,'".')}),getLayoutError:t=>new o.dM({reactNode:c().createElement(h._,{severity:"error",title:`Error while loading label "${e}" values!`,error:t})}),getLayoutChild:(t,r,n)=>new o.xK({body:new U({index:r,labelName:e,labelValue:t.value,labelCardinality:n.length})})})})}}function Q(e){return{footer:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",margin:e.spacing(3,0,1,0),"& button":{height:"40px"}}),variable:(0,n.css)({display:"none"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(G,"Component",({model:e})=>{const t=(0,s.useStyles2)(Q),{body:r,$variables:n,labelName:a}=e.useState(),i=n.state.variables[0],{loading:o,error:l}=i.useState(),u=r.useSizes(),d=!o&&!l&&u.total>0&&u.current<u.total;return c().createElement("div",{"data-testid":"metrics-groupby-list"},c().createElement(r.Component,{model:r}),d&&c().createElement("div",{className:t.footer},c().createElement(C.d,{label:`"${a}" value`,batchSizes:u,onClick:()=>{r.increaseBatchSize()}})),c().createElement("div",{className:t.variable},c().createElement(i.Component,{key:i.state.name,model:i})))});var W=r(9585),K=r(5568),Y=r(1252),J=r(7238);function Z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function X(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class ee extends o.P1{constructor(e){super(X(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Z(e,t,r[t])})}return e}({},e),{key:"list-controls",body:new o.G1({direction:"row",width:"100%",maxHeight:"32px",children:[new o.vA({body:new J.I({urlSearchParamName:"search_txt",targetName:"metric",variableNames:{nonFiltered:K.$,filtered:W.h}})}),new o.vA({width:"auto",body:new Y.fD({})}),new o.vA({width:"auto",body:new B.U})]})}))}}function te(){return{headerWrapper:(0,n.css)({display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center"}}})}}Z(ee,"Component",({model:e})=>{const t=(0,s.useStyles2)(te),{body:r}=e.useState();return c().createElement("div",{className:t.headerWrapper},c().createElement(r.Component,{model:r}))});var re=r(8361),ne=r(1816),ae=r(697),ie=r(6920),oe=r(7397),se=r(5036),le=r(6096);class ce extends a.BusEventWithPayload{}function ue(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(ce,"type","apply-function");class de extends o.Bs{constructor({metricName:e,prometheusFunction:t,disabled:r}){super({key:`apply-action-${e}`,metricName:e,prometheusFunction:t,disabled:Boolean(r)}),ue(this,"onClick",e=>{const{metricName:t,prometheusFunction:r}=this.state;e.preventDefault(),this.publishEvent(new ce({metricName:t,prometheusFunction:r}),!0)})}}ue(de,"Component",({model:e})=>{const t=(0,s.useStyles2)(pe),{disabled:r}=e.useState();return c().createElement(s.Button,{variant:"primary",fill:"outline",size:"sm",className:t.selectButton,onClick:e.onClick,disabled:r},"Apply")});const pe=()=>({selectButton:n.css``});class he extends a.BusEventWithPayload{}function me(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(he,"type","configure-function");class fe extends o.Bs{constructor({metricName:e}){super({key:`configure-action-${e}`,metricName:e}),me(this,"onClick",()=>{this.publishEvent(new he({metricName:this.state.metricName}),!0)})}}me(fe,"PROMETHEUS_FN_OPTIONS",[{label:"Average",value:"avg"},{label:"Sum",value:"sum"},{label:"Minimum",value:"min"},{label:"Maximum",value:"max"},{label:"Rate",value:"rate"}]),me(fe,"Component",({model:e})=>{const t=(0,s.useStyles2)(ge);return c().createElement(s.Button,{className:t.selectButton,"aria-label":"Configure",variant:"secondary",size:"sm",fill:"text",onClick:e.onClick,icon:"cog",tooltip:"Configure the Prometheus function",tooltipPlacement:"top"})});const ge=()=>({selectButton:n.css`
    margin: 0;
    padding: 0;
  `});function be(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ye(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){be(e,t,r[t])})}return e}function ve(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class we extends o.Bs{constructor(e){super(ye({key:"drawer",isOpen:!1},e)),be(this,"open",({title:e,subTitle:t,body:r})=>{this.setState(ve(ye({},this.state),{isOpen:!0,title:e,subTitle:t,body:r}))}),be(this,"close",()=>{this.setState({isOpen:!1})})}}be(we,"Component",({model:e})=>{const{isOpen:t,title:r,subTitle:n,body:a}=e.useState();return c().createElement(c().Fragment,null,a&&t&&c().createElement(s.Drawer,{size:"lg",title:r,subtitle:n,closeOnMaskClick:!0,onClose:e.close},c().createElement(a.Component,{model:a})))});var Se=r(28),Oe=r(2445);const ke="Non-rules metrics",Ee="Recording rules";class xe extends a.BusEventWithPayload{}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(xe,"type","section-value-changed");var je=r(1053);const Pe=({label:e,count:t,checked:r,onChange:n})=>{const a=(0,s.useStyles2)(Ce);return c().createElement("div",{className:a.checkboxWrapper,title:e},c().createElement(s.Checkbox,{label:e,value:r,onChange:n}),c().createElement("span",{className:a.count},"(",t,")"))};function Ce(e){return{checkboxWrapper:(0,n.css)({display:"flex",alignItems:"center",width:"100%","& label *":{fontSize:"14px !important",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}),count:(0,n.css)({color:e.colors.text.secondary,marginLeft:e.spacing(.5),display:"inline-block"})}}function _e({groups:e,selectedGroups:t,onSelectionChange:r}){const n=(0,s.useStyles2)(Ne);return c().createElement(c().Fragment,null,c().createElement("div",{className:n.checkboxListHeader},c().createElement("div",null,t.length," selected"),c().createElement(s.Button,{variant:"secondary",fill:"text",onClick:()=>r([]),disabled:!t.length},"clear")),!e.length&&c().createElement("div",{className:n.noResults},"No results."),e.length>0&&c().createElement("ul",{className:n.checkboxList,"data-testid":"checkbox-filters-list"},e.map(e=>c().createElement("li",{key:e.value,className:n.checkboxItem},c().createElement(Pe,{label:e.label,count:e.count,checked:t.some(t=>t.value===e.value),onChange:n=>{const a=n.currentTarget.checked?[...t,{label:e.label,value:e.value}]:t.filter(t=>t.value!==e.value);r(a)}})))))}function Ne(e){return{checkboxListHeader:(0,n.css)({display:"flex",justifyContent:"space-between",alignItems:"center",color:e.colors.text.secondary,margin:e.spacing(0),padding:e.spacing(0,0,0,1)}),checkboxList:(0,n.css)({height:"100%",margin:0,padding:e.spacing(0,1,1,1),overflowY:"auto","& .css-1n4u71h-Label":{fontSize:"14px !important"},"&::-webkit-scrollbar":{"-webkit-appearance":"none",width:"7px"},"&::-webkit-scrollbar-thumb":{borderRadius:"4px",backgroundColor:e.colors.secondary.main,"-webkit-box-shadow":`0 0 1px ${e.colors.secondary.shade}`}}),checkboxItem:(0,n.css)({display:"flex",alignItems:"center",width:"100%",padding:e.spacing(.5,0)}),noResults:(0,n.css)({fontStyle:"italic",padding:e.spacing(0,1,1,1)})}}function Le(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Be(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Le(e,t,r[t])})}return e}function De(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class Ae extends o.Bs{getUrlState(){return{[this.state.key]:this.state.selectedGroups.map(e=>e.value).join(",")}}updateFromUrl(e){const t={};"string"==typeof e[this.state.key]&&e[this.state.key]!==this.state.selectedGroups.map(e=>e.value).join(",")&&(t.selectedGroups=e[this.state.key].split(",").map(e=>({label:e,value:e}))),this.setState(t)}onActivate(){const e=o.jh.lookupVariable(K.$,this),t=o.jh.lookupVariable(W.h,this);this.updateLists(e.state.options),this.updateCounts();const{selectedGroups:r}=this.state;this.setState({loading:t.state.loading,active:r.length>0})}updateLists(e){this.setState({groups:this.state.computeGroups(e),loading:!1})}updateCounts(){var e;const{groups:t,computeGroups:r,type:n}=this.state,a=o.jh.lookupVariable(K.$,this).state.options,i=null===(e=o.jh.getAncestor(this,tt).state.enginesMap.get(W.h))||void 0===e?void 0:e.filterEngine;if(!i)return void Oe.v.warn("MetricsFilterSection: No filter engine found");const s=De(Be({},i.getFilters()),{[n]:[]}),l=se.k.getFilteredOptions(a,s),c=new Map(r(l).map(e=>[e.label,e.count])),u=t.map(e=>{var t;return De(Be({},e),{count:null!==(t=c.get(e.label))&&void 0!==t?t:0})});this.setState({groups:u,loading:!1})}constructor({key:e,type:t,title:r,description:n,icon:a,computeGroups:i,showHideEmpty:s,showSearch:l,disabled:c,active:d}){super({key:e,type:t,title:r,description:n,icon:a,groups:[],computeGroups:i,selectedGroups:[],loading:!0,showHideEmpty:null==s||s,showSearch:null==l||l,disabled:null!=c&&c,active:null!=d&&d}),Le(this,"_variableDependency",new o.Sh(this,{variableNames:[K.$,W.h],onReferencedVariableValueChanged:e=>{const{name:t,options:r}=e.state;t!==K.$?t===W.h&&this.updateCounts():this.updateLists(r)}})),Le(this,"_urlSync",new o.So(this,{keys:[this.state.key]})),Le(this,"onSelectionChange",e=>{this.setState({selectedGroups:e,active:e.length>0}),this.publishEvent(new Se.Y({type:this.state.type,filters:e.map(e=>e.value)}),!0),this.publishEvent(new xe({key:this.state.key,values:e.map(e=>e.label)}),!0),"prefixes"===this.state.type?(0,u.z)("sidebar_prefix_filter_applied",{filter_count:e.length}):"suffixes"===this.state.type&&(0,u.z)("sidebar_suffix_filter_applied",{filter_count:e.length}),"filters-rule"===this.state.key&&e.length>0&&e.forEach(e=>{let t;switch(e.label){case ke:t="non_rules_metrics";break;case Ee:t="recording_rules";break;default:return}(0,u.z)("sidebar_rules_filter_selected",{filter_type:t})})}),this.addActivationHandler(this.onActivate.bind(this))}}function Te(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%",overflowY:"hidden"}),switchContainer:(0,n.css)({display:"flex",alignItems:"center",justifyContent:"flex-end",gap:e.spacing(1)}),switchLabel:(0,n.css)({fontSize:"12px",color:e.colors.text.primary}),searchInput:(0,n.css)({flexBasis:"32px",flexShrink:0,marginBottom:e.spacing(1),padding:e.spacing(0,.5)})}}Le(Ae,"Component",({model:e})=>{const t=(0,s.useStyles2)(Te),{groups:r,selectedGroups:n,loading:a,title:i,description:o,showHideEmpty:u,showSearch:d}=e.useState(),[p,h]=(0,l.useState)(!1),[m,f]=(0,l.useState)(""),g=(0,l.useMemo)(()=>{const e=[];return p&&e.push(e=>e.count>0),e.push(e=>e.label.toLowerCase().includes(m.toLowerCase())),r.filter(t=>e.every(e=>e(t)))},[p,r,m]);return c().createElement("div",{className:t.container},c().createElement(je._,{title:i,description:o}),u&&c().createElement("div",{className:t.switchContainer},c().createElement("span",{className:t.switchLabel},"Hide empty"),c().createElement(s.Switch,{value:p,onChange:e=>h(e.currentTarget.checked)})),d&&c().createElement(s.Input,{className:t.searchInput,prefix:c().createElement(s.Icon,{name:"search"}),placeholder:"Search...",value:m,onChange:e=>f(e.currentTarget.value),onKeyDown:e=>{"Escape"===e.key&&(e.preventDefault(),f(""))},suffix:c().createElement(s.IconButton,{name:"times",variant:"secondary",tooltip:"Clear search",onClick:()=>f("")})}),a&&c().createElement(s.Spinner,{inline:!0}),!a&&c().createElement(_e,{groups:g,selectedGroups:n,onSelectionChange:e.onSelectionChange}))});var $e=r(8628);function Me(e){const t=new Map;for(const n of e){const e=n.value.split(/[^a-z0-9]/i),a=e.length<=1?n.value:e[e.length-1];var r;const i=null!==(r=t.get(a))&&void 0!==r?r:[];i.push(n.value),t.set(a||"<none>",i)}const n=new Map;for(const[e,r]of t)n.set(e,r.length);return Array.from(n.entries()).sort((e,t)=>e[1]!==t[1]?t[1]-e[1]:(0,b._)(e[0],t[0])).map(([e,t])=>({value:e,count:t,label:e}))}function Ve(e){const t=new Map([["metrics",[]],["rules",[]]]);for(const n of e){const{value:e}=n,a=/:/i.test(e)?"rules":"metrics";var r;const i=null!==(r=t.get(a))&&void 0!==r?r:[];i.push(e),t.set(a,i)}return[{value:"^(?!.*:.*)",label:ke,count:t.get("metrics").length},{value:":",label:Ee,count:t.get("rules").length}]}var Fe=r(5521);function Ie({labels:e,selectedLabel:t,onClickLabel:r,onClickClearSelection:n}){const a=(0,s.useStyles2)(Re);return c().createElement(c().Fragment,null,c().createElement("div",{className:a.listHeader},c().createElement("div",{className:a.selected},t===w?"No selection":`Selected: "${t}"`),c().createElement(s.Button,{variant:"secondary",fill:"text",onClick:n,disabled:t===w},"clear")),!e.length&&c().createElement("div",{className:a.noResults},"No results."),e.length>0&&c().createElement("div",{className:a.list,"data-testid":"labels-list"},c().createElement(s.RadioButtonList,{name:"labels-list",options:e,onChange:r,value:t})))}function Re(e){return{listHeader:(0,n.css)({display:"flex",justifyContent:"space-between",alignItems:"center",color:e.colors.text.secondary,margin:e.spacing(0),padding:e.spacing(0,0,0,1)}),selected:(0,n.css)({overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),list:(0,n.css)({display:"flex",flex:1,flexDirection:"column",gap:0,overflowY:"auto",'& [role="radiogroup"]':{gap:0},"& label":{cursor:"pointer",padding:e.spacing(.5,1),"&:hover":{background:e.colors.background.secondary}},"& label div":{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}),noResults:(0,n.css)({fontStyle:"italic",padding:e.spacing(0,1,1,1)})}}function He(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ze extends o.Bs{onActivate(){const e=o.jh.lookupVariable(this.state.variableName,this),t=e.state.value;this.setState({active:Boolean(t&&t!==w)}),this._subs.add(e.subscribeToState(e=>{const t=Boolean(e.value&&e.value!==w);this.setState({active:t}),this.publishEvent(new xe({key:this.state.key,values:t?[e.value]:[]}),!0)}))}selectLabel(e){o.jh.lookupVariable(this.state.variableName,this).changeValueTo(e);const t=Boolean(e&&e!==w);this.setState({active:t}),this.publishEvent(new xe({key:this.state.key,values:t?[e]:[]}),!0)}constructor({key:e,variableName:t,title:r,description:n,icon:a,disabled:i,active:s}){super({key:e,variableName:t,title:r,description:n,icon:a,disabled:null!=i&&i,active:null!=s&&s}),He(this,"onClickLabel",e=>{(0,u.z)("sidebar_group_by_label_filter_applied",{label:e}),this.selectLabel(e)}),He(this,"onClickClearSelection",()=>{this.selectLabel(w)}),He(this,"useLabelsBrowser",()=>{const{variableName:e,title:t,description:r}=this.useState(),n=o.jh.lookupVariable(e,this),{loading:a,options:i,value:s}=n.useState(),[c,u]=(0,l.useState)("");return{title:t,description:r,loading:a,selectedLabel:s,labelsList:(0,l.useMemo)(()=>{const e=[e=>e!==w,e=>e.toLowerCase().includes(c.toLowerCase())];return i.filter(t=>e.every(e=>e(t.value)))},[i,c]),searchValue:c,onInputChange:e=>{u(e.currentTarget.value)},onInputKeyDown:e=>{"Escape"===e.key&&(e.preventDefault(),u(""))},onInputClear:()=>{u("")}}}),this.addActivationHandler(this.onActivate.bind(this))}}function Ue(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%",overflowY:"hidden"}),search:(0,n.css)({marginBottom:e.spacing(1),padding:e.spacing(0,.5)})}}He(ze,"Component",({model:e})=>{const t=(0,s.useStyles2)(Ue),{title:r,description:n,loading:a,labelsList:i,selectedLabel:o,searchValue:l,onInputChange:u,onInputKeyDown:d,onInputClear:p}=e.useLabelsBrowser();return c().createElement("div",{className:t.container,"data-testid":"labels-browser"},c().createElement(je._,{title:r,description:n}),c().createElement(s.Input,{className:t.search,prefix:c().createElement(s.Icon,{name:"search"}),placeholder:"Search...",value:l,onChange:u,onKeyDown:d,suffix:c().createElement(s.IconButton,{name:"times",variant:"secondary",tooltip:"Clear search",onClick:p})}),a&&c().createElement(s.Spinner,{inline:!0}),!a&&c().createElement(Ie,{labels:i,selectedLabel:o,onClickLabel:e.onClickLabel,onClickClearSelection:e.onClickClearSelection}))});class qe extends o.Bs{onActivate(){}constructor({key:e,title:t,description:r,icon:n,disabled:a}){super({key:e,title:t,description:r,icon:n,disabled:null!=a&&a,active:!1}),this.addActivationHandler(this.onActivate.bind(this))}}function Ge(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%",overflowY:"hidden"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(qe,"Component",({model:e})=>{const t=(0,s.useStyles2)(Ge),{title:r,description:n}=e.useState();return c().createElement("div",{className:t.container},c().createElement(je._,{title:r,description:n}))});const Qe=new Map([["rules",function(){return c().createElement("svg",{stroke:"currentColor",width:"16",height:"16",viewBox:"0 0 16 16",fill:"none"},c().createElement("rect",{x:"1.25",y:"1.625",width:"5.25",height:"5.25",rx:"1",strokeWidth:"1.5"}),c().createElement("circle",{cx:"12.25",cy:"4.25",r:"2.75",strokeWidth:"1.5"}),c().createElement("circle",{cx:"3.75",cy:"11.75",r:"2.75",strokeWidth:"1.5"}),c().createElement("rect",{x:"9.5",y:"9.125",width:"5.25",height:"5.25",rx:"1",strokeWidth:"1.5"}))}],["groups",M]]);function We({ariaLabel:e,disabled:t,visible:r,active:i,tooltip:o,iconOrText:l,onClick:u}){const d=(0,s.useStyles2)(Ke);let p,h;return l in a.availableIconsIndex?p=l:h=Qe.has(l)?Qe.get(l):function(){return c().createElement(c().Fragment,null,l)},c().createElement(s.Button,{className:(0,n.cx)(d.button,t&&"disabled",r&&"visible",i&&"active"),size:"md",variant:"secondary",fill:"text",icon:p,"aria-label":e,tooltip:o,tooltipPlacement:"right",onClick:u,disabled:t},h&&c().createElement(h,null))}function Ke(e){return{button:(0,n.css)({margin:0,color:e.colors.text.secondary,"&:hover":{color:e.colors.text.maxContrast,background:"transparent"},"&.disabled:hover":{color:e.colors.text.secondary},"&.visible":{color:e.colors.text.maxContrast},"&.active":{color:e.colors.text.maxContrast}})}}function Ye(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Je=["filters-rule","filters-prefix","filters-suffix"];class Ze extends o.Bs{onActivate(){const e=this.initOtherMetricsVar();return this._subs.add(this.subscribeToEvent(xe,e=>{const{key:t,values:r}=e.payload,{sectionValues:n}=this.state,a=new Map(n).set(t,r);this.setOtherMetricFilters(a),this.setState({sectionValues:a})})),()=>{e()}}setOtherMetricFilters(e){const t=o.jh.lookupVariable(p.hc,this);if(!(0,f.BE)(t))return;const r={"filters-rule":"rule group","filters-prefix":"prefix","filters-suffix":"suffix"},n=Array.from(e.entries()).reduce((e,[t,n])=>(n.length&&Je.includes(t)&&e.push({key:t,operator:"=",value:n.join(", "),keyLabel:r[t]}),e),[]);t.setState({filters:n,hide:n.length?a.VariableHide.hideLabel:a.VariableHide.hideVariable})}initOtherMetricsVar(){const e=(0,d.kj)(this).state.$variables;if(!e)return()=>{};const t=new o.H9({name:p.hc,readOnly:!0,skipUrlSync:!0,datasource:null,hide:a.VariableHide.hideVariable,layout:"combobox",applyMode:"manual",allowCustomValue:!0});return e.setState({variables:[...e.state.variables,t]}),this.setOtherMetricFilters(this.state.sectionValues),()=>{e.setState({variables:[...e.state.variables.filter(e=>e!==t)]})}}static getSectionValuesFromUrl(){const e=new URLSearchParams(window.location.search),t=new Map;for(const r of Je){const n=e.get(r);t.set(r,n?n.split(",").map(e=>e.trim()):[])}const r=e.get(`var-${_}`);return Boolean(r&&r!==w)&&t.set("groupby-labels",[r]),t}setActiveSection(e){const{visibleSection:t,sections:r}=this.state;if(!e||e===(null==t?void 0:t.state.key))return(0,u.z)("metrics_sidebar_toggled",{action:"closed",section:null==t?void 0:t.state.key}),void this.setState({visibleSection:null});var n;(0,u.z)("metrics_sidebar_toggled",{action:"opened",section:e}),"filters-prefix"===e?(0,u.z)("sidebar_prefix_filter_section_clicked",{}):"filters-suffix"===e&&(0,u.z)("sidebar_suffix_filter_section_clicked",{}),this.setState({visibleSection:null!==(n=r.find(t=>t.state.key===e))&&void 0!==n?n:null})}constructor(e){var t,r,n;const a=Ze.getSectionValuesFromUrl();super(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Ye(e,t,r[t])})}return e}({key:"sidebar",visibleSection:null,sections:[new Ae({key:"filters-rule",type:"categories",title:"Rules filters",description:"Filter metrics and recording rules",icon:"rules",computeGroups:Ve,showHideEmpty:!1,showSearch:!1,active:Boolean(null===(t=a.get("filters-rule"))||void 0===t?void 0:t.length)}),new Ae({key:"filters-prefix",type:"prefixes",title:"Prefix filters",description:"Filter metrics based on their name prefix (Prometheus namespace)",icon:"A_",computeGroups:$e.w,active:Boolean(null===(r=a.get("filters-prefix"))||void 0===r?void 0:r.length)}),new Ae({key:"filters-suffix",type:"suffixes",title:"Suffix filters",description:"Filter metrics based on their name suffix",icon:"_Z",computeGroups:Me,active:Boolean(null===(n=a.get("filters-suffix"))||void 0===n?void 0:n.length)}),new ze({key:"groupby-labels",variableName:_,title:"Group by labels",description:"Group metrics by their label values",icon:"groups",active:a.has("groupby-labels")}),new Fe.O({key:"bookmarks",title:"Bookmarks",description:"Access your saved metrics for quick reference",icon:"star"}),new qe({key:"settings",title:"Settings",description:"Settings",icon:"cog",disabled:!0})],sectionValues:a},e)),a.set("filters-rule",[]),this.addActivationHandler(this.onActivate.bind(this))}}function Xe(e){return{container:(0,n.css)({position:"relative",display:"flex",flexDirection:"row",height:"100%",overflow:"hidden"}),buttonsBar:(0,n.css)({display:"flex",flexDirection:"column",alignItems:"center",gap:0,width:"42px",padding:0,margin:0,boxSizing:"border-box",border:`1px solid ${e.colors.border.weak}`,borderRadius:e.shape.radius.default,backgroundColor:e.colors.background.primary,borderTopLeftRadius:0,borderBottomLeftRadius:0,position:"relative"}),buttonContainer:(0,n.css)({marginTop:e.spacing(1),"&::before":{transition:"0.5s ease",content:'""',position:"absolute",left:0,height:"32px",borderLeft:`2px solid ${e.colors.action.selectedBorder}`,boxSizing:"border-box",opacity:0,visibility:"hidden"},"&:hover::before":{opacity:1,visibility:"visible"},"&.visible::before":{opacity:1,visibility:"visible"},"&.disabled::before":{opacity:0,visibility:"hidden"},"&.active::after":{content:'""',position:"absolute",right:0,width:"8px",height:"8px",backgroundColor:e.colors.action.selectedBorder,borderRadius:"50%",margin:"2px 4px 0 0"}}),content:(0,n.css)({width:"calc(300px - 42px)",boxSizing:"border-box",border:`1px solid ${e.colors.border.weak}`,borderLeft:"none",borderRadius:e.shape.radius.default,backgroundColor:e.colors.background.canvas,padding:e.spacing(1.5)}),closeButton:(0,n.css)({position:"absolute",top:e.spacing(1.5),right:e.spacing(1),margin:0})}}function et(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Ye(Ze,"Component",({model:e})=>{const t=(0,s.useStyles2)(Xe),{sections:r,visibleSection:a,sectionValues:i}=e.useState();return c().createElement("div",{className:t.container},c().createElement("div",{className:t.buttonsBar,"data-testid":"sidebar-buttons"},r.map(r=>{var o,s;const{key:l,title:u,icon:d,disabled:p,active:h}=r.state,m=(null==a?void 0:a.state.key)===l,f=(null===(o=i.get(l))||void 0===o?void 0:o.length)?`${u}: ${null===(s=i.get(l))||void 0===s?void 0:s.join(", ")}`:u;return c().createElement("div",{key:l,className:(0,n.cx)(t.buttonContainer,m&&"visible",h&&"active",p&&"disabled")},c().createElement(We,{ariaLabel:u,disabled:p,visible:m,active:h,tooltip:f,onClick:()=>e.setActiveSection(l),iconOrText:d}))})),a&&c().createElement("div",{className:t.content,"data-testid":"sidebar-content"},c().createElement(s.IconButton,{className:t.closeButton,name:"times","aria-label":"Close",tooltip:"Close",tooltipPlacement:"top",onClick:()=>e.setActiveSection("")}),a instanceof Ae&&c().createElement(a.Component,{model:a}),a instanceof ze&&c().createElement(a.Component,{model:a}),a instanceof Fe.O&&c().createElement(a.Component,{model:a}),a instanceof qe&&c().createElement(a.Component,{model:a})))});class tt extends o.Bs{onActivate(){const e=o.jh.lookupVariable(_,this).state.value;this.updateBasedOnGroupBy(e),this.subscribeToEvents()}updateBasedOnGroupBy(e){const t=Boolean(e&&e!==w);o.jh.findByKeyAndType(this,"quick-search",J.I).toggleCountsDisplay(!t),this.setState({body:t?new G({labelName:e}):new D.Qs({variableName:W.h})})}subscribeToEvents(){this.initVariablesFilteringAndSorting(),this._subs.add(this.subscribeToEvent(he,e=>{this.openDrawer(e.payload.metricName)})),this._subs.add(this.subscribeToEvent(ce,()=>{this.state.drawer.close()})),this._subs.add(this.subscribeToEvent(p.OO,e=>{void 0!==e.payload&&(0,Y.VN)(e.payload)}))}initVariablesFilteringAndSorting(){this._subs.add(this.subscribeToEvent(ae.x,e=>{const{key:t}=e.payload,r=o.jh.findByKey(this,t);this.state.enginesMap.set(t,{filterEngine:new se.k(r),sortEngine:new le.c(r)})})),this._subs.add(this.subscribeToEvent(ie.e,e=>{this.state.enginesMap.delete(e.payload.key)}));const e=o.jh.findByKeyAndType(this,"quick-search",J.I),t=o.jh.findAllObjects(this,e=>e instanceof Ae),r=o.jh.findByKeyAndType(this,"metrics-sorter",Y.fD).state.$variables.getByName(Y.NJ);this._subs.add(this.subscribeToEvent(oe.x,n=>{const{key:a,options:i}=n.payload,{filterEngine:o,sortEngine:s}=this.state.enginesMap.get(a);o.setInitOptions(i);const l={names:e.state.value?[e.state.value]:[]};for(const e of t)l[e.state.type]=e.state.selectedGroups.map(e=>e.value);o.applyFilters(l,{forceUpdate:!0,notify:!1}),s.sort(r.state.value)})),this._subs.add(this.subscribeToEvent(ne.W,e=>{const{searchText:t}=e.payload;for(const[,{filterEngine:e,sortEngine:n}]of this.state.enginesMap)e.applyFilters({names:t?[t]:[]}),n.sort(r.state.value)})),this._subs.add(this.subscribeToEvent(Se.Y,e=>{const{type:t,filters:n}=e.payload;for(const[,{filterEngine:e,sortEngine:a}]of this.state.enginesMap)e.applyFilters({[t]:n}),a.sort(r.state.value)})),this._subs.add(this.subscribeToEvent(re.S,e=>{const{sortBy:t}=e.payload;(0,u.z)("sorting_changed",{from:"metrics-reducer",sortBy:t});for(const[,{sortEngine:e}]of this.state.enginesMap)e.sort(t)}))}openDrawer(e){const t=(0,d.kj)(this);this.state.drawer.open({title:"Choose a new Prometheus function",subTitle:e,body:new o.gF({templateColumns:D.MV,autoRows:T.Rg,isLazy:!0,$behaviors:[new o.Gg.K2({key:"metricCrosshairSync",sync:a.DashboardCursorSync.Crosshair})],children:fe.PROMETHEUS_FN_OPTIONS.map((r,n)=>new o.xK({body:new T.yG({title:r.label,metricName:e,color:(0,d.Vy)(n),prometheusFunction:r.value,height:T.Rg,hideLegend:!0,highlight:1===n,isNativeHistogram:t.isNativeHistogram(e),headerActions:[new de({metricName:e,prometheusFunction:r.value,disabled:1===n})]})}))})})}constructor(){super({$variables:new o.Pj({variables:[new K.s,new W.V,new N]}),listControls:new ee({}),sidebar:new Ze({}),body:new D.Qs({variableName:W.h}),drawer:new we({}),enginesMap:new Map}),et(this,"_variableDependency",new o.Sh(this,{variableNames:[_],onReferencedVariableValueChanged:e=>{this.updateBasedOnGroupBy(e.state.value)}})),function(e){try{for(const t of e)(0,o.pY)({dataSource:t})}catch(e){const{message:t}=e;/A runtime data source with uid (.+) has already been registered/.test(t)||(0,g.jx)(e,["Fail to register all the runtime data sources!","The application cannot work as expected, please try reloading the page or if the problem persists, contact your organization admin."])}}([new S,new R]),this.addActivationHandler(this.onActivate.bind(this))}}et(tt,"Component",({model:e})=>{var t;const r=null!==(t=(0,i.useChromeHeaderHeight)())&&void 0!==t?t:0,n=(0,s.useStyles2)(nt,r),{$variables:a,body:o,listControls:l,drawer:u,sidebar:d}=e.useState();return c().createElement(c().Fragment,null,c().createElement("div",{className:n.listControls,"data-testid":"list-controls"},c().createElement(l.Component,{model:l})),c().createElement("div",{className:n.body},c().createElement("div",{className:n.sidebar,"data-testid":"sidebar"},c().createElement(d.Component,{model:d})),c().createElement("div",{className:n.list},c().createElement(o.Component,{model:o}))),c().createElement("div",{className:n.variables},null==a?void 0:a.state.variables.map(e=>c().createElement(e.Component,{key:e.state.name,model:e}))),c().createElement(u.Component,{model:u}))});const rt=144;function nt(e,t){return{listControls:(0,n.css)({marginBottom:e.spacing(1.5)}),body:(0,n.css)({display:"flex",flexDirection:"row",gap:e.spacing(1),height:`calc(100vh - ${t+rt}px)`}),list:(0,n.css)({width:"100%",overflowY:"auto"}),sidebar:(0,n.css)({flex:"0 0 auto",overflowY:"auto"}),variables:(0,n.css)({display:"none"})}}},8534:(e,t,r)=>{r.d(t,{B:()=>c});var n=r(878),a=r(2007),i=r(5959),o=r.n(i),s=r(2127);function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class c extends n.Bs{constructor({metricName:e,variant:t,fill:r}){super({key:`select-action-${e}`,metricName:e,variant:t||"primary",fill:r||"outline"}),l(this,"onClick",()=>{this.publishEvent(new s.OO(this.state.metricName),!0)})}}l(c,"Component",({model:e})=>{const{variant:t,fill:r}=e.useState();return o().createElement(a.Button,{variant:t,fill:r,size:"sm",onClick:e.onClick,"data-testid":`select-action-${e.state.metricName}`},"Select")})},8628:(e,t,r)=>{r.d(t,{w:()=>i});var n=r(4964);const a="<none>";function i(e){const t=new Map;for(const n of e){const e=n.value.split(/[^a-z0-9]/i),i=e.length<=1?n.value:e[0];var r;const o=null!==(r=t.get(i))&&void 0!==r?r:[];o.push(n.value),t.set(i||a,o)}const i=new Map;for(const[e,r]of t)i.set(e,r.length);return Array.from(i.entries()).sort((e,t)=>e[1]!==t[1]?t[1]-e[1]:(0,n._)(e[0],t[0])).map(([e,t])=>({value:e,count:t,label:e}))}},8643:(e,t,r)=>{r.d(t,{R:()=>Vr});var n=r(8531),a=r(878),i=r(5959),o=r.n(i),s=r(6089),l=r(2007),c=r(5749),u=r(1269),d=r(2445);const p=r.p+"ac01ecbc64128d2f3e68.svg";var h=r(4796),m=r(2533),f=r(2127),g=r(7265);function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){b(e,t,r[t])})}return e}function v(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const w=`${m.id}/investigation/v1`;class S extends a.Bs{getPanelConfigAndDataFrames(){var e;const t=(0,h.UX)(this,e=>e instanceof a.Eb,a.Eb),r=a.jh.getData(this);return{fieldConfig:null==t?void 0:t.state.fieldConfig,frames:null==r||null===(e=r.state.data)||void 0===e?void 0:e.series}}constructor(e){super(v(y({},e),{queries:[]})),b(this,"_onActivate",()=>{this._subs.add(this.subscribeToState(()=>{this.getQueries(),this.getContext()}));const e=a.jh.interpolate(this,f.gR);this.setState({dsUid:e})}),b(this,"getQueries",()=>{const e=a.jh.getData(this),t=a.jh.findObject(e,g.xT);if((0,g.xT)(t)){const e=this.state.frame?O(this.state.frame):null,r=t.state.queries.map(r=>v(y({},r),{expr:a.jh.interpolate(t,r.expr),legendFormat:(null==e?void 0:e.name)?`{{ ${e.name} }}`:a.jh.interpolate(t,r.legendFormat)}));JSON.stringify(r)!==JSON.stringify(this.state.queries)&&this.setState({queries:r})}}),b(this,"updateFieldConfigOverrides",()=>{const{fieldConfig:e,frames:t}=this.getPanelConfigAndDataFrames();if(e&&(null==t?void 0:t.length)){for(const a of t)for(const t of a.fields){const a=Object.keys(t.config).map(e=>({id:e,value:t.config[e]})),i=e.overrides.find(e=>{var r,n;return e.matcher.options===(null!==(n=null!==(r=t.config.displayNameFromDS)&&void 0!==r?r:t.config.displayName)&&void 0!==n?n:t.name)&&"byName"===e.matcher.id});var r,n;if(!i)e.overrides.unshift({matcher:{id:"byName",options:null!==(n=null!==(r=t.config.displayNameFromDS)&&void 0!==r?r:t.config.displayName)&&void 0!==n?n:t.name},properties:a});i&&JSON.stringify(i.properties)!==JSON.stringify(a)&&(i.properties=a)}return e}}),b(this,"getContext",()=>{const e=this.updateFieldConfigOverrides(),{queries:t,dsUid:r,labelName:n,fieldName:i}=this.state,o=a.jh.getTimeRange(this);if(!o||!t||!r)return;const s={origin:"Metrics Drilldown",type:"timeseries",queries:t,timeRange:y({},o.state.value),datasource:{uid:r},url:window.location.href,id:`${JSON.stringify(t)}${n}${i}`,title:n+(i?` > ${i}`:""),logoPath:p,drillDownLabel:i,fieldConfig:e};JSON.stringify(s)!==JSON.stringify(this.state.context)&&this.setState({context:s})}),this.addActivationHandler(this._onActivate.bind(this))}}b(S,"Component",({model:e})=>{const{context:t}=e.useState(),{links:r}=(0,n.usePluginLinks)({extensionPointId:w,context:t,limitPerPlugin:1}),a=r.find(e=>"grafana-investigations-app"===e.pluginId);return a?o().createElement(l.IconButton,{tooltip:a.description,"aria-label":"add panel to exploration",key:a.id,name:null!==(i=a.icon)&&void 0!==i?i:"panel-add",onClick:e=>{a.onClick&&a.onClick(e)}}):null;var i});const O=e=>{var t,r;const n=null!==(r=null===(t=e.fields[1])||void 0===t?void 0:t.labels)&&void 0!==r?r:{},a=Object.keys(n);if(1!==a.length)return;const i=a[0];return{name:i,value:n[i]}};function k(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function E(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){k(i,n,a,o,s,"next",e)}function s(e){k(i,n,a,o,s,"throw",e)}o(void 0)})}}function x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function j(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){x(e,t,r[t])})}return e}function P(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const C="Add to investigation",_="investigations_divider",N="Investigations";class L extends a.Bs{addItem(e){this.state.body&&this.state.body.addItem(e)}setItems(e){this.state.body&&this.state.body.setItems(e)}constructor(e){var t,r;super(P(j({},e),{addExplorationsLink:null===(r=e.addExplorationsLink)||void 0===r||r})),(t=this).addActivationHandler(()=>{let e;try{const n=a.jh.getAncestor(t,a.Eb),i=a.jh.getData(n).state.data;if(!i)throw new Error("Cannot get link to explore, no panel data found");const o=(0,g.un)(n);var r;(null!==(r=null==o?void 0:o.state.queries)&&void 0!==r?r:[]).forEach(e=>{delete e.legendFormat}),e=(0,a.pN)(i,t,i.timeRange,e=>"expr"in e&&"string"==typeof e.expr&&e.expr.includes("__ignore_usage__")?P(j({},e),{expr:e.expr.replace(/,?__ignore_usage__=""/,"")}):e)}catch(e){}const n=[{text:"Navigation",type:"group"},{text:"Explore",iconClassName:"compass",onClick:()=>null==e?void 0:e.then(e=>e&&window.open(e,"_blank")),shortcut:"p x"}];t.setState({body:new a.Lw({items:n})});const i=new S({labelName:t.state.labelName,fieldName:t.state.fieldName,frame:t.state.frame});var o;(t._subs.add(null==i?void 0:i.subscribeToState(()=>E(function*(){var e;yield(e=t,E(function*(){const t=e.state.explorationsButton;if(t){var r;const l=yield B(t);var n;const c=null!==(n=null===(r=e.state.body)||void 0===r?void 0:r.state.items)&&void 0!==n?n:[],u=c.find(e=>e.text===C);var a,i,o,s;l&&(u?u&&(null===(a=e.state.body)||void 0===a||a.setItems(c.filter(e=>!1===[_,N,C].includes(e.text)))):(null===(i=e.state.body)||void 0===i||i.addItem({text:_,type:"divider"}),null===(o=e.state.body)||void 0===o||o.addItem({text:N,type:"group"}),null===(s=e.state.body)||void 0===s||s.addItem({text:C,iconClassName:"plus-square",onClick:e=>l.onClick&&l.onClick(e)})))}})())})())),t.setState({explorationsButton:i}),t.state.addExplorationsLink)&&(null===(o=t.state.explorationsButton)||void 0===o||o.activate())})}}x(L,"Component",({model:e})=>{const{body:t}=e.useState();return t?o().createElement(t.Component,{model:t}):o().createElement(o().Fragment,null)});const B=e=>E(function*(){const t=e.state.context;if(n.config.buildInfo.version.startsWith("11."))try{const e=(yield Promise.resolve().then(r.t.bind(r,8531,23))).getPluginLinkExtensions;if(void 0!==e){return e({extensionPointId:w,context:t}).extensions[0]}}catch(e){d.v.error(e,{message:"Error importing getPluginLinkExtensions"})}if("function"==typeof n.getObservablePluginLinks){return(yield(0,u.firstValueFrom)((0,n.getObservablePluginLinks)({extensionPointId:w,context:t})))[0]}})();class D extends a.Bs{_onActivate(){const{autoQuery:e}=(0,h.aM)(this).state;0!==e.variants.length&&this.setState({options:e.variants.map(e=>({label:e.variant,value:e.variant}))})}constructor(e){super(e),this.addActivationHandler(this._onActivate.bind(this))}}var A,T,$;function M(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function V(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}$=({model:e})=>{const{options:t,onChangeQuery:r,queryDef:n}=e.useState();return t?o().createElement(l.RadioButtonGroup,{size:"sm",options:t,value:n.variant,onChange:r}):null},(T="Component")in(A=D)?Object.defineProperty(A,T,{value:$,enumerable:!0,configurable:!0,writable:!0}):A[T]=$;class F extends a.Bs{onActivate(){if(!this.state.panel){const{autoQuery:e,metric:t}=(0,h.aM)(this).state;this.getVizPanelFor(e.main,t).then(e=>this.setState({panel:e,metric:t}))}}getVizPanelFor(e,t){return(r=function*(){const r=(0,h.kj)(this),n=yield r.getMetricMetadata(t),i=(0,c.R)(n);return e.vizBuilder().setData(new a.dt({datasource:f.GH,maxDataPoints:f.dc,queries:e.queries})).setDescription(i).setHeaderActions([new D({queryDef:e,onChangeQuery:this.onChangeQuery})]).setShowMenuAlways(!0).setMenu(new L({labelName:null!=t?t:this.state.metric})).build()},function(){var e=this,t=arguments;return new Promise(function(n,a){var i=r.apply(e,t);function o(e){M(i,n,a,o,s,"next",e)}function s(e){M(i,n,a,o,s,"throw",e)}o(void 0)})}).call(this);var r}constructor(e){super(e),V(this,"onChangeQuery",e=>{const t=(0,h.aM)(this),r=t.state.autoQuery.variants.find(t=>t.variant===e);this.getVizPanelFor(r).then(e=>this.setState({panel:e})),t.setState({queryDef:r})}),this.addActivationHandler(this.onActivate.bind(this))}}V(F,"Component",({model:e})=>{const{panel:t}=e.useState();if(t)return o().createElement(t.Component,{model:t})});const I={OPEN_EXPLORE_LABEL:"Open in explore",COPY_URL_LABEL:"Copy url",BOOKMARK_LABEL:"Bookmark",SELECT_NEW_METRIC_TOOLTIP:"Remove existing metric and choose a new metric"};var R=r(3347),H=r(7781);function z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const U="metric-graph";class q extends a.Bs{constructor(e){var t;super(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){z(e,t,r[t])})}return e}({topView:null!==(t=e.topView)&&void 0!==t?t:new a.G1({direction:"column",$behaviors:[new a.Gg.K2({key:"metricCrosshairSync",sync:H.DashboardCursorSync.Crosshair})],children:[new a.vA({minHeight:280,maxHeight:"40%",body:new F({key:U})}),new a.vA({ySizing:"content",body:new pr({})})]})},e))}}function G(e,t){return{container:(0,s.css)({display:"flex",flexDirection:"column",position:"relative",flexGrow:1}),sticky:(0,s.css)({display:"flex",flexDirection:"row",background:e.isLight?e.colors.background.primary:e.colors.background.canvas,position:"sticky",paddingTop:e.spacing(1),marginTop:`-${e.spacing(1)}`,top:`${t+70}px`,zIndex:10}),nonSticky:(0,s.css)({display:"flex",flexDirection:"row"})}}z(q,"Component",({model:e})=>{const{topView:t,selectedTab:r}=e.useState(),{stickyMainGraph:a}=(0,h.KE)(e).useState(),i=(0,n.useChromeHeaderHeight)(),s=(0,h.kj)(e),c=(0,l.useStyles2)(G,s.state.embedded?0:null!=i?i:0);return o().createElement("div",{className:c.container},o().createElement("div",{className:a?c.sticky:c.nonSticky,"data-testid":"top-view"},o().createElement(t.Component,{model:t})),r&&o().createElement("div",{"data-testid":"tab-content"},o().createElement(r.Component,{model:r})))});var Q=r(1816),W=r(7238),K=r(5635),Y=r(697),J=r(6920),Z=r(7397),X=r(9585),ee=r(5568),te=r(5036),re=r(6096),ne=r(28),ae=r(8156),ie=r(8628),oe=r(3831);function se(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function le(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const ce={label:"All metric names",value:"all"};class ue extends a.Bs{getUrlState(){return{metricPrefix:this.state.value}}updateFromUrl(e){"string"!=typeof e.metricPrefix?this.setState({value:ce.value}):this.state.value!==e.metricPrefix&&this.setState({value:e.metricPrefix})}onActivate(){this.parseMetricPrefixes()}parseMetricPrefixes(){if(this._variableDependency.hasDependencyInLoadingState())return void this.setState({error:void 0,loading:!0});const e=a.jh.lookupVariable(ee.$,this);if(e.state.error)return void this.setState({error:e.state.error,loading:!1,options:[]});const t=(0,ie.w)((0,oe.a)(e)),r=[ce,...t.map(e=>({value:e.value,label:`${e.label} (${e.count})`}))],{value:n}=this.state,i=r.find(e=>e.value===n)?n:ce.value;this.setState({error:null,loading:!1,options:r}),this.selectOption({value:i,label:i})}constructor(e){super(le(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){se(e,t,r[t])})}return e}({},e),{key:"related-prefix-filter",loading:!0,error:null,options:[ce],value:ce.value})),se(this,"_variableDependency",new a.Sh(this,{variableNames:[ee.$],onVariableUpdateCompleted:()=>this.parseMetricPrefixes()})),se(this,"_urlSync",new a.So(this,{keys:["metricPrefix"]})),se(this,"selectOption",e=>{const t=null===e?ce.value:e.value;this.setState({value:t}),this.publishEvent(new ne.Y({type:"prefixes",filters:t===ce.value?[]:[t]}),!0)}),this.addActivationHandler(this.onActivate.bind(this))}}function de(e){return{container:s.css`
      display: flex;

      & > div {
        margin: 0;
      }
    `,label:s.css`
      margin-right: 0;
      background-color: ${e.colors.background.primary};
      border: 1px solid ${e.colors.border.medium};
      border-right: 0 none;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    `,tooltipIcon:s.css`
      margin-left: ${e.spacing(.5)};
    `}}function pe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function he(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}se(ue,"Component",({model:e})=>{const t=(0,l.useStyles2)(de),{loading:r,options:n,value:a,error:i}=e.useState();return o().createElement("div",{className:t.container,"data-testid":"prefix-filter-selector"},o().createElement(l.InlineField,{disabled:r,error:i&&i.toString(),label:o().createElement(l.InlineLabel,{width:"auto",className:t.label},o().createElement("span",null,"View by"),o().createElement(l.Tooltip,{content:"View by the metric prefix. A metric prefix is a single word at the beginning of the metric name, relevant to the domain the metric belongs to.",placement:"top"},o().createElement(l.Icon,{className:t.tooltipIcon,name:"info-circle",size:"sm"})))},o().createElement(l.Combobox,{value:a,onChange:e.selectOption,options:n})))});class me extends a.P1{constructor(e){super(he(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){pe(e,t,r[t])})}return e}({},e),{key:"related-list-controls",body:new a.G1({direction:"row",width:"100%",maxHeight:"32px",children:[new a.vA({width:"auto",body:new ue({})}),new a.vA({body:new W.I({urlSearchParamName:"gmd-relatedSearchText",targetName:"related metric",variableNames:{nonFiltered:ee.$,filtered:X.h},displayCounts:!0})}),new a.vA({width:"auto",body:new ae.U})]})}))}}function fe(){return{headerWrapper:(0,s.css)({display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center"}}})}}pe(me,"Component",({model:e})=>{const t=(0,l.useStyles2)(fe),{body:r}=e.useState();return o().createElement("div",{className:t.headerWrapper,"data-testid":"related-list-controls"},o().createElement(r.Component,{model:r}))});class ge extends a.Bs{onActivate(){this.subscribeToEvents()}subscribeToEvents(){this.initVariablesFilteringAndSorting()}initVariablesFilteringAndSorting(){const{metric:e}=this.state,t=new Map;this._subs.add(this.subscribeToEvent(Y.x,e=>{const{key:r}=e.payload,n=a.jh.findByKey(this,r);t.set(r,{filterEngine:new te.k(n),sortEngine:new re.c(n)})})),this._subs.add(this.subscribeToEvent(J.e,e=>{t.delete(e.payload.key)}));const r=a.jh.findByKeyAndType(this,"quick-search",W.I);this._subs.add(this.subscribeToEvent(Z.x,n=>{const{key:a,options:i}=n.payload,{filterEngine:o,sortEngine:s}=t.get(a);o.setInitOptions(i);const l={names:r.state.value?[r.state.value]:[]};o.applyFilters(l,{forceUpdate:!0,notify:!1}),s.sort("related",{metric:e})})),this._subs.add(this.subscribeToEvent(Q.W,r=>{const{searchText:n}=r.payload;for(const[,{filterEngine:r,sortEngine:a}]of t)r.applyFilters({names:n?[n]:[]}),a.sort("related",{metric:e})})),this._subs.add(this.subscribeToEvent(ne.Y,r=>{const{type:n,filters:a}=r.payload;for(const[,{filterEngine:r,sortEngine:i}]of t)r.applyFilters({[n]:a}),i.sort("related",{metric:e})}))}constructor({metric:e}){super({metric:e,$variables:new a.Pj({variables:[new ee.s,new X.V]}),key:"RelatedMetricsScene",body:new K.Qs({variableName:X.h}),listControls:new me({})}),this.addActivationHandler(this.onActivate.bind(this))}}function be(e){return{body:(0,s.css)({}),list:(0,s.css)({}),listControls:(0,s.css)({margin:e.spacing(1,0,1.5,0)}),variables:(0,s.css)({display:"none"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(ge,"Component",({model:e})=>{const t=(0,l.useStyles2)(be),{$variables:r,body:n,listControls:a}=e.useState();return o().createElement(o().Fragment,null,o().createElement("div",{className:t.listControls},o().createElement(a.Component,{model:a})),o().createElement("div",{className:t.body},o().createElement("div",{className:t.list,"data-testid":"panels-list"},o().createElement(n.Component,{model:n}))),o().createElement("div",{className:t.variables},null==r?void 0:r.state.variables.map(e=>o().createElement(e.Component,{key:e.state.name,model:e}))))});var ye=r(4137);const ve=I.COPY_URL_LABEL,we=({trail:e})=>{const[t,r]=(0,i.useState)(ve);return o().createElement(l.ToolbarButton,{variant:"canvas",icon:"share-alt",tooltip:t,onClick:()=>{if(navigator.clipboard){(0,R.z)("selected_metric_action_clicked",{action:"share_url"});const t=`${n.config.appUrl.endsWith("/")?n.config.appUrl.slice(0,-1):n.config.appUrl}${ye.Gy}/${(0,h.xi)(e)}`;navigator.clipboard.writeText(t),r("Copied!"),setTimeout(()=>{r(ve)},2e3)}}})};var Se=r(2425);var Oe=r(6944),ke=r(1625),Ee=r(3241),xe=r(7630),je=r(1932),Pe=r(7437);const Ce=`${f.Rp}{${f.ui}}`,_e=`rate(${Ce}[$__rate_interval])`,Ne=`{"${f.Rp}", ${f.ui}}`,Le=`rate(${Ne}[$__rate_interval])`;function Be({isRateQuery:e=!1,groupings:t=[],isUtf8Metric:r=!1}){let n;return n=r?e?Le:Ne:e?_e:Ce,t.length>0?`sum by(${t.join(", ")}) (${n})`:`${n}`}var De=r(5938);function Ae({title:e,unit:t}){return a.d0.timeseries().setTitle(e).setUnit(t).setOption("legend",{showLegend:!1}).setOption("tooltip",{mode:ke.$N.Multi,sort:ke.xB.Descending}).setCustomFieldConfig("fillOpacity",9)}function Te(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function $e(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Te(e,t,r[t])})}return e}function Me(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function Ve({description:e,mainQueryExpr:t,breakdownQueryExpr:r,unit:n}){const a={title:f.Rp,unit:n},i={refId:"A",expr:t,legendFormat:e,fromExploreMetrics:!0},o=Me($e({},a),{title:e,queries:[i],variant:"main",vizBuilder:()=>Ae($e({},o))}),s=Me($e({},a),{queries:[Me($e({},i),{legendFormat:e})],vizBuilder:()=>Ae(s),variant:"preview"}),l=Me($e({},a),{queries:[{refId:"A",expr:r,legendFormat:`{{${f.aZ}}}`,fromExploreMetrics:!0}],vizBuilder:()=>Ae(l),variant:"breakdown"});return{preview:s,main:o,breakdown:l,variants:[]}}const Fe=new Set(["count","total"]),Ie={count:"sum",total:"sum"},Re={avg:"average",sum:"overall"};function He(e){const{metricParts:t,suffix:r,isUtf8Metric:n}=e,a="total"===r?t.at(-2):r,i=Fe.has(r),o=Ie[r]||"avg",s=i?(0,Pe.MM)(a):(0,Pe.l_)(a),l=Be({isRateQuery:i,isUtf8Metric:n}),c=`${u=o,Re[u]||u}${i?" per-second rate":""}`;var u;return Ve({description:`${f.Rp} (${c})`,mainQueryExpr:`${o}(${l})`,breakdownQueryExpr:`${o}(${l})by(${f.aZ})`,unit:s})}function ze(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ue(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){ze(e,t,r[t])})}return e}function qe(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function Ge(e){const{unit:t,nativeHistogram:r}=e,n={title:f.Rp,unit:t},i=qe(Ue({},n),{variant:"p50",queries:[Qe(e,50)],vizBuilder:()=>Ae(i)}),o=qe(Ue({},n),{variant:"p50",queries:[Qe(e,50,[f.aZ])],vizBuilder:()=>Ae(o)}),s=qe(Ue({},n),{variant:"percentiles",queries:[99,90,50].map(t=>Qe(e,t)),vizBuilder:()=>function({title:e,unit:t}){return a.d0.timeseries().setTitle(e).setUnit(t).setCustomFieldConfig("fillOpacity",9).setOption("tooltip",{mode:ke.$N.Multi,sort:ke.xB.Descending}).setOption("legend",{showLegend:!1})}(s)}),l=qe(Ue({},n),{variant:"heatmap",queries:[{refId:"Heatmap",expr:Be({isRateQuery:!0,isUtf8Metric:e.isUtf8Metric,groupings:r?[]:["le"]}),fromExploreMetrics:!0,format:"heatmap"}],vizBuilder:()=>function({title:e,unit:t}){return a.d0.heatmap().setTitle(e).setUnit(t).setOption("calculate",!1).setOption("color",{mode:De.P7.Scheme,exponent:.5,scheme:"Spectral",steps:32,reverse:!1})}(l)});return{preview:l,main:l,variants:[s,l],breakdown:o}}function Qe(e,t,r=[]){const n=t/100;let a=`${t}th Percentile`;r[0]&&(a=`{{${r[0]}}}`);return{refId:`Percentile${t}`,expr:`histogram_quantile(${n}, ${Be({isRateQuery:!0,isUtf8Metric:e.isUtf8Metric,groupings:e.nativeHistogram?[...r]:["le",...r]})})`,legendFormat:a,fromExploreMetrics:!0}}function We(e,t){return`${e.replace(f.Rp,`${t}_sum`)}/${e.replace(f.Rp,`${t}_count`)}`}function Ke(e,t){const r=!(0,je.Rq)(e),n=e.split("_"),a=n.at(-1);if(null==a)throw new Error(`This function does not support a metric suffix of "${a}"`);const i=n.at(-2),o={metricParts:n,isUtf8Metric:r,suffix:a,unitSuffix:i,unit:(0,Pe.l_)(i),nativeHistogram:t};return"sum"===a?function(e){const{metricParts:t,isUtf8Metric:r,unit:n}=e,a=t.slice(0,-1).join("_"),i=`${a} (average)`,o=Be({isRateQuery:!0,isUtf8Metric:r});return Ve({description:i,mainQueryExpr:We(`sum(${o})`,a),breakdownQueryExpr:We(`sum(${o})by(${f.aZ})`,a),unit:n})}(o):"bucket"===a||t?Ge(o):He(o)}function Ye({options:e,value:t,onChange:r}){const n=(0,l.useStyles2)(Je);return o().createElement("div",{className:n.select,"data-testid":"breakdown-label-selector"},o().createElement(l.Combobox,{options:e.map(e=>({label:e.label||"",value:e.value||""})),value:t||"",onChange:e=>r(null==e?void 0:e.value),width:16}))}function Je(e){return{select:(0,s.css)({maxWidth:e.spacing(16)})}}var Ze=r(384);function Xe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class et extends a.Bs{constructor(...e){super(...e),Xe(this,"onClick",()=>{var e;const t=a.jh.lookupVariable("filters",this);if(!(0,Ze.BE)(t))return;var r;const n=null!==(r=null===(e=this.state.frame.fields[1])||void 0===e?void 0:e.labels)&&void 0!==r?r:{};if(1!==Object.keys(n).length)return;const i=Object.keys(n)[0];(0,R.z)("label_filter_changed",{label:i,action:"added",cause:"breakdown"});const o=(0,h.kj)(this),s={key:i,operator:"=",value:n[i]};o.addFilterWithoutReportingInteraction(s)})}}function tt(e,t){function r(e){return e instanceof t}return a.jh.findAllObjects(e,r).filter(r)}Xe(et,"Component",({model:e})=>{var t;const r=(null===(t=e.useState().frame.fields[1])||void 0===t?void 0:t.labels)||{};return 0!==Object.keys(r).length?o().createElement(l.Button,{variant:"secondary",size:"sm",fill:"outline",onClick:e.onClick},"Add to filters"):null});var rt=r(5570),nt=r(7993);const at=new nt.A({intraMode:1,intraIns:1,intraSub:1,intraTrn:1,intraDel:1});function it(e,t,r){const[n,a,i]=at.search(e,t,0,1e5);let o=[],s=new Set;if(n&&i){const t=(e,t)=>{t&&s.add(e)};for(let r=0;r<i.length;r++){let n=i[r];nt.A.highlight(e[a.idx[n]],a.ranges[n],t),o.push(e[a.idx[n]])}r([o,[...s]])}else t||r([])}(0,Ee.debounce)(it,300);var ot=r(2601);function st(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function lt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){st(e,t,r[t])})}return e}function ct(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function ut(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}class dt extends a.Bs{performRepeat(e){const t=[],r=(0,ot.sortSeries)(e.series,this.sortBy);for(let n=0;n<r.length;n++){const a=this.state.getLayoutChild(e,r[n],n);t.push(a)}this.sortedSeries=r,this.unfilteredChildren=t,this.getFilter()?(this.state.body.setState({children:[]}),this.filterByString(this.getFilter())):this.state.body.setState({children:t})}constructor(e){var{sortBy:t,getFilter:r}=e;super(ut(e,["sortBy","getFilter"])),st(this,"unfilteredChildren",[]),st(this,"sortBy",void 0),st(this,"sortedSeries",[]),st(this,"getFilter",void 0),st(this,"sort",e=>{const t=a.jh.getData(this);this.sortBy=e,t.state.data&&this.performRepeat(t.state.data)}),st(this,"filterByString",e=>{let t=[];this.iterateFrames((e,r)=>{const n=ht(e[r]);t.push(n)}),it(t,e,e=>{e&&e[0]?this.filterFrames(t=>{const r=ht(t);return e[0].includes(r)}):this.filterFrames(()=>!0)})}),st(this,"iterateFrames",e=>{if(a.jh.getData(this).state.data)for(let t=0;t<this.sortedSeries.length;t++)e(this.sortedSeries,t)}),st(this,"filterFrames",e=>{const t=[];var r,n;this.iterateFrames((r,n)=>{e(r[n])&&t.push(this.unfilteredChildren[n])}),0===t.length?this.state.body.setState({children:[(r=this.getFilter(),n=this.clearFilter,new a.G1({direction:"row",children:[new a.vA({body:new a.dM({reactNode:o().createElement("div",{className:pt.alertContainer},o().createElement(l.Alert,{title:"",severity:"info",className:pt.noResultsAlert},"No values found matching: ",r,o().createElement(l.Button,{className:pt.clearButton,onClick:n},"Clear filter")))})})]}))]}):this.state.body.setState({children:t})}),st(this,"clearFilter",()=>{this.publishEvent(new vt,!0)}),this.sortBy=t,this.getFilter=r,this.addActivationHandler(()=>{const e=a.jh.getData(this);this._subs.add(e.subscribeToState((e,t)=>{var r,n;if(void 0===e.data)return;const i=e.data;(null===(r=e.data)||void 0===r?void 0:r.state)!==(null===(n=t.data)||void 0===n?void 0:n.state)&&tt(this,a.Zv).forEach(e=>{e.setState({data:ct(lt({},e.state.data),{state:i.state})})}),i.state===H.LoadingState.Done&&this.performRepeat(i)})),e.state.data&&this.performRepeat(e.state.data)})}}st(dt,"Component",({model:e})=>{const{body:t}=e.useState();return o().createElement(t.Component,{model:t})});const pt={alertContainer:(0,s.css)({flexGrow:1,display:"flex",justifyContent:"center",alignItems:"center"}),noResultsAlert:(0,s.css)({minWidth:"30vw",flexGrow:0}),clearButton:(0,s.css)({marginLeft:"1.5rem"})};function ht(e){var t;return null!==(t=(0,rt.H)(e))&&void 0!==t?t:"No labels"}function mt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ft(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}const gt=e=>{var{value:t,onChange:r,placeholder:n,onClear:a}=e,i=ft(e,["value","onChange","placeholder","onClear"]);return o().createElement(l.Input,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){mt(e,t,r[t])})}return e}({value:t,onChange:r,suffix:t?o().createElement(l.Icon,{onClick:a,title:"Clear search",name:"times",className:bt.clearIcon}):void 0,prefix:o().createElement(l.Icon,{name:"search"}),placeholder:n},i))},bt={clearIcon:(0,s.css)({cursor:"pointer"})};function yt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class vt extends H.BusEventBase{}yt(vt,"type","breakdown-search-reset");const wt={};class St extends a.Bs{filterValues(e){if(this.parent instanceof er){wt[this.cacheKey]=e;const t=this.parent.state.body;null==t||t.forEachChild(t=>{t instanceof dt&&t.state.body.isActive&&t.filterByString(e)})}}constructor(e){var t;super({filter:null!==(t=wt[e])&&void 0!==t?t:""}),yt(this,"cacheKey",void 0),yt(this,"onValueFilterChange",e=>{this.setState({filter:e.target.value}),this.filterValues(e.target.value)}),yt(this,"clearValueFilter",()=>{this.setState({filter:""}),this.filterValues("")}),yt(this,"reset",()=>{this.setState({filter:""}),wt[this.cacheKey]=""}),this.cacheKey=e}}function Ot(e,t){var r;const n=(null!==(r=localStorage.getItem(`${f.I1}.${e}.by`))&&void 0!==r?r:"").split(".");return n[0]&&n[1]?{sortBy:n[0],direction:n[1]}:{sortBy:t}}yt(St,"Component",({model:e})=>{const{filter:t}=e.useState();return o().createElement(gt,{value:t,onChange:e.onValueFilterChange,onClear:e.clearValueFilter,placeholder:"Search for value"})});const kt=["single","grid","rows"];function Et(e){return kt.includes(e)}function xt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class jt extends a.Bs{getUrlState(){return{breakdownLayout:this.state.activeBreakdownLayout}}updateFromUrl(e){const t=e.breakdownLayout;"string"==typeof t&&Et(t)&&this.state.activeBreakdownLayout!==t&&this.setState({activeBreakdownLayout:t})}Selector({model:e}){const{activeBreakdownLayout:t,breakdownLayoutOptions:r}=e.useState();return o().createElement(l.RadioButtonGroup,{"aria-label":"Layout switcher",options:r,value:t,onChange:e.onLayoutChange})}constructor(e){const t=null!==(r=localStorage.getItem(f.Pp))&&void 0!==r?r:"grid";var r;super(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){xt(e,t,r[t])})}return e}({activeBreakdownLayout:Et(t)?t:"grid"},e)),xt(this,"_urlSync",new a.So(this,{keys:["breakdownLayout"]})),xt(this,"onLayoutChange",e=>{this.state.activeBreakdownLayout!==e&&((0,R.z)("breakdown_layout_changed",{layout:e}),function(e){localStorage.setItem(f.Pp,null!=e?e:"grid")}(e),this.setState({activeBreakdownLayout:e}),this.state.onBreakdownLayoutChange(e))})}}function Pt(e){return{container:(0,s.css)({display:"flex",flexDirection:"row",flexGrow:1,paddingTop:e.spacing(0)})}}function Ct(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}xt(jt,"Component",({model:e})=>{const{breakdownLayouts:t,breakdownLayoutOptions:r,activeBreakdownLayout:n}=e.useState(),a=(0,l.useStyles2)(Pt),i=r.findIndex(e=>e.value===n);if(-1===i)return null;const s=t[i];return o().createElement("div",{className:a.container},o().createElement(s.Component,{model:s}))});class _t extends H.BusEventBase{constructor(e,t){super(),Ct(this,"target",void 0),Ct(this,"sortBy",void 0),this.target=e,this.sortBy=t}}Ct(_t,"type","sort-criteria-changed");const Nt=[{value:"outliers",label:"Outlying series",description:"Prioritizes values that show distinct behavior from others within the same label"},{value:"alphabetical",label:"Name [A-Z]",description:"Alphabetical order"},{value:"alphabetical-reversed",label:"Name [Z-A]",description:"Reversed alphabetical order"}];class Lt extends a.Bs{constructor(e){const{sortBy:t}=Ot(e.target,"outliers");super({target:e.target,sortBy:t}),Ct(this,"onCriteriaChange",e=>{(null==e?void 0:e.value)&&(this.setState({sortBy:e.value}),function(e,t){t&&localStorage.setItem(`${f.I1}.${e}.by`,`${t}`)}(this.state.target,e.value),this.publishEvent(new _t(this.state.target,e.value),!0))})}}function Bt(e){return{sortByTooltip:(0,s.css)({display:"flex",gap:e.spacing(1)})}}Ct(Lt,"Component",({model:e})=>{const t=(0,l.useStyles2)(Bt),{sortBy:r}=e.useState(),n=Nt.find(e=>e.value===r);return o().createElement(l.Field,{htmlFor:"sort-by-criteria",label:o().createElement("div",{className:t.sortByTooltip},"Sort by",o().createElement(l.IconButton,{name:"info-circle",size:"sm",variant:"secondary",tooltip:"Sorts values using standard or smart time series calculations."}))},o().createElement(l.Combobox,{id:"sort-by-criteria",value:n,width:20,options:Nt,placeholder:"Choose criteria",onChange:e.onCriteriaChange,isClearable:!1}))});class Dt extends H.BusEventWithPayload{}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Dt,"type","selected-metric-query-results-event");const At=e=>{const t=a.jh.getAncestor(e,er);function r(e){e&&(e.isActive||e.addActivationHandler(()=>{r(e)}),e.state.data&&t.reportBreakdownPanelData(e.state.data),e.subscribeToState(({data:e})=>{t.reportBreakdownPanelData(e)}))}tt(e,a.Eb).forEach(e=>{e.isActive?r(e.state.$data):e.addActivationHandler(()=>{r(e.state.$data)})}),tt(e,a.Eb).forEach(e=>r(e.state.$data));const n=t.subscribeToEvent(Dt,t=>{if(!e.isActive)return void n.unsubscribe();const r=a.No.timeseries().setCustomFieldConfig("axisSoftMin",t.payload.min).setCustomFieldConfig("axisSoftMax",t.payload.max).build();tt(e,a.Eb).forEach(e=>{function t(){e.onFieldConfigChange(r)}e.isActive?t():e.addActivationHandler(t)})})},Tt="$__all";function $t({blockingMessage:e,isLoading:t,children:r}){const n=(0,l.useStyles2)(Mt);return t&&!e&&(e="Loading..."),t?o().createElement(l.LoadingPlaceholder,{className:n.statusMessage,text:e}):e?o().createElement("div",{className:n.statusMessage},e):o().createElement(o().Fragment,null,r)}function Mt(e){return{statusMessage:(0,s.css)({fontStyle:"italic",marginTop:e.spacing(7),textAlign:"center",width:"100%"})}}var Vt=r(6503);class Ft extends H.BusEventWithPayload{}function It(){return e=>{let t=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY;const n=a.jh.getTimeRange(e).subscribeToState(()=>{t=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY}),i=e.subscribeToEvent(Ft,n=>{const i=n.payload.series||[];let o=t,s=r;for(const e of i){var l;const t=null===(l=e.fields[1])||void 0===l?void 0:l.values.filter(Boolean);t&&(o=Math.max(o,...t),s=Math.min(s,...t))}o===s||o===Number.NEGATIVE_INFINITY||s===Number.POSITIVE_INFINITY||o===t&&s===r||([t,r]=[o,s],function(e,t,r){const n=a.jh.findAllObjects(e,e=>e instanceof a.Eb&&"timeseries"===e.state.pluginId);for(const e of n)e.clearFieldConfigCache(),e.setState({fieldConfig:(0,Ee.merge)((0,Ee.cloneDeep)(e.state.fieldConfig),{defaults:{min:r,max:t}})})}(e,t,r))});return()=>{i.unsubscribe(),n.unsubscribe()}}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Ft,"type","timeseries-data-received");var Rt=r(2024);const Ht=()=>e=>e.pipe((0,u.map)(e=>null==e?void 0:e.map((e,t)=>(e.refId=`${e.refId}-${t}`,e))));function zt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ut="seriesCount",qt=(e,t)=>()=>r=>r.pipe((0,u.map)(r=>null==r?void 0:r.slice(e,t).map(e=>{var t;return e.meta=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){zt(e,t,r[t])})}return e}({},e.meta),(t=e.meta).stats||(t.stats=[]),e.meta.stats.unshift({displayName:Ut,value:r.length}),e})));const Gt="220px";class Qt extends a.Bs{static buildVizPanel({metric:e,label:t,query:r,unit:n}){const i=new a.Es({$data:new a.dt({datasource:f.GH,maxDataPoints:f.up,queries:[{refId:`${e}-${t}`,expr:r,legendFormat:`{{${t}}}`,fromExploreMetrics:!0}]}),transformations:[qt(0,20),Ht]});return a.d0.timeseries().setTitle(t).setUnit(n).setData(i).setBehaviors([e=>{e.state.$data.subscribeToState((t,r)=>{var n,a,i;(null===(n=t.data)||void 0===n?void 0:n.state)===H.LoadingState.Done&&(null===(a=t.data)||void 0===a?void 0:a.series)!==(null===(i=r.data)||void 0===i?void 0:i.series)&&e.publishEvent(new Ft({series:t.data.series}),!0)})}]).setOption("tooltip",{mode:l.TooltipDisplayMode.Multi,sort:ke.xB.Descending}).setHeaderActions([new ar({labelName:t})]).setMenu(new L({labelName:t})).setShowMenuAlways(!0).build()}onActivate(){const{body:e}=this.state;this._subs.add(e.state.$data.subscribeToState(t=>{var r;if((null===(r=t.data)||void 0===r?void 0:r.state)!==H.LoadingState.Done)return;const{series:n}=t.data;if(null==n?void 0:n.length){const t=this.getAllValuesConfig(n);e.setState((0,Ee.merge)({},e.state,t))}}))}getAllValuesConfig(e){var t,r;const{label:n}=this.state,a=null===(r=e[0].meta)||void 0===r||null===(t=r.stats)||void 0===t?void 0:t.find(e=>e.displayName===Ut),i=a?a.value:e.length;return{title:`${n} (${i})`,description:e.length<i?`Showing only ${e.length} series out of ${i} to keep the data easy to read. Click on "Select" on this panel to view a breakdown of all the "${n}" label's values.`:"",fieldConfig:{overrides:this.getOverrides(e)}}}getOverrides(e){const{label:t,startColorIndex:r}=this.state;return e.map((e,n)=>{var a,i;return{matcher:{id:H.FieldMatcherID.byFrameRefID,options:e.refId},properties:[{id:"displayName",value:(null===(i=e.fields[1])||void 0===i||null===(a=i.labels)||void 0===a?void 0:a[t])||`<unspecified ${t}>`},{id:"color",value:{mode:"fixed",fixedColor:(0,h.Vy)(r+n)}}]}})}constructor({metric:e,label:t,query:r,unit:n,startColorIndex:a}){super({key:`label-viz-panel-${t}`,metric:e,label:t,query:r,unit:n,startColorIndex:a,body:Qt.buildVizPanel({metric:e,label:t,query:r,unit:n})}),this.addActivationHandler(this.onActivate.bind(this))}}function Wt(){return{container:(0,s.css)({height:Gt})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Qt,"Component",({model:e})=>{const{body:t}=e.useState(),r=(0,l.useStyles2)(Wt);return o().createElement("div",{className:r.container},o().createElement(t.Component,{model:t}))});class Kt extends a.Bs{onActivate(){this.subscribeToLayoutChange()}subscribeToLayoutChange(){const e=a.jh.findByKeyAndType(this,"layout-switcher",ae.U),t=this.state.body.state.body,r=(e,r)=>{e.layout!==(null==r?void 0:r.layout)&&t.setState({templateColumns:e.layout===ae.p.ROWS?K._O:K.MV})};r(e.state),this._subs.add(e.subscribeToState(r))}Selector({model:e}){const{layoutSwitcher:t}=e.useState();return o().createElement(t.Component,{model:t})}constructor({metric:e}){const t=Ke(e).breakdown,{expr:r}=t.queries[0],n=t.unit;super({key:"metric-labels-list",metric:e,layoutSwitcher:new ae.U,body:new oe.k({variableName:f.yr,initialPageSize:60,pageSizeIncrement:9,body:new a.gF({children:[],isLazy:!0,templateColumns:K.MV,autoRows:Gt,$behaviors:[new a.Gg.K2({key:"metricCrosshairSync",sync:H.DashboardCursorSync.Crosshair}),It()]}),getLayoutLoading:()=>new a.dM({reactNode:o().createElement(l.Spinner,{inline:!0})}),getLayoutEmpty:()=>new a.dM({reactNode:o().createElement(Vt._,{title:"",severity:"info"},"No labels found for the current filters and time range.")}),getLayoutError:e=>new a.dM({reactNode:o().createElement(Vt._,{severity:"error",title:"Error while loading labels!",error:e})}),getLayoutChild:(t,i)=>{const o=r.replaceAll(f.aZ,(0,je.Nc)(String(t.value)));return new a.xK({body:new Qt({metric:e,label:t.value,query:o,unit:n,startColorIndex:i})})}})}),this.addActivationHandler(this.onActivate.bind(this))}}function Yt(e){return{container:(0,s.css)({width:"100%"}),footer:(0,s.css)({display:"flex",justifyContent:"center",alignItems:"center",marginTop:e.spacing(4),"& button":{height:"40px",borderRadius:"8px"}})}}function Jt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Zt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Jt(e,t,r[t])})}return e}function Xt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Kt,"Component",({model:e})=>{const{body:t}=e.useState(),r=(0,l.useStyles2)(Yt),n=a.jh.lookupVariable(f.yr,e),{loading:i,error:s}=n.useState(),c=t.useSizes(),u=!i&&!s&&c.total>0&&c.current<c.total;return o().createElement("div",{"data-testid":"labels-list"},o().createElement("div",{className:r.container},o().createElement(t.Component,{model:t})),u&&o().createElement("div",{className:r.footer},o().createElement(Rt.d,{label:"label",batchSizes:c,onClick:()=>{t.increaseBatchSize()}})))});class er extends a.Bs{_onActivate(){var e;(0,Oe.default)().then(()=>d.v.debug("Grafana ML initialized"));const t=this.getVariable();n.config.featureToggles.enableScopesInMetricsExplore&&this._subs.add(this.subscribeToEvent(f.H0,()=>{this.updateBody(this.getVariable())})),t.subscribeToState((e,r)=>{e.options===r.options&&e.value===r.value&&e.loading===r.loading||this.updateBody(t)}),this._subs.add(this.subscribeToEvent(vt,()=>{this.state.search.clearValueFilter()})),this._subs.add(this.subscribeToEvent(_t,this.handleSortByChange));const r=a.jh.getAncestor(this,Vr).state.metric;this._query=Ke(r).breakdown;null===(e=(0,h.kj)(this).state.$timeRange)||void 0===e||e.subscribeToState(()=>{this.clearBreakdownPanelAxisValues()}),this.updateBody(t)}reportBreakdownPanelData(e){if(!e)return;let t=this.breakdownPanelMinValue,r=this.breakdownPanelMaxValue;e.series.forEach(e=>{e.fields.forEach(e=>{if(e.type!==H.FieldType.number)return;const n=e.values.filter(Ee.isNumber),a=(0,Ee.max)(n),i=(0,Ee.min)(n);r=(0,Ee.max)([r,a].filter(Ee.isNumber)),t=(0,Ee.min)([t,i].filter(Ee.isNumber))})}),void 0!==r&&void 0!==t&&Number.isFinite(r+t)&&(this.breakdownPanelMaxValue===r&&this.breakdownPanelMinValue===t||(this.breakdownPanelMaxValue=r,this.breakdownPanelMinValue=t,this._triggerAxisChangedEvent()))}clearBreakdownPanelAxisValues(){this.breakdownPanelMaxValue=void 0,this.breakdownPanelMinValue=void 0}getVariable(){const e=a.jh.lookupVariable(f.yr,this);if(!(0,Ze.bA)(e))throw new Error("Group by variable not found");return e}onReferencedVariableValueChanged(){const e=this.getVariable();e.changeValueTo(Tt),this.updateBody(e)}updateBody(e){const t=function(e,t){const r=a.jh.lookupVariable(f.Ao,e),n=[];if(!(0,Ze.BE)(r))return[];const i=r.state.filters;for(const e of t.getOptionsForSelect()){const t=i.find(t=>t.key===e.value);"le"!==e.label&&(t||n.push({label:e.label,value:String(e.value)}))}return n}(this,e),r={loading:e.state.loading,value:String(e.state.value),labels:t,error:e.state.error,blockingMessage:void 0};if(!e.state.loading&&e.state.options.length){const t=a.jh.getAncestor(this,Vr);r.body=e.hasAllValue()?new Kt({metric:t.state.metric}):function(e,t,r){const n=e.unit;function i(t,r,i){const o=e.vizBuilder().setTitle(nr(r)).setData(new a.Zv({data:Xt(Zt({},t),{series:[r]})})).setColor({mode:"fixed",fixedColor:(0,h.Vy)(i)}).setHeaderActions([new et({frame:r})]).setShowMenuAlways(!0).setMenu(new L({labelName:nr(r)})).setUnit(n).build(),s=r.length<=1;return new a.xK({$behaviors:[At],body:o,isHidden:s})}const{sortBy:s}=Ot("labels","outliers"),c=()=>{var e;return null!==(e=r.state.filter)&&void 0!==e?e:""};return new jt({$data:new a.dt({datasource:f.GH,maxDataPoints:f.up,queries:e.queries}),breakdownLayoutOptions:[{value:"single",label:"Single"},{value:"grid",label:"Grid"},{value:"rows",label:"Rows"}],onBreakdownLayoutChange:t,breakdownLayouts:[new a.G1({direction:"column",children:[new a.vA({minHeight:300,body:a.d0.timeseries().setOption("tooltip",{mode:ke.$N.Multi,sort:ke.xB.Descending}).setOption("legend",{showLegend:!1}).setTitle("$metric").build()})]}),new dt({body:new a.gF({templateColumns:rr,autoRows:xe.tw,children:[new a.vA({body:new a.dM({reactNode:o().createElement(l.LoadingPlaceholder,{text:"Loading..."})})})]}),getLayoutChild:i,sortBy:s,getFilter:c}),new dt({body:new a.gF({templateColumns:"1fr",autoRows:xe.tw,children:[]}),getLayoutChild:i,sortBy:s,getFilter:c})]})}(this._query,this.onBreakdownLayoutChange,this.state.search)}else e.state.loading||(r.body=void 0,r.blockingMessage="There are no labels found for this metric.");this.clearBreakdownPanelAxisValues(),this.setState(r)}constructor(e){var t;super(Xt(Zt({},e),{labels:null!==(t=e.labels)&&void 0!==t?t:[],sortBy:new Lt({target:"labels"}),search:new St("labels")})),Jt(this,"_variableDependency",new a.Sh(this,{variableNames:[f.Ao],onReferencedVariableValueChanged:this.onReferencedVariableValueChanged.bind(this)})),Jt(this,"_query",void 0),Jt(this,"breakdownPanelMaxValue",void 0),Jt(this,"breakdownPanelMinValue",void 0),Jt(this,"_triggerAxisChangedEvent",(0,Ee.throttle)(()=>{const{breakdownPanelMinValue:e,breakdownPanelMaxValue:t}=this;void 0!==e&&void 0!==t&&this.publishEvent(new Dt({min:e,max:t}))},1e3)),Jt(this,"handleSortByChange",e=>{"labels"===e.target&&((0,R.z)("sorting_changed",{from:"label-breakdown",sortBy:e.sortBy}),this.state.body instanceof jt&&this.state.body.state.breakdownLayouts.forEach(t=>{t instanceof dt&&t.sort(e.sortBy)}))}),Jt(this,"onBreakdownLayoutChange",()=>{this.clearBreakdownPanelAxisValues()}),Jt(this,"onChange",e=>{if(!e)return;(0,R.z)("label_selected",{label:e,cause:"selector"});this.getVariable().changeValueTo(e)}),this.addActivationHandler(this._onActivate.bind(this))}}function tr(e){return{container:(0,s.css)({flexGrow:1,display:"flex",minHeight:"100%",flexDirection:"column",paddingTop:e.spacing(1)}),searchField:(0,s.css)({flexGrow:1}),controls:(0,s.css)({flexGrow:0,display:"flex",alignItems:"flex-end",gap:e.spacing(2),justifyContent:"space-between"})}}Jt(er,"Component",({model:e})=>{const{labels:t,body:r,search:n,sortBy:a,loading:i,value:s,blockingMessage:c}=e.useState(),u=(0,l.useStyles2)(tr);return o().createElement("div",{className:u.container},o().createElement($t,{isLoading:i,blockingMessage:c},o().createElement("div",{className:u.controls},!i&&t.length>0&&o().createElement(l.Field,{label:"By label"},o().createElement(Ye,{options:t,value:s,onChange:e.onChange})),s!==Tt&&o().createElement(o().Fragment,null,o().createElement(l.Field,{label:"Search",className:u.searchField},o().createElement(n.Component,{model:n})),o().createElement(a.Component,{model:a})),r instanceof jt&&o().createElement(l.Field,{label:"View"},o().createElement(r.Selector,{model:r})),r instanceof Kt&&o().createElement(l.Field,{label:"View"},o().createElement(r.Selector,{model:r}))),o().createElement("div",{"data-testid":"panels-list"},r instanceof jt&&o().createElement(r.Component,{model:r}),r instanceof Kt&&o().createElement(r.Component,{model:r}))))});const rr="repeat(auto-fit, minmax(400px, 1fr))";function nr(e){var t;const r=(null===(t=e.fields[1])||void 0===t?void 0:t.labels)||{},n=Object.keys(r);return 0===n.length?"<unspecified>":r[n[0]]}class ar extends a.Bs{constructor(...e){super(...e),Jt(this,"onClick",()=>{const e=this.state.labelName;(0,R.z)("label_selected",{label:e,cause:"breakdown_panel"}),ir(this).onChange(e)})}}function ir(e){if(e instanceof er)return e;if(e.parent)return ir(e.parent);throw new Error("Unable to find breakdown scene")}function or(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function sr(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){or(i,n,a,o,s,"next",e)}function s(e){or(i,n,a,o,s,"throw",e)}o(void 0)})}}function lr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Jt(ar,"Component",({model:e})=>o().createElement(l.Button,{variant:"secondary",size:"sm",fill:"outline",onClick:e.onClick},"Select"));const cr="breakdown",ur="logs",dr=[{displayName:"Breakdown",value:cr,getScene:()=>new er({})},{displayName:"Related metrics",value:"related",getScene:e=>new ge({metric:e.state.metric}),description:"Relevant metrics based on current label filters"},{displayName:"Related logs",value:ur,getScene:e=>e.createRelatedLogsScene(),description:"Relevant logs based on current label filters and time range"}];class pr extends a.Bs{constructor(...e){var t;super(...e),lr(t=this,"getLinkToExplore",()=>sr(function*(){const e=a.jh.getAncestor(t,Vr),r=a.jh.findByKeyAndType(t,U,F),n=void 0!==r.state.panel?a.jh.getData(r.state.panel).state.data:void 0;if(!n)throw new Error("Cannot get link to explore, no panel data found");return(0,a.pN)(n,e,n.timeRange)})()),lr(t,"openExploreLink",()=>sr(function*(){(0,R.z)("selected_metric_action_clicked",{action:"open_in_explore"}),t.getLinkToExplore().then(e=>{window.open(e,"_blank")})})())}}function hr(e){return{actions:(0,s.css)({[e.breakpoints.up(e.breakpoints.values.md)]:{position:"absolute",right:0,top:16,zIndex:2}}),customTabsBar:(0,s.css)({paddingBottom:e.spacing(1)})}}lr(pr,"Component",({model:e})=>{const t=a.jh.getAncestor(e,Vr),r=(0,l.useStyles2)(hr),n=(0,h.kj)(e),[s,c]=function(e){const t=()=>(0,Se._r)().getBookmarkIndex(e),r=t(),[n,o]=(0,i.useState)(r);(0,i.useEffect)(()=>{const t=e.subscribeToEvent(a.bZ,()=>{o((0,Se._r)().getBookmarkIndex(e))});return()=>t.unsubscribe()},[e]),r!==n&&o(r);const s=null!=n;return[s,()=>{if((0,R.z)("bookmark_changed",{action:s?"toggled_off":"toggled_on"}),s){let e=t();for(;null!=e;)(0,Se._r)().removeBookmark(e),e=t()}else(0,Se._r)().addBookmark(e);o(t())}]}(n),{actionView:u}=t.useState();return o().createElement(l.Box,{paddingY:1,"data-testid":"action-bar"},o().createElement("div",{className:r.actions},o().createElement(l.Stack,{gap:1},o().createElement(l.ToolbarButton,{variant:"canvas",tooltip:I.SELECT_NEW_METRIC_TOOLTIP,onClick:()=>{(0,R.z)("selected_metric_action_clicked",{action:"unselect"}),n.publishEvent(new f.OO(void 0))}},"Select new metric"),o().createElement(l.ToolbarButton,{variant:"canvas",icon:"compass",tooltip:I.OPEN_EXPLORE_LABEL,onClick:e.openExploreLink}),o().createElement(we,{trail:n}),o().createElement(l.ToolbarButton,{variant:"canvas",icon:s?o().createElement(l.Icon,{name:"favorite",type:"mono",size:"lg"}):o().createElement(l.Icon,{name:"star",type:"default",size:"lg"}),tooltip:I.BOOKMARK_LABEL,onClick:c}),n.state.embedded&&o().createElement(l.LinkButton,{href:(0,h.xi)(n),variant:"secondary",onClick:()=>(0,R.z)("selected_metric_action_clicked",{action:"open_from_embedded"})},"Open"))),o().createElement(l.TabsBar,{className:r.customTabsBar},dr.map((e,r)=>{const n=e.displayName,a=e.value===ur?t.state.relatedLogsCount:void 0,i=u===e.value,s=o().createElement(l.Tab,{key:r,label:n,counter:a,active:i,onChangeTab:()=>{i||((0,R.z)("metric_action_view_changed",{view:e.value,related_logs_count:t.relatedLogsOrchestrator.checkConditionsMetForRelatedLogs()?a:void 0}),t.setActionView(e.value))}});return e.description?o().createElement(l.Tooltip,{key:r,content:e.description,placement:"top",theme:"info"},s):s})))});var mr=r(7476);function fr(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function gr(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){fr(i,n,a,o,s,"next",e)}function s(e){fr(i,n,a,o,s,"throw",e)}o(void 0)})}}const br={job:"service_name",instance:"service_instance_id"};function yr(e){return e in br?br[e]:e}const vr=e=>{let t=!1;return{name:"labelsCrossReference",checkConditionsMetForRelatedLogs:()=>t,getDataSources:()=>gr(function*(){var r;const i=(0,h.kj)(e),o=a.jh.lookupVariable(f.Ao,i);if(!(0,Ze.BE)(o)||!o.state.filters.length)return t=!1,[];t=!0;const s=o.state.filters.map(({key:e,operator:t,value:r})=>({key:e,operator:t,value:r})),l=null===(r=e.state.$timeRange)||void 0===r?void 0:r.state.value,c=yield(0,mr.tS)().getHealthyDataSources("loki"),u=yield Promise.all(c.map(({uid:e,name:t})=>gr(function*(){const r=yield function(e,t,r){return gr(function*(){var a;const i=yield(0,n.getDataSourceSrv)().get(e),o=yield null===(a=i.getTagKeys)||void 0===a?void 0:a.call(i,{timeRange:r,filters:t.map(({key:e,operator:t,value:r})=>({key:yr(e),operator:t,value:r}))});if(!Array.isArray(o))return!1;const s=new Set(o.map(e=>e.text));return!!t.map(e=>yr(e.key)).every(e=>s.has(e))&&(yield Promise.all(t.map(e=>gr(function*(){var n;const a=yr(e.key),o=yield null===(n=i.getTagValues)||void 0===n?void 0:n.call(i,{key:a,timeRange:r,filters:t});return!!Array.isArray(o)&&o.some(t=>t.text===e.value)})()))).every(Boolean)})()}(e,s,l);return r?{uid:e,name:t}:null})()));return u.filter(e=>null!==e)})(),getLokiQueryExpr(){const t=(0,h.kj)(e),r=a.jh.lookupVariable(f.Ao,t);if(!(0,Ze.BE)(r)||!r.state.filters.length)return"";return`{${r.state.filters.map(e=>`${yr(e.key)}${e.operator}"${e.value}"`).join(",")}}`}}};var wr=r(6365);function Sr(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Or(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){Sr(i,n,a,o,s,"next",e)}function s(e){Sr(i,n,a,o,s,"throw",e)}o(void 0)})}}function kr(e,t,r){if(!t||!r[t])return"";const n=r[t].find(t=>t.name===e);if(!n)return"";return function(e){if(function(e){if(e.trim().length<=2)return!1;let t=!1;const r=wr.K3.parse(e);return r.iterate({enter:({type:e})=>{if(e.id===wr.Yw)return t=!0,!1}}),!t}(e))return e;const t=jr(e,wr.MD);if(!t)return"";const r=e.substring(t.from,t.to),n=jr(e,wr.AL),a=n?e.substring(n.from,n.to):"";return`${r} ${a}`.trim()}(n.query)}function Er(){return Or(function*(){const e=yield(0,mr.tS)().getHealthyDataSources("loki"),t={};return yield Promise.all(e.map(e=>Or(function*(){try{const a=function(e,t){if(0===e.length)return[];const r=new Map;return e.forEach(e=>{e.rules.filter(e=>"recording"===e.type).forEach(({type:e,name:n,query:a})=>{if(r.has(n)){const e=r.get(n);e&&(e.hasMultipleOccurrences=!0,r.set(n,e))}else r.set(n,{type:e,name:n,query:a,datasource:{name:t.name,uid:t.uid},hasMultipleOccurrences:!1})})}),Array.from(r.values())}(yield(r=e,Or(function*(){const e={url:`api/prometheus/${r.uid}/api/v1/rules`,showErrorAlert:!1,showSuccessAlert:!1},t=yield(0,u.lastValueFrom)((0,n.getBackendSrv)().fetch(e));return t.ok?t.data.data.groups:(d.v.warn(`Failed to fetch recording rules from Loki data source: ${r.name}`),[])})()),e);t[e.uid]=a}catch(e){d.v.warn(e)}var r})())),t})()}const xr=()=>{let e={},t=!1;return{name:"lokiRecordingRules",checkConditionsMetForRelatedLogs:()=>t,getDataSources:r=>Or(function*(){e=yield Er();const n=function(e,t){const r=[];return Object.values(t).forEach(t=>{t.filter(t=>t.name===e).forEach(e=>{r.push(e.datasource)})}),r}(r,e);return t=Boolean(n.length),n})(),getLokiQueryExpr:(t,r)=>kr(t,r,e)}};function jr(e,t){let r;return wr.K3.parse(e).iterate({enter:e=>{if(e.type.id===t)return r=e.node,!1}}),r}function Pr(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Cr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class _r{get lokiDataSources(){return this._internalState.lokiDataSources}set lokiDataSources(e){const t=this._internalState.lokiDataSources.map(e=>e.uid).join(","),r=e.map(e=>e.uid).join(",");t&&t===r||(this._internalState.lokiDataSources=e,this._changeHandlers.lokiDataSources.forEach(e=>e(this._internalState.lokiDataSources)))}set relatedLogsCount(e){this._internalState.relatedLogsCount=e,this._changeHandlers.relatedLogsCount.forEach(e=>e(this._internalState.relatedLogsCount))}addLokiDataSourcesChangeHandler(e){this._changeHandlers.lokiDataSources.push(e)}addRelatedLogsCountChangeHandler(e){this._changeHandlers.relatedLogsCount.push(e)}handleFiltersChange(){this.lokiDataSources&&(this.lokiDataSources=[],this.relatedLogsCount=0,this.findAndCheckAllDatasources())}findAndCheckAllDatasources(){return(e=function*(){const e=yield this._dataSourceFetcher.getHealthyDataSources("loki");e.length>0?this.checkLogsInDataSources(e):(this.lokiDataSources=[],this.relatedLogsCount=0)},function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){Pr(i,n,a,o,s,"next",e)}function s(e){Pr(i,n,a,o,s,"throw",e)}o(void 0)})}).call(this);var e}getLokiQueries(e,t=100){const{metric:r}=this._metricScene.state,n=this._logsConnectors.reduce((t,n,a)=>{const i=n.getLokiQueryExpr(r,e);var o;i&&(t[null!==(o=n.name)&&void 0!==o?o:`connector-${a}`]=i);return t},{});return Object.keys(n).map(e=>({refId:`RelatedLogs-${e}`,expr:n[e],maxLines:t,supportingQueryType:m.id}))}checkLogsInDataSources(e){const t=[];let r=0,n=0;if(0===e.length)return this.lokiDataSources=[],void(this.relatedLogsCount=0);e.forEach(i=>{const o=new a.dt({datasource:{uid:i.uid},queries:[],key:`related_logs_check_${i.uid}`});o.setState({queries:this.getLokiQueries(i.uid)}),o.subscribeToState(a=>{var o;if((null===(o=a.data)||void 0===o?void 0:o.state)===H.LoadingState.Done){var s;if(n++,null===(s=a.data)||void 0===s?void 0:s.series){const e=this.countLogsLines(a);e>0&&(t.push(i),r+=e)}n===e.length&&(this.lokiDataSources=t,this.relatedLogsCount=r)}}),o.activate()})}checkConditionsMetForRelatedLogs(){return this._logsConnectors.some(e=>e.checkConditionsMetForRelatedLogs())}countLogsLines(e){var t,r;return null!==(r=null===(t=e.data)||void 0===t?void 0:t.series.reduce((e,t)=>e+t.length,0))&&void 0!==r?r:0}constructor(e){Cr(this,"_logsConnectors",void 0),Cr(this,"_metricScene",void 0),Cr(this,"_dataSourceFetcher",(0,mr.tS)()),Cr(this,"_changeHandlers",{lokiDataSources:[],relatedLogsCount:[]}),Cr(this,"_internalState",{relatedLogsCount:0,lokiDataSources:[]}),this._metricScene=e,this._logsConnectors=[xr(),vr(e)]}}function Nr(){const e=(0,l.useStyles2)(Lr);return o().createElement(l.Stack,{direction:"column",gap:2},o().createElement(l.Alert,{title:"No related logs found",severity:"info"},"We couldn't find any logs related to the current metric with your selected filters."),o().createElement(l.Text,null,"To find related logs, try the following:",o().createElement("ul",{className:e.list},o().createElement("li",null,"Adjust your label filters to include labels that exist in both the current metric and your logs"),o().createElement("li",null,"Select a metric created by a"," ",o().createElement(l.TextLink,{external:!0,href:"https://grafana.com/docs/loki/latest/alert/#recording-rules"},"Loki Recording Rule")),o().createElement("li",null,"Broaden the time range to include more data"))),o().createElement(l.Text,{variant:"bodySmall",color:"secondary"},"Note: Related logs is an experimental feature."))}function Lr(e){return{list:(0,s.css)({paddingLeft:e.spacing(2),marginTop:e.spacing(1)})}}function Br({context:e}){const t=(0,i.useMemo)(()=>e,[e]),{links:r,isLoading:a}=(0,n.usePluginLinks)({extensionPointId:"grafana-metricsdrilldown-app/open-in-logs-drilldown/v1",limitPerPlugin:1,context:t}),s=(0,i.useMemo)(()=>r.find(({pluginId:e})=>"grafana-lokiexplore-app"===e),[r]);if(a)return o().createElement(l.LinkButton,{variant:"secondary",size:"sm",disabled:!0},"Loading...");const c=void 0!==s;return o().createElement(l.LinkButton,{href:c?`${n.config.appSubUrl}${s.path}`:`${n.config.appSubUrl}/a/grafana-lokiexplore-app`,target:"_blank",tooltip:c?"Use the Logs Drilldown app to explore these logs":"Navigate to the Logs Drilldown app",variant:"secondary",size:"sm",onClick:()=>(0,R.z)("related_logs_action_clicked",{action:"open_logs_drilldown"})},c?"Open in Logs Drilldown":"Open Logs Drilldown")}function Dr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ar(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const Tr="related_logs/logs_panel_container";class $r extends a.Bs{_onActivate(){this.state.orchestrator.addLokiDataSourcesChangeHandler(()=>this.setupLogsPanel()),this.state.orchestrator.lokiDataSources.length?this.setupLogsPanel():this.state.orchestrator.findAndCheckAllDatasources()}showNoLogsFound(){a.jh.findByKeyAndType(this,Tr,a.xK).setState({body:new a.dM({component:Nr})}),this.setState({controls:void 0}),this.state.orchestrator.relatedLogsCount=0}_buildQueryRunner(){this._queryRunner=new a.dt({datasource:{uid:f.Kf},queries:[],key:"related_logs/logs_query"}),this._constructLogsDrilldownLinkContext(this._queryRunner.state),this._subs.add(this._queryRunner.subscribeToState(e=>{var t;if((null===(t=e.data)||void 0===t?void 0:t.state)!==H.LoadingState.Done)return;0===this.state.orchestrator.countLogsLines(e)&&this.showNoLogsFound(),this._constructLogsDrilldownLinkContext(e)}))}setupLogsPanel(){if(this._buildQueryRunner(),!this.state.orchestrator.lokiDataSources.length)return void this.showNoLogsFound();a.jh.findByKeyAndType(this,Tr,a.xK).setState({body:a.d0.logs().setTitle("Logs").setData(this._queryRunner).build()});const e=new a.yP({name:f.Az,label:"Logs data source",query:this.state.orchestrator.lokiDataSources.map(e=>`${e.name} : ${e.uid}`).join(",")});this.setState({$variables:new a.Pj({variables:[e]}),controls:[new a.K8({layout:"vertical"})]}),this._subs.add(e.subscribeToState((e,t)=>{e.value!==t.value&&(0,R.z)("related_logs_action_clicked",{action:"logs_data_source_changed"})})),this.updateLokiQuery()}_constructLogsDrilldownLinkContext(e){var t,r;const n=null!==(r=null===(t=a.jh.lookupVariable(f.Az,this))||void 0===t?void 0:t.getValue())&&void 0!==r?r:"",i=e.queries,o=[];n&&i.length&&i.forEach(e=>{o.push(Ar(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Dr(e,t,r[t])})}return e}({},e),{datasource:{uid:n,type:"loki"}}))}),this.setState({logsDrilldownLinkContext:{targets:o,timeRange:a.jh.getTimeRange(this).state}})}updateLokiQuery(){if(!this._queryRunner)return;const e=a.jh.lookupVariable(f.Az,this);let t;if((0,Ze.UG)(e)&&(t=e.getValue()),!t)return;const r=this.state.orchestrator.getLokiQueries(t);0!==r.length?this._queryRunner.setState({queries:r}):this.showNoLogsFound()}constructor(e){super({controls:[],body:new a.gF({templateColumns:"1fr",autoRows:"minmax(300px, 1fr)",children:[new a.xK({key:Tr,body:void 0})]}),orchestrator:e.orchestrator,logsDrilldownLinkContext:{targets:[]}}),Dr(this,"_queryRunner",void 0),Dr(this,"_variableDependency",new a.Sh(this,{variableNames:[f.Az,f.Ao],onReferencedVariableValueChanged:e=>{e.state.name===f.Ao?this.state.orchestrator.handleFiltersChange():e.state.name===f.Az&&this.updateLokiQuery()}})),this.addActivationHandler(this._onActivate.bind(this))}}function Mr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Dr($r,"Component",({model:e})=>{const{controls:t,body:r,logsDrilldownLinkContext:n}=e.useState();return o().createElement(l.Stack,{gap:1,direction:"column",grow:1},o().createElement(l.Stack,{gap:1,direction:"row",justifyContent:"space-between",alignItems:"start"},o().createElement(l.Stack,{gap:1},null==t?void 0:t.map(e=>o().createElement(e.Component,{key:e.state.key,model:e}))),o().createElement(Br,{context:n})),o().createElement(r.Component,{model:r}))});class Vr extends a.Bs{_onActivate(){void 0===this.state.actionView&&this.setActionView(cr),this.relatedLogsOrchestrator.findAndCheckAllDatasources(),this.relatedLogsOrchestrator.addRelatedLogsCountChangeHandler(e=>{this.setState({relatedLogsCount:e})}),n.config.featureToggles.enableScopesInMetricsExplore&&this._subs.add(this.subscribeToEvent(f.H0,e=>{var t;null===(t=this.state.body.state.selectedTab)||void 0===t||t.publishEvent(e)}))}getUrlState(){return{actionView:this.state.actionView}}updateFromUrl(e){if("string"==typeof e.actionView){if(this.state.actionView!==e.actionView){const t=dr.find(t=>t.value===e.actionView);t&&this.setActionView(t.value)}}else null===e.actionView&&this.setActionView(null)}setActionView(e){const{body:t}=this.state,r=e?dr.find(t=>t.value===e):null;r&&r.value!==this.state.actionView?(t.state.topView.state.children[0].setState({maxHeight:280}),t.setState({selectedTab:r.getScene(this)}),this.setState({actionView:r.value})):(t.state.topView.state.children[0].setState({maxHeight:"40%"}),t.setState({selectedTab:void 0}),this.setState({actionView:void 0}))}createRelatedLogsScene(){return new $r({orchestrator:this.relatedLogsOrchestrator})}constructor(e){var t;const r=null!==(t=e.autoQuery)&&void 0!==t?t:Ke(e.metric,e.nativeHistogram);var n,i,o,s;super(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Mr(e,t,r[t])})}return e}({$variables:null!==(n=e.$variables)&&void 0!==n?n:(s=e.metric,new a.Pj({variables:[...(0,f.ym)(s),new a.fS({name:f.yr,label:"Group by",datasource:f.GH,includeAll:!0,defaultToAll:!0,query:{query:`label_names(${f.Rp})`,refId:"A"},value:"",text:""})]})),body:null!==(i=e.body)&&void 0!==i?i:new q({}),autoQuery:r,queryDef:null!==(o=e.queryDef)&&void 0!==o?o:r.main},e)),Mr(this,"relatedLogsOrchestrator",new _r(this)),Mr(this,"_urlSync",new a.So(this,{keys:["actionView"]})),Mr(this,"_variableDependency",new a.Sh(this,{variableNames:[f.Ao],onReferencedVariableValueChanged:()=>{this.relatedLogsOrchestrator.handleFiltersChange()}})),this.addActivationHandler(this._onActivate.bind(this))}}Mr(Vr,"Component",({model:e})=>{const{body:t}=e.useState();return o().createElement("div",{"data-testid":"metric-scene"},o().createElement(t.Component,{model:t}))})},9585:(e,t,r)=>{r.d(t,{V:()=>o,h:()=>i});var n=r(5568),a=r(1464);const i="filtered-metrics-wingman";class o extends n.s{constructor(){return super({key:i,name:i,label:"Filtered Metrics"}),(0,a.I)(this)}}}}]);
//# sourceMappingURL=384.js.map?_cache=38e018fbe67b91a8491e